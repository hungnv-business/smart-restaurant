name: Docker Build & Test

on:
  push:
    branches: [ main, develop ]
    paths:
      # Ch·ªâ ch·∫°y khi c√≥ thay ƒë·ªïi li√™n quan ƒë·∫øn Docker build
      - 'infrastructure/docker/**'
      - 'aspnet-core/src/**'           # Source code
      - '!aspnet-core/test/**'         # Lo·∫°i tr·ª´ test projects
      - 'aspnet-core/global.json'
      - 'aspnet-core/*.sln'
      - 'aspnet-core/common.props'
      - 'angular/src/**'               # Bao g·ªìm c·∫£ .spec.ts files
      - '!angular/src/**/*.spec.ts'    # Lo·∫°i tr·ª´ test files
      - '!angular/e2e/**'              # Lo·∫°i tr·ª´ e2e tests
      - 'angular/package.json'
      - 'angular/package-lock.json'
      - 'angular/yarn.lock'
      - 'angular/angular.json'
      - 'angular/tsconfig*.json'
      - 'Dockerfile*'
      - '.dockerignore'
  pull_request:
    branches: [ main ]
    paths:
      - 'infrastructure/docker/**'
      - 'aspnet-core/src/**'
      - '!aspnet-core/test/**'         # Lo·∫°i tr·ª´ test projects
      - 'angular/src/**'
      - '!angular/src/**/*.spec.ts'    # Lo·∫°i tr·ª´ test files
      - '!angular/e2e/**'              # Lo·∫°i tr·ª´ e2e tests
      - 'Dockerfile*'
  workflow_dispatch:
    # Cho ph√©p ch·∫°y manual
  schedule:
    # Ch·∫°y weekly build ƒë·ªÉ test
    - cron: '0 4 * * 1'  # Mondays 4:00 AM UTC

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  docker-build-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build API Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./infrastructure/docker/Dockerfile.api
        target: production
        push: false
        tags: smartrestaurant-api:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

    - name: Build Web Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./infrastructure/docker/Dockerfile.web
        target: production
        push: false
        tags: smartrestaurant-web:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

    - name: Test Docker Compose configurations
      run: |
        echo "üß™ Testing Docker Compose configurations..."
        cd infrastructure/docker
        
        # Test development configuration
        docker compose -f docker-compose.dev.yml config
        echo "‚úÖ Development configuration valid"
        
        # Test production configuration
        docker compose -f docker-compose.prod.yml config
        echo "‚úÖ Production configuration valid"

    - name: Test container startup
      run: |
        echo "üöÄ Testing container startup..."
        
        # Start containers
        cd infrastructure/docker
        docker compose -f docker-compose.dev.yml up -d postgres
        
        # Wait for postgres health check to pass
        echo "‚è≥ Waiting for PostgreSQL health check..."
        timeout 60 bash -c 'until docker compose -f docker-compose.dev.yml ps postgres | grep -q "healthy"; do sleep 2; done'
        
        echo "‚úÖ PostgreSQL container started successfully"
        
        # Cleanup
        docker compose -f docker-compose.dev.yml down

  # Security scan for Docker images
  docker-security:
    runs-on: ubuntu-latest
    needs: [docker-build-test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build API image for scanning
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./infrastructure/docker/Dockerfile.api
        target: production
        push: false
        tags: smartrestaurant-api:scan
        load: true

    - name: Run Trivy scan on API image
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: 'smartrestaurant-api:scan'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        ignore-unfixed: true

    - name: Build Web image for scanning
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./infrastructure/docker/Dockerfile.web
        target: production
        push: false
        tags: smartrestaurant-web:scan
        load: true

    - name: Run Trivy scan on Web image
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: 'smartrestaurant-web:scan'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        ignore-unfixed: true