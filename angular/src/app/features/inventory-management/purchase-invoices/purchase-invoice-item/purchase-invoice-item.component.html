<p-fluid>
  <div class="flex mt-4">
    <div class="card flex flex-col gap-3 w-full">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-1">
          <span class="bg-primary-500 text-white px-1.5 py-0.5 rounded-full text-xs font-bold">
            {{ index + 1 }}
          </span>
          <span class="font-semibold text-xl">Mặt hàng</span>
        </div>
        @if (!isViewOnly) {
          <p-button
            type="button"
            icon="pi pi-times"
            severity="danger"
            [rounded]="true"
            [outlined]="true"
            size="small"
            (onClick)="onRemove()"
            pTooltip="Xóa"
          />
        }
      </div>

      <div [formGroup]="itemForm" class="flex flex-col gap-3">
        <!-- Category và Ingredient -->
        <div class="flex flex-row gap-4">
          <div class="flex flex-col gap-1 w-full">
            <label for="category" class="block font-semibold text-sm">Loại nguyên liệu</label>
            <p-select
              [options]="categories"
              optionLabel="displayName"
              optionValue="id"
              placeholder="Chọn..."
              [showClear]="!isViewOnly"
              formControlName="categoryId"
              (onChange)="onCategoryChange($event.value)"
              class="w-full"
              [readonly]="isViewOnly"
            />
          </div>
          <div class="flex flex-col gap-1 w-full">
            <label for="ingredient" class="block font-semibold text-sm required">Nguyên liệu</label>
            <p-select
              formControlName="ingredientId"
              [options]="ingredients"
              optionLabel="displayName"
              optionValue="id"
              placeholder="Chọn..."
              [showClear]="!isViewOnly"
              (onChange)="onIngredientChange($event.value)"
              [readonly]="isViewOnly"
              [class.p-invalid]="isFieldInvalid(itemForm, 'ingredientId')"
            />
            <app-validation-error
              [control]="getFormControl(itemForm, 'ingredientId')"
              fieldName="Nguyên liệu"
            />
          </div>
        </div>

        <!-- Số lượng và Đơn vị -->
        <div class="flex flex-row gap-4">
          <div class="flex flex-col gap-1 w-full">
            <label for="quantity" class="block font-semibold text-sm required">Số lượng</label>
            <p-inputnumber
              formControlName="quantity"
              [min]="1"
              [step]="1"
              placeholder="0"
              class="w-full"
              (onInput)="onCalculateTotal()"
              [readonly]="isViewOnly"
              [class.p-invalid]="isFieldInvalid(itemForm, 'quantity')"
            />
            <app-validation-error [control]="getFormControl(itemForm, 'quantity')" fieldName="Số lượng" />
          </div>
          <div class="flex flex-col gap-1 w-full">
            <label for="purchaseUnit" class="block font-semibold text-sm required">Đơn vị mua</label>
            <p-select
              id="purchaseUnit"
              formControlName="purchaseUnitId"
              [options]="purchaseUnits"
              optionLabel="unitName"
              optionValue="id"
              placeholder="Chọn đơn vị mua..."
              [showClear]="!isViewOnly"
              [disabled]="!currentIngredientId || purchaseUnits.length === 0"
              (onChange)="onPurchaseUnitChange($event.value)"
              class="w-full"
              [readonly]="isViewOnly"
              [class.p-invalid]="isFieldInvalid(itemForm, 'purchaseUnitId')"
            >
              <ng-template let-unit pTemplate="item">
                <div class="flex flex-col">
                  <span class="font-medium">{{ unit.unitName }}</span>
                  <small class="text-gray-500" *ngIf="!unit.isBaseUnit">
                    1 {{ unit.unitName }} = {{ unit.conversionRatio | number }} {{ getBaseUnitName() }}
                  </small>
                  <small class="text-blue-600" *ngIf="unit.isBaseUnit">
                    Đơn vị cơ sở
                  </small>
                </div>
              </ng-template>
              <ng-template let-unit pTemplate="selectedItem">
                <span class="font-medium">{{ unit.unitName }}</span>
                <span class="text-xs text-gray-500 ml-2" *ngIf="!unit.isBaseUnit">
                  (1 = {{ unit.conversionRatio | number }} {{ getBaseUnitName() }})
                </span>
              </ng-template>
            </p-select>
            <app-validation-error [control]="getFormControl(itemForm, 'purchaseUnitId')" fieldName="Đơn vị mua" />
          </div>
        </div>

        <!-- Conversion Preview -->
        @if (currentIngredientId && itemForm.get('purchaseUnitId')?.value && itemForm.get('quantity')?.value) {
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
          <div class="flex items-center gap-2">
            <i class="pi pi-calculator text-blue-600"></i>
            <span class="text-sm font-medium text-blue-800">Quy đổi tự động:</span>
            <span class="text-sm text-blue-900">
              {{ itemForm.get('quantity')?.value | number }} {{ getPurchaseUnitName() }} 
              = {{ getConvertedBaseQuantity() | number }} {{ getBaseUnitName() }}
            </span>
          </div>
        </div>
        }

        <!-- Đơn giá và Thành tiền -->
        <div class="flex flex-row gap-4">
          <div class="flex flex-col gap-1 w-full">
            <label for="unitPrice" class="block font-semibold text-sm">Đơn giá</label>
            <p-inputnumber
              formControlName="unitPrice"
              mode="currency"
              currency="VND"
              locale="vi-VN"
              [min]="0"
              [minFractionDigits]="0"
              [maxFractionDigits]="0"
              class="w-full"
              (onInput)="onCalculateTotal()"
              [readonly]="isViewOnly"
            />
            <app-validation-error [control]="itemForm.get('unitPrice')" fieldName="Đơn giá" />
          </div>
          <div class="flex flex-col gap-1 w-full">
            <label for="totalPrice" class="block font-semibold text-sm required">Thành tiền</label>
            <p-inputnumber
              formControlName="totalPrice"
              mode="currency"
              currency="VND"
              locale="vi-VN"
              [min]="0"
              [minFractionDigits]="0"
              [maxFractionDigits]="0"
              class="w-full"
              [readonly]="isViewOnly"
              [class.p-invalid]="itemForm.get('totalPrice')?.invalid && itemForm.get('totalPrice')?.touched"
            />
            <app-validation-error [control]="itemForm.get('totalPrice')" fieldName="Thành tiền" />
          </div>
        </div>

        <!-- Nhà cung cấp và Ghi chú -->
        <div class="flex flex-row gap-4">
          <div class="flex flex-col gap-1 w-full">
            <label for="supplier" class="block font-semibold text-sm">Nhà cung cấp</label>
            <input
              pInputText
              id="supplier"
              type="text"
              formControlName="supplierInfo"
              placeholder="Thông tin nhà cung cấp..."
              [readonly]="isViewOnly"
            />
          </div>
          <div class="flex flex-col gap-1 w-full">
            <label for="notes" class="block font-semibold text-sm">Ghi chú</label>
            <input
              type="text"
              pInputText
              id="notes"
              formControlName="notes"
              placeholder="Ghi chú cho mặt hàng này..."
              [readonly]="isViewOnly"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</p-fluid>
