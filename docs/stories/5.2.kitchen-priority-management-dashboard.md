# User Story 5.2: Kitchen Priority Management Dashboard

**Epic**: Epic 5 - Order Processing & Kitchen Coordination  
**Story Points**: 35-50 (Level 2 - Business Logic Template)  
**Priority**: High  
**Status**: Approved
**Assignee**: Development Team  
**Sprint**: TBD

## Template Metadata

### Template Level
**Selected Level**: Level 2 (Business Logic Template)

### Complexity Analysis
- **Entity Complexity**: Business Logic - Kitchen dashboard with simple priority logic, sorting by time and dish type
- **UI Complexity**: Workflow - Display order list with status and kitchen station filtering
- **Technical Requirements**: Business Logic - Custom application services with simple priority calculation logic

### Estimated Story Points
**Range**: 35-50 points based on Level 2 template complexity

### Template References
- **Backend Template**: templates/backend-template-level2.md
- **Frontend Template**: templates/frontend-template-level2.md  
- **Task Template**: .bmad-core/templates/level2-tasks.yaml

## Story Dependencies

**Prerequisites**:
- ‚úÖ **Story 5.1 - Waitstaff Order Management Workflow**: REQUIRED - Order entities, OrderStatus workflow, and SignalR hubs must be functional
- ‚ö†Ô∏è **MenuItem Data with Boolean Fields**: DEPENDENCY UNCONFIRMED - MenuItem entity needs 2 boolean fields: IsQuickCook and RequiresCooking (Task BE-0 will add these fields if not present from Story 5.1)

**Future Integration Points**:
- üîÑ **Epic 8 - Payment Processing**: Future integration for order completion workflow
- üîÑ **Epic 9 - Reporting Analytics**: Performance metrics and kitchen efficiency reports

## Story Description

**As a** kitchen staff,  
**I want** to see tables with dishes that require cooking (RequiresCooking=true) that are unserved, prioritized by order time and cooking speed,  
**so that** I can focus on cooking dishes that need preparation, skip pre-made items, and optimize cooking sequence according to priority.

## Acceptance Criteria

1. **Table-based Order Display**: Display table-based orders for dishes with RequiresCooking=true that are unserved, sorted by order time

2. **Quick-cook Dish Indicators**: Mark quick-cook dishes (vegetables, tofu, light dishes) with visual priority indicators

3. **Cooking Time Estimates**: Cooking time estimates for each dish with color-coded urgency levels

4. **Smart Preparation Suggestions**: Smart preparation suggestions balancing FIFO order priority with quick-serve opportunities

5. **Real-time Updates**: Real-time updates when dishes are completed and served to tables

6. **Empty Table Priority**: Tables with no served dishes or only one dish get priority boost to prevent customers waiting without food

7. **Advanced Sorting**: Multi-level priority algorithm in order: quick-cook dishes ‚Üí empty tables ‚Üí first-come tables

## Tasks / Subtasks

### Backend Tasks (Level 2 - Business Logic)

- [ ] **BE-0**: Update MenuItem Entity with Boolean Fields (AC: 2, 4, 6, 7)
  - [ ] Add IsQuickCook (bool) property to MenuItem entity
  - [ ] Add RequiresCooking (bool) property to MenuItem entity  
  - [ ] Create migration for 2 new fields
  - [ ] Update seed data sample for dishes with appropriate boolean values
  - [ ] Run migration to update database schema

- [ ] **BE-1**: Create Domain Services for Kitchen Priority Logic (AC: 1, 4, 6, 7)
  - [ ] Create KitchenPriorityService with filtering and priority calculation logic
  - [ ] Implement logic to filter and display only RequiresCooking=true dishes
  - [ ] Implement multi-level sorting algorithm for dishes requiring cooking:
    - Level 1: Quick-cook dishes (IsQuickCook=true) in cooking list
    - Level 2: Empty tables come first  
    - Level 3: First-come tables (FIFO by OrderTime)
  - [ ] Create CalculateCookingPriorityScore() method for OrderItem with RequiresCooking=true
  - [ ] Implement logic to count served dishes per table
  - [ ] Create GetCookingOrderItemsSequence() method returning only sorted cooking dishes

- [ ] **BE-2**: Implement Application Services for Kitchen Dashboard (AC: 1, 2, 3, 5, 7)
  - [ ] Create KitchenDashboardAppService with methods for cooking dishes
  - [ ] Add GetCookingOrdersAsync() - get list of RequiresCooking=true dishes sorted
  - [ ] Add UpdateOrderItemStatusAsync() - update cooking dish status
  - [ ] Add GetCookingOrdersByStationAsync() - filter cooking dishes by kitchen station with priority sorting
  - [ ] Create GetCookingPriorityOrdersAsync() - apply multi-level sorting algorithm only for cooking dishes

- [ ] **BE-3**: Setup Basic SignalR Hub (AC: 5)
  - [ ] Create KitchenHub for real-time notifications
  - [ ] Add NotifyOrderStatusChanged() method 
  - [ ] Add NotifyNewOrderReceived() method
  - [ ] Configure authorization for kitchen staff
  - [ ] Setup connection groups by kitchen station

### Frontend Tasks (Level 2 - Workflow)

- [ ] **FE-1**: Create Basic Components for Kitchen Dashboard (AC: 1, 2, 3)
  - [ ] Create KitchenDashboardComponent displaying order list
  - [ ] Create OrderItemCard with dish information and status
  - [ ] Add color indicators for quick-cook dishes (green badge)
  - [ ] Add priority indicators for empty tables (red badge)
  - [ ] Create filter dropdown for kitchen stations

- [ ] **FE-2**: Implement Simple SignalR Client (AC: 5)
  - [ ] Setup SignalR connection service
  - [ ] Listen to order status update events
  - [ ] Update UI when new orders arrive
  - [ ] Display notifications when dishes are completed
  - [ ] Handle basic connection errors

- [ ] **FE-3**: Status Update Features (AC: 5)
  - [ ] Add "Start Cooking", "Complete" buttons for each dish
  - [ ] Create confirmation modal for status changes
  - [ ] Update colors and status real-time
  - [ ] Display estimated completion time
  - [ ] Add notes for each dish if needed

### Testing Tasks (Level 2 - Basic Testing)

- [ ] **TEST-1**: Unit Tests for Business Logic (AC: All)
  - [ ] Test KitchenPriorityService - multi-level sorting algorithm
  - [ ] Test CalculateAdvancedPriorityScore() with multiple scenarios
  - [ ] Test sorting: quick-cook ‚Üí empty tables ‚Üí first-come tables
  - [ ] Test KitchenDashboardAppService methods with sorted data
  - [ ] Test cases for edge cases: tables with same time, same dish type

- [ ] **TEST-2**: Component Tests for Frontend (AC: 1, 2, 3, 5)
  - [ ] Test KitchenDashboardComponent displays correctly
  - [ ] Test OrderItemCard with different statuses
  - [ ] Test kitchen station filtering works
  - [ ] Test dish status updates
  - [ ] Test SignalR connection service

## Testing

### Test Strategy
**Level 2 Testing Approach**: Focus on business logic validation and basic UI functionality testing

**Test Coverage Requirements**: ‚â•80% for Domain Services, ‚â•70% for Application Services, ‚â•60% for Components

### Unit Testing Framework
- **Backend**: xUnit with ABP Test Framework, Shouldly assertions
- **Frontend**: Angular TestBed with Jasmine/Karma
- **Mocking**: NSubstitute for .NET services, Angular testing utilities for components

### Integration Testing
- **SignalR Hub Testing**: Mock connections for real-time feature validation
- **Database Integration**: In-memory database for repository testing
- **API Integration**: ABP Test framework for application service testing

### Test Data Management
- **Seed Data**: Test-specific MenuItem entities with known IsQuickCook/RequiresCooking values
- **Test Scenarios**: Pre-defined order combinations for priority algorithm testing
- **Mock Data**: Kitchen station configurations and table setups

### Performance Testing Considerations
- **Load Testing**: Simulate multiple kitchen displays connected simultaneously
- **Priority Calculation Performance**: Test sorting algorithm with large order datasets (500+ items)
- **SignalR Connection Handling**: Test reconnection scenarios and message queuing

## Dev Notes

### Template-Specific Guidance (Level 2 - Business Logic)

**Implementation Patterns for Kitchen Dashboard:**
- Use ABP Application Services with simple Domain Services for priority logic
- Implement business logic for priority calculation: FIFO + quick-cook + empty table
- Use basic SignalR Hub for real-time notifications
- Entity Framework Core with simple queries for order lists
- Angular components with PrimeNG for list display

**Required Dependencies for Kitchen System:**
- ABP Framework 8.0 with authorization and localization support
- SignalR for basic real-time notifications
- Entity Framework Core for data querying
- Angular 19 with PrimeNG components
- **@microsoft/signalr**: ^8.0.0 for client-side real-time communication

**Basic Configuration for Kitchen System:**
```bash
# Basic Backend Configuration
DEFAULT_CONNECTION_STRING=Host=localhost;Database=SmartRestaurant;Username=postgres;Password=postgres

# Simple SignalR Configuration
SIGNALR_CORS_ORIGINS=http://localhost:4200
SIGNALR_HUB_TIMEOUT=30000

# Angular Dashboard Configuration
API_BASE_URL=https://localhost:44346
WEBSOCKET_URL=wss://localhost:44346/hubs/kitchen
```

**File Structure and Naming Conventions for Kitchen System:**
```
Backend Kitchen Architecture:
- aspnet-core/src/SmartRestaurant.Domain/Kitchen/ (kitchen domain entities and services)
- aspnet-core/src/SmartRestaurant.Application/Kitchen/ (kitchen application services and DTOs)
- aspnet-core/src/SmartRestaurant.HttpApi.Host/Hubs/KitchenPriorityHub.cs (real-time kitchen communication)

Frontend Kitchen Dashboard:  
- angular/src/app/restaurant-features/kitchen-management/ (kitchen dashboard feature module)
- angular/src/app/restaurant-features/kitchen-management/components/ (kitchen UI components)
- angular/src/app/restaurant-features/kitchen-management/services/ (kitchen API client services)
- angular/src/app/shared/models/kitchen/ (kitchen data models)
```

### Previous Story Context from Story 5.1
From Story 5.1 completion - Order management system created foundation for:
- Order entities with OrderStatus workflow (Pending, Confirmed, Preparing, Ready, Served, Paid)
- SignalR hubs for real-time communication (KitchenHub, OrderStatusHub, TableManagementHub)
- OrderManager domain service with business logic for order processing
- Real-time status tracking and notification system
- **OrderItem entities with MenuItem relationships ready for kitchen priority calculation**
- **MenuItem entity needs to add 2 boolean fields: IsQuickCook and RequiresCooking**

### Simple Data Model for Kitchen Dashboard

**Using Existing Entities from Story 5.1:**
- `Order` - order with OrderStatus  
- `OrderItem` - dish in order with quantity and notes
- `MenuItem` - dish information with 2 boolean fields: IsQuickCook, RequiresCooking
- `Table` - table information

**DTO for Kitchen Dashboard:**
```csharp
public class KitchenOrderItemDto
{
    public Guid OrderId { get; set; }               
    public Guid OrderItemId { get; set; }            
    public string TableNumber { get; set; }        
    public string MenuItemName { get; set; }       
    public int Quantity { get; set; }              
    public DateTime OrderTime { get; set; }        
    public bool IsQuickCook { get; set; }          // From MenuItem.IsQuickCook
    public bool RequiresCooking { get; set; }      // From MenuItem.RequiresCooking
    public bool IsEmptyTablePriority { get; set; } // Table has few dishes
    public int ServedDishesCount { get; set; }     // Number of dishes served to this table
    public int PriorityScore { get; set; }         // Total priority score (for sorting)
    public OrderItemStatus Status { get; set; }    
}
```

**KitchenPriorityService Domain Service** (Advanced Business Logic):
```csharp
public class KitchenPriorityService : DomainService
{
    // Calculate priority score for each OrderItem using multi-level algorithm
    Task<int> CalculateAdvancedPriorityScoreAsync(Guid orderItemId, Guid tableId, bool isQuickCook, bool requiresCooking, DateTime orderTime);
    
    // Get list sorted by priority score (high to low)
    Task<List<KitchenOrderItemDto>> GetPriorizedOrderItemsAsync();
    
    // Check if dish is quick-cook (from MenuItem.IsQuickCook)
    Task<bool> IsQuickCookItemAsync(Guid menuItemId);
    
    // Count served dishes per table
    Task<int> GetServedDishesCountAsync(Guid tableId);
    
    // Sort list by PriorityScore
    Task<List<KitchenOrderItemDto>> SortByAdvancedPriorityAsync(List<KitchenOrderItemDto> items);
}
```

**SignalR Integration for Real-time Kitchen Updates**:  
[Source: docs/architecture/core-workflows.md#Kitchen-Priority-Management-Workflow]
- KitchenPriorityHub broadcasts priority changes and cooking status updates
- Real-time connection management for multiple kitchen displays
- Kitchen station-specific groups for targeted notifications
- Automatic priority recalculation with domain events

### Advanced Business Logic for Kitchen Dashboard

**Multi-level Sorting Algorithm:**

**Level 0 - Filter Cooking Required (Mandatory Condition):**
- `MenuItem.RequiresCooking = true` ‚Üí Display on dashboard
- `MenuItem.RequiresCooking = false` ‚Üí Don't display (pre-made items)
- Purpose: Only show dishes that need preparation, skip pre-made items

**Level 1 - Quick-cook Dishes (Priority Score = 100):**
- `MenuItem.IsQuickCook = true` ‚Üí Score + 100  
- Purpose: Cook quick dishes first to increase overall service speed

**Level 2 - Empty Tables (Priority Score = 50):**
- Table with 0 served dishes ‚Üí Score + 50
- Table with 1 served dish ‚Üí Score + 25  
- Purpose: Prevent customers sitting without any food

**Level 3 - FIFO (Priority Score = time):**
- Calculate score based on time: (now - OrderTime) / 60 (minutes)
- Earlier orders get higher scores
- Purpose: Ensure fairness, first-come first-served

**Total Priority Score Formula:**
```
TotalScore = QuickCookScore + EmptyTableScore + TimeScore
(Only applied to dishes with RequiresCooking = true)
```

**Real Examples:**
- Dish A: Fried egg (RequiresCooking=true, IsQuickCook=true, 100 points) + Empty table (50) + 15 min wait (15) = **165 points**
- Dish B: Pho (RequiresCooking=true, IsQuickCook=false, 0 points) + Table has dishes (0) + 30 min wait (30) = **30 points**
- Dish C: Beer (RequiresCooking=false) = **Not displayed** (staff can get directly)
‚Üí Priority order on dashboard: Dish A ‚Üí Dish B

**Kitchen Dashboard Display:**
- OrderItem list sorted by priority
- Colors and badges for each priority type  
- Filter dropdown by kitchen station
- Status update buttons: "Start Cooking", "Complete"
- Real-time updates via SignalR when new orders arrive or status changes

### Simple API for Kitchen Dashboard

**KitchenDashboardAppService Endpoints:**
```csharp
// ABP auto-generates REST endpoints (Note: Exact paths follow ABP conventions and may be adjusted during implementation):
GET /api/app/kitchen-dashboard/cooking-orders               // Get cooking dishes list
GET /api/app/kitchen-dashboard/cooking-orders-by-station/{station}  // Filter cooking dishes by kitchen station  
PUT /api/app/kitchen-dashboard/order-item/{id}/status       // Update dish status
```

**KitchenDashboardAppService Methods:**
```csharp
public class KitchenDashboardAppService : ApplicationService
{
    // Get cooking dishes list sorted by priority algorithm
    Task<List<KitchenOrderItemDto>> GetCookingOrdersAsync();
    
    // Filter cooking dishes by kitchen station with priority sorting
    Task<List<KitchenOrderItemDto>> GetCookingOrdersByStationAsync(KitchenStation station);
    
    // Update dish status and recalculate priority for that table
    Task UpdateOrderItemStatusAsync(Guid orderItemId, OrderItemStatus status);
    
    // Get priority statistics for cooking dashboard
    Task<CookingStatsDto> GetCookingStatsAsync();
}

public class CookingStatsDto
{
    public int QuickCookItemsCount { get; set; }     // Number of quick-cook dishes needing preparation
    public int EmptyTablesCount { get; set; }        // Number of empty tables (in cooking dishes)
    public int TotalCookingItems { get; set; }       // Total dishes needing cooking
    public double AverageWaitingTime { get; set; }   // Average waiting time (minutes)
}
```

### Simple Angular Architecture

**Main Components:**
- `KitchenDashboardComponent` - display order list
- `OrderItemCardComponent` - display each dish with status and buttons
- `KitchenFilterComponent` - dropdown filter by kitchen station

**Services:**
- `KitchenDashboardService` - call API to get data
- `SignalRService` - real-time connection with backend

**Simple State Management:**
```typescript
interface KitchenDashboardState {
  cookingItems: KitchenOrderItemDto[];    // List of dishes needing cooking (RequiresCooking=true)
  selectedStation: KitchenStation | null; // Currently filtered station
  isLoading: boolean;                     // Loading data
  isConnected: boolean;                   // SignalR status
}
```

**Basic SignalR Integration:**
- Connect to KitchenHub  
- Listen to status update events
- Reload list when changes occur

### Security and Localization Requirements

**Required Permissions:**
```csharp
[Authorize(SmartRestaurantPermissions.Kitchen.View)]         // View kitchen dashboard
[Authorize(SmartRestaurantPermissions.Kitchen.UpdateStatus)] // Update dish status
```

**Vietnamese Localization:**
- All display text in Vietnamese
- Kitchen station names: General, Hotpot, Grilled, Beverages  
- Dish statuses: Waiting, Cooking, Complete, Served
- Error messages and confirmations in Vietnamese

## Dev Agent Record

### Agent Model
**Implementation Agent**: TBD (To be assigned during sprint planning)
**Agent Capabilities Required**: 
- ABP Framework 8.0 expertise with Domain Services and Application Services
- Angular 19 development with PrimeNG components
- SignalR real-time communication implementation
- Entity Framework Core migrations and data modeling
- Business logic algorithm implementation (multi-level sorting)

### Debug Log References
**Debug Log Location**: `.ai/debug-log.md` (To be populated during implementation)
**Key Debug Sections**:
- MenuItem entity migration issues and boolean field additions
- KitchenPriorityService algorithm testing and edge case handling
- SignalR connection management and kitchen station group setup
- Angular component state management and real-time updates

### Completion Notes
**Implementation Status**: Not Started
**Completion Criteria**:
- [ ] All 7 Acceptance Criteria validated and tested
- [ ] MenuItem entity successfully updated with IsQuickCook/RequiresCooking fields
- [ ] Multi-level priority algorithm working correctly with test data
- [ ] Kitchen dashboard displays only RequiresCooking=true dishes
- [ ] Real-time updates functioning across multiple kitchen displays
- [ ] All test cases passing with ‚â•80% domain service coverage

### File List
**Files to be Created/Modified**:
```
Backend Files (COMPLETED):
- aspnet-core/src/SmartRestaurant.Domain/MenuManagement/MenuItems/MenuItem.cs (UPDATED - added IsQuickCook, RequiresCooking boolean fields)
- aspnet-core/src/SmartRestaurant.Domain/MenuManagement/MenuItems/MenuItemManager.cs (UPDATED - added new fields to CreateAsync/UpdateAsync methods)
- aspnet-core/src/SmartRestaurant.Application.Contracts/MenuManagement/MenuItems/Dto/CreateUpdateMenuItemDto.cs (UPDATED - added boolean fields)
- aspnet-core/src/SmartRestaurant.Application.Contracts/MenuManagement/MenuItems/Dto/MenuItemDto.cs (UPDATED - added boolean fields)
- aspnet-core/src/SmartRestaurant.Application/MenuManagement/MenuItems/MenuItemAppService.cs (UPDATED - pass new fields to manager)
- aspnet-core/src/SmartRestaurant.Domain/Kitchen/KitchenPriorityService.cs (CREATED - domain service for priority logic)
- aspnet-core/src/SmartRestaurant.Application.Contracts/Kitchen/Dtos/KitchenOrderItemDto.cs (CREATED)
- aspnet-core/src/SmartRestaurant.Application.Contracts/Kitchen/Dtos/CookingStatsDto.cs (CREATED)
- aspnet-core/src/SmartRestaurant.Application.Contracts/Kitchen/Dtos/UpdateOrderItemStatusInput.cs (CREATED)
- aspnet-core/src/SmartRestaurant.Application/Kitchen/KitchenDashboardAppService.cs (CREATED)
- aspnet-core/src/SmartRestaurant.Application/Kitchen/KitchenAutoMapperProfile.cs (CREATED)
- aspnet-core/src/SmartRestaurant.Application.Contracts/Permissions/SmartRestaurantPermissions.cs (UPDATED - added Kitchen.View permission)
- aspnet-core/src/SmartRestaurant.Domain/Orders/IOrderRepository.cs (UPDATED - added GetByOrderItemIdAsync method)
- aspnet-core/src/SmartRestaurant.HttpApi.Host/Hubs/KitchenPriorityHub.cs (CREATED)
- aspnet-core/src/SmartRestaurant.EntityFrameworkCore/Migrations/20250915160324_AddMenuItemCookingFields.cs (CREATED)

Frontend Files:
- angular/src/app/restaurant-features/kitchen-management/kitchen-management.module.ts (CREATE)
- angular/src/app/restaurant-features/kitchen-management/components/kitchen-dashboard/kitchen-dashboard.component.ts (CREATE)
- angular/src/app/restaurant-features/kitchen-management/components/kitchen-dashboard/kitchen-dashboard.component.html (CREATE)
- angular/src/app/restaurant-features/kitchen-management/components/order-item-card/order-item-card.component.ts (CREATE)
- angular/src/app/restaurant-features/kitchen-management/services/kitchen-dashboard.service.ts (CREATE)
- angular/src/app/shared/services/signalr.service.ts (UPDATE - add kitchen hub methods)

Test Files:
- test/SmartRestaurant.Domain.Tests/Kitchen/KitchenPriorityService_Tests.cs (CREATE)
- test/SmartRestaurant.Application.Tests/Kitchen/KitchenDashboardAppService_Tests.cs (CREATE)
- angular/src/app/restaurant-features/kitchen-management/components/kitchen-dashboard/kitchen-dashboard.component.spec.ts (CREATE)
```

## QA Results

### QA Status
**QA Agent**: TBD (To be assigned during testing phase)
**QA Execution Status**: Pending Implementation Completion

### Test Execution Results
**Unit Tests**: Not yet executed (0/0 passing)
**Integration Tests**: Not yet executed (0/0 passing)
**Component Tests**: Not yet executed (0/0 passing)
**E2E Tests**: Not yet executed (0/0 passing)

### Known Issues
**Blocker Issues**: None identified in draft phase
**Critical Issues**: 
- Dependency on MenuItem entity updates needs verification from Story 5.1
**Minor Issues**: 
- API endpoint naming may need adjustment during implementation based on ABP conventions

### Test Coverage Reports
**Backend Coverage**: TBD (Target: ‚â•80% Domain Services, ‚â•70% Application Services)
**Frontend Coverage**: TBD (Target: ‚â•60% Components)

### Performance Test Results
**Load Test Results**: TBD (Target: Support 10+ concurrent kitchen displays)
**Priority Algorithm Performance**: TBD (Target: <100ms for 500+ order items)
**SignalR Connection Performance**: TBD (Target: <2s reconnection time)

### QA Sign-off
**Functional Testing**: ‚è≥ Pending
**Performance Testing**: ‚è≥ Pending
**Security Testing**: ‚è≥ Pending
**Accessibility Testing**: ‚è≥ Pending
**Final QA Approval**: ‚è≥ Pending

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation with Level 3 template for Kitchen Priority Management Dashboard | Bob (Scrum Master) |
| 2025-01-15 | 1.1 | Added Empty Table Priority (AC 6) - Tables with 0-1 served dishes get priority boost to prevent customers waiting without food | Bob (Scrum Master) |
| 2025-01-15 | 2.0 | Simplified to Level 2 Template - focus on business logic, removed Redis/GraphQL/complex cache | Bob (Scrum Master) |
| 2025-01-15 | 2.1 | Added Advanced Sorting Algorithm (AC 7) - Multi-level sorting: quick-cook ‚Üí empty tables ‚Üí first-come with PriorityScore | Bob (Scrum Master) |
| 2025-01-15 | 2.2 | Updated with RequiresCooking logic - dashboard only shows dishes that require cooking, filtering out pre-made items | Sarah (Product Owner) |
| 2025-01-15 | 2.3 | Fixed validation issues: Added Testing section, Dev Agent Record, QA Results sections. Clarified MenuItem dependency status and API endpoint assumptions | Sarah (Product Owner) |