# Story 2.2: Table Positioning within Layout Sections

## Status
Approved

## Story
**As a** restaurant staff,  
**I want** to position tables within layout sections using drag-and-drop functionality,  
**so that** I can arrange tables efficiently and update their positions as needed.

## Acceptance Criteria
1. Each layout section displays as a column with tables listed vertically
2. Tables can be drag-dropped within the same section to reorder
3. Tables can be drag-dropped between different sections
4. Table status management and visual feedback during drag operations

## Tasks / Subtasks

- [ ] Backend Table Entity Enhancement and Section Management (AC: 1)
  - [ ] Extend Table entity to include LayoutSectionId foreign key relationship and DisplayOrder property
  - [ ] Create Entity Framework Core migration for Table section assignment and display ordering
  - [ ] Enhance ITableAppService with section assignment and display order operations
  - [ ] Implement TableAppService section assignment and display order logic with validation and persistence
  - [ ] Add authorization permissions for table section management and display order editing

- [ ] Frontend Kanban-Style Layout with Drag-Drop (AC: 1, 2, 3, 4)
  - [ ] Create table-layout-kanban component under angular/src/app/features/table-management/
  - [ ] Implement column-based layout where each LayoutSection is a vertical column
  - [ ] Use @angular/cdk/drag-drop for dragging tables within same section (reordering)
  - [ ] Use @angular/cdk/drag-drop for dragging tables between different sections
  - [ ] Add section headers showing section name and table count
  - [ ] Add table cards with status indicators (Available/Occupied/Reserved/Cleaning) with localized text
  - [ ] Implement visual drop zones and drag feedback using PrimeNG styling

- [ ] Drag-Drop Position Management (AC: 2, 3)
  - [ ] Implement DisplayOrder updates when tables are reordered within same section
  - [ ] Handle section assignment when tables are moved between sections
  - [ ] Add optimistic UI updates with server-side position persistence
  - [ ] Implement drag operation validation (prevent drops on invalid targets)
  - [ ] Add confirmation for moving occupied tables between sections

- [ ] Localization Integration and UI Updates (AC: 3, 4)
  - [ ] Add localized tooltips and labels for table section assignment
  - [ ] Implement real-time table status updates using existing ComponentBase pattern
  - [ ] Add confirmation dialogs for table section changes
  - [ ] Create localized table status tooltips and contextual help
  - [ ] Implement optimistic UI updates with error rollback for failed section assignments

- [ ] Testing Implementation
  - [ ] Create unit tests for enhanced TableAppService using xUnit and ABP test infrastructure
  - [ ] Implement frontend component tests for table-layout-canvas using Angular testing utilities
  - [ ] Create integration tests for table section assignment through ABP service proxies
  - [ ] Test section assignment validation and table status logic
  - [ ] Add E2E tests for complete table section management workflow using Playwright

## Dev Notes

### Previous Story Context
Stories 1.1 through 2.1 established:
- ABP Framework backend with .NET 8 running at https://localhost:44346
- Angular 19 frontend with PrimeNG Poseidon theme integration and TailwindCSS
- Authentication and user management system with role-based permissions
- Vietnamese restaurant layout components and responsive design framework  
- ComponentBase pattern for consistent form validation and error handling
- PostgreSQL database with Vietnamese text search and collation support
- LayoutSection entity with DisplayOrder management and section hierarchy

**Critical from 2.1:** LayoutSection entity is fully implemented with CRUD operations, drag-drop reordering, and Vietnamese validation. Table entity exists with basic structure but needs enhancement for positioning within sections.

### Architecture Context

[Source: architecture/tech-stack.md]
**Technology Stack:**
- Backend: ABP Framework 8.0, .NET 8, C# 12.0, PostgreSQL 14+
- Frontend: Angular 19, TypeScript 5.0+, PrimeNG 19.x with Poseidon theme, @angular/cdk/drag-drop
- Authentication: ABP Identity 8.0 with Vietnamese user workflows
- Testing: xUnit + Moq for backend, Jasmine + Karma for frontend, Playwright for E2E

[Source: architecture/coding-standards.md]
**Critical ABP Development Rules:**
- Always define entities in Domain layer using ABP base classes (FullAuditedEntity, etc.)
- Use ABP proxy generation for frontend types - never manually create TypeScript interfaces
- Always use auto-generated ABP service proxies for API calls
- Use ABP repositories and Entity Framework Core for database access
- Implement IApplicationService for auto-API generation
- Define DTOs in Application layer for auto-proxy generation
- Use ABP authorization attributes and permission system
- Use ABP localization system for Vietnamese text

### Domain Model Architecture

[Source: architecture/data-models.md]
**Simplified Table Entity Structure:**
```csharp
// aspnet-core/src/SmartRestaurant.Domain/Entities/Tables/Table.cs
public class Table : FullAuditedEntity<Guid>
{
    /// <summary>Số bàn hiển thị (ví dụ: "B01", "B02", "VIP1")</summary>
    public string TableNumber { get; set; }
    
    /// <summary>ID khu vực bố cục mà bàn này thuộc về</summary>
    public Guid LayoutSectionId { get; set; }
    
    /// <summary>Thứ tự hiển thị bàn trong khu vực</summary>
    public int DisplayOrder { get; set; }
    
    /// <summary>Trạng thái hiện tại của bàn</summary>
    public TableStatus Status { get; set; }
    
    /// <summary>ID đơn hàng hiện tại đang sử dụng bàn (nếu có)</summary>
    public Guid? CurrentOrderId { get; set; }
    
    // Navigation properties
    /// <summary>Khu vực bố cục chứa bàn này</summary>
    public virtual LayoutSection LayoutSection { get; set; }
    
    /// <summary>Đơn hàng hiện tại (nếu có)</summary>
    public virtual Order CurrentOrder { get; set; }
}

/// <summary>Table status enum</summary>
public enum TableStatus
{
    /// <summary>Table is empty and ready for service</summary>
    Available,
    
    /// <summary>Table is currently occupied by customers</summary>
    Occupied,
    
    /// <summary>Table has been reserved</summary>
    Reserved,
    
    /// <summary>Table is being cleaned</summary>
    Cleaning
}
```

**Auto-Generated Frontend Interface:**
```typescript
// Generated by ABP CLI: src/app/proxy/tables/models.ts
export interface TableDto {
  id: string;
  tableNumber: string;
  layoutSectionId: string;
  displayOrder: number;
  status: TableStatus;
  currentOrderId?: string;
}

export interface AssignTableToSectionDto {
  layoutSectionId: string;
}

export interface UpdateTableDisplayOrderDto {
  displayOrder: number;
}

export enum TableStatus {
  Available = 0,
  Occupied = 1,
  Reserved = 2,
  Cleaning = 3
}
```

### Application Service Architecture

[Source: architecture/backend-architecture.md]
**Simplified Table Application Service Pattern:**
```csharp
// aspnet-core/src/SmartRestaurant.Application/TableManagement/Tables/TableAppService.cs
[Authorize(SmartRestaurantPermissions.TableManagement.Default)]
public class TableAppService : ApplicationService, ITableAppService
{
    private readonly ITableRepository _tableRepository;
    private readonly ILayoutSectionRepository _layoutSectionRepository;

    public TableAppService(
        ITableRepository tableRepository,
        ILayoutSectionRepository layoutSectionRepository)
    {
        _tableRepository = tableRepository;
        _layoutSectionRepository = layoutSectionRepository;
    }
    
    [Authorize(SmartRestaurantPermissions.TableManagement.AssignTableToSection)]
    public async Task AssignToSectionAsync(Guid id, AssignTableToSectionDto input)
    {
        var table = await _tableRepository.GetAsync(id);
        var section = await _layoutSectionRepository.GetAsync(input.LayoutSectionId);
        
        table.AssignToSection(input.LayoutSectionId);
        await _tableRepository.UpdateAsync(table);
    }

    [Authorize(SmartRestaurantPermissions.TableManagement.EditTableOrder)]
    public async Task UpdateDisplayOrderAsync(Guid id, UpdateTableDisplayOrderDto input)
    {
        var table = await _tableRepository.GetAsync(id);
        table.UpdateDisplayOrder(input.DisplayOrder);
        await _tableRepository.UpdateAsync(table);
    }

    public async Task<List<TableDto>> GetTablesBySectionAsync(Guid layoutSectionId)
    {
        var tables = await _tableRepository.GetTablesBySectionAsync(layoutSectionId);
        return ObjectMapper.Map<List<Table>, List<TableDto>>(tables
            .OrderBy(t => t.DisplayOrder)
            .ThenBy(t => t.TableNumber));
    }
}
```

### Frontend Architecture

[Source: architecture/frontend-architecture.md]
**Feature Module Structure:**
```typescript
// angular/src/app/features/table-management/table-positioning/
├── table-layout-kanban/
│   ├── table-layout-kanban.component.ts    # Main kanban layout with columns
│   ├── table-layout-kanban.component.html  # Kanban template with drag-drop
│   ├── table-layout-kanban.component.scss  # Kanban styles
│   └── table-layout-kanban.component.spec.ts # Kanban tests
├── section-column/
│   ├── section-column.component.ts         # Individual section column
│   ├── section-column.component.html       # Column template
│   ├── section-column.component.scss       # Column styles
│   └── section-column.component.spec.ts    # Column tests
├── table-card/
│   ├── table-card.component.ts             # Individual table card
│   ├── table-card.component.html           # Table card template
│   ├── table-card.component.scss           # Table card styles
│   └── table-card.component.spec.ts        # Table card tests
└── services/
    └── table-kanban.service.ts             # Kanban business logic service
```

**Kanban Drag-Drop Component Implementation:**
```typescript
// table-layout-kanban.component.ts
import { Component, OnInit } from '@angular/core';
import { CdkDragDrop, moveItemInArray, transferArrayItem } from '@angular/cdk/drag-drop';
import { ComponentBase } from '@shared/base/component-base';
import { TableService } from '@proxy/table-management/tables';
import { LayoutSectionService } from '@proxy/table-management/layout-sections';

@Component({
  selector: 'app-table-layout-kanban',
  standalone: true,
  imports: [CommonModule, DragDropModule, CardModule, ButtonModule, TooltipModule],
  template: `
    <div class="kanban-board">
      <div class="board-header">
        <h2>Table Layout Management</h2>
        <p-button label="Refresh" icon="pi pi-refresh" (click)="refresh()"></p-button>
      </div>
      
      <div class="kanban-columns" cdkDropListGroup>
        <div *ngFor="let section of layoutSections" 
             class="kanban-column"
             cdkDropList
             [cdkDropListData]="sectionTables[section.id]"
             [id]="section.id"
             (cdkDropListDropped)="onTableDrop($event)">
          
          <!-- Section Header -->
          <div class="column-header">
            <h3>{{ section.sectionName }}</h3>
            <p-badge [value]="sectionTables[section.id]?.length || 0" severity="info"></p-badge>
          </div>
          
          <!-- Table Cards -->
          <div *ngFor="let table of sectionTables[section.id]" 
               class="table-card"
               cdkDrag
               [cdkDragData]="table"
               [class.occupied]="table.status === 'Occupied'"
               [class.reserved]="table.status === 'Reserved'"
               [class.cleaning]="table.status === 'Cleaning'">
            
            <p-card>
              <div class="table-info">
                <h4>{{ table.tableNumber }}</h4>
                <p-badge [value]="getStatusText(table.status)" 
                         [severity]="getStatusSeverity(table.status)"></p-badge>
              </div>
              
              <div *ngIf="table.currentOrderId" class="order-info">
                <i class="pi pi-shopping-cart"></i>
                <span>Has Order</span>
              </div>
            </p-card>
          </div>
        </div>
      </div>
    </div>
  `,
  styleUrls: ['./table-layout-kanban.component.scss']
})
export class TableLayoutKanbanComponent extends ComponentBase implements OnInit {
  layoutSections: LayoutSectionDto[] = [];
  sectionTables: { [sectionId: string]: TableDto[] } = {};
  loading = false;

  constructor(
    private tableService: TableService,
    private layoutSectionService: LayoutSectionService
  ) {
    super();
  }

  async ngOnInit(): Promise<void> {
    await this.loadLayoutSections();
    await this.loadAllTables();
  }

  onTableDrop(event: CdkDragDrop<TableDto[]>): void {
    const table = event.item.data as TableDto;
    
    if (event.previousContainer === event.container) {
      // Reorder within same section
      moveItemInArray(event.container.data, event.previousIndex, event.currentIndex);
      this.updateTableDisplayOrder(table, event.currentIndex);
    } else {
      // Move between sections
      transferArrayItem(
        event.previousContainer.data,
        event.container.data,
        event.previousIndex,
        event.currentIndex
      );
      this.assignTableToSection(table, event.container.id, event.currentIndex);
    }
  }

  private async updateTableDisplayOrder(table: TableDto, newOrder: number): Promise<void> {
    try {
      await this.tableService.updateDisplayOrder(table.id, {
        displayOrder: newOrder
      }).toPromise();
      
      table.displayOrder = newOrder;
    } catch (error) {
      this.handleError(error, 'Failed to update table order');
      await this.loadAllTables(); // Revert on error
    }
  }

  private async assignTableToSection(table: TableDto, sectionId: string, newOrder: number): Promise<void> {
    try {
      await this.tableService.assignToSection(table.id, {
        layoutSectionId: sectionId
      }).toPromise();
      
      // Update local state
      table.layoutSectionId = sectionId;
      table.displayOrder = newOrder;
    } catch (error) {
      this.handleError(error, 'Failed to move table to different section');
      await this.loadAllTables(); // Revert on error
    }
  }

  getStatusText(status: TableStatus): string {
    const statusMap = {
      'Available': 'Available',
      'Occupied': 'Occupied', 
      'Reserved': 'Reserved',
      'Cleaning': 'Cleaning'
    };
    return statusMap[status] || status;
  }

  getStatusSeverity(status: TableStatus): string {
    const severityMap = {
      'Available': 'success',
      'Occupied': 'danger',
      'Reserved': 'warning', 
      'Cleaning': 'info'
    };
    return severityMap[status] || 'secondary';
  }
}
```

### Project Structure and File Locations

[Source: architecture/unified-project-structure.md]
**Backend Files:**
```
aspnet-core/src/
├── SmartRestaurant.Domain/
│   └── Entities/Tables/
│       └── Table.cs                         # Enhanced domain entity
├── SmartRestaurant.Application.Contracts/
│   └── TableManagement/
│       └── Tables/
│           ├── ITableAppService.cs          # Enhanced service interface
│           └── Dto/
│               ├── TableDto.cs              # Enhanced DTO
│               ├── UpdateTablePositionDto.cs # Position update DTO
│               └── AssignTableToSectionDto.cs # Section assignment DTO
├── SmartRestaurant.Application/
│   └── TableManagement/
│       └── Tables/
│           ├── TableAppService.cs           # Enhanced application service
│           └── TableAutoMapperProfile.cs    # AutoMapper configuration
└── SmartRestaurant.EntityFrameworkCore/
    ├── EntityFrameworkCore/
    │   └── SmartRestaurantDbContext.cs      # Update Table DbSet configuration
    └── Migrations/                          # New migration for positioning
```

**Frontend Files:**
```
angular/src/app/
├── proxy/table-management/tables/          # ABP generated proxies (updated)
│   ├── table.service.ts                    # Auto-generated service (enhanced)
│   ├── models.ts                           # TypeScript interfaces (enhanced)
│   └── index.ts                            # Barrel exports
├── features/table-management/               # Table management feature module
│   ├── table-positioning/                  # Kanban-style positioning components
│   │   ├── table-layout-kanban/            # Main kanban board component
│   │   ├── section-column/                 # Individual section column
│   │   ├── table-card/                     # Individual table card
│   │   └── services/                       # Kanban business logic services
│   └── table-management.routes.ts          # Enhanced feature routing
└── shared/components/                       # Reusable components
    └── kanban-layout/                      # Reusable kanban layout components (optional)
```

### ABP Authorization Integration

### Restaurant Kanban Layout Standards
**Common Restaurant Section Layout:**
- Section columns in logical order based on restaurant floor plan
- Table arrangement within columns by DisplayOrder: high priority tables at top
- Table status colors: Green (Available), Red (Occupied), Yellow (Reserved), Gray (Cleaning)
- Standard table naming convention for easy identification
- Real-time table count display in column headers

## Testing

[Source: architecture/testing-strategy.md]
**Test File Locations:**
- Backend Unit Tests: `test/SmartRestaurant.Application.Tests/TableManagement/Tables/TableAppService_Tests.cs`
- Frontend Unit Tests: `angular/src/app/features/table-management/table-positioning/table-layout-kanban/table-layout-kanban.component.spec.ts`
- Integration Tests: `angular/tests/integration/table-positioning.integration.spec.ts`

**Testing Requirements:**
- Test kanban-style column layout with localized section names
- Test drag-drop reordering within same section using DisplayOrder
- Test drag-drop table transfer between different sections
- Test table status display and visual feedback during drag operations
- Test permission-based access control for table section management
- Validate responsive kanban layout on tablet devices

**Test Framework Standards:**
- Frontend Testing: Jasmine + Karma for Angular unit tests with @angular/cdk/drag-drop testing utilities
- Backend Testing: xUnit for .NET unit tests with ABP test infrastructure
- E2E Testing: Playwright for complete table positioning workflows
- Mock Data: Restaurant section and table configurations with localization

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation for table positioning within layout sections based on Epic 2.2 requirements | Bob (Scrum Master) |
| 2025-08-22 | 1.1 | Fixed AC alignment with Epic 2.2 and corrected test file path references for kanban components | Sarah (Product Owner) |