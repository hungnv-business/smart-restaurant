# User Story 5.1: Waitstaff Order Management Workflow

**Epic**: Epic 5 - Order Processing & Kitchen Coordination  
**Story Points**: 35-50 (Level 2 - Business Logic Template)  
**Priority**: High  
**Status**: Approved  
**Assignee**: Development Team  
**Sprint**: TBD

## Template Metadata

### Template Level
**Selected Level**: Level 2 (Business Logic Template)

### Complexity Analysis
- **Entity Complexity**: Business - Order entity with complex lifecycle states (Pending ‚Üí Confirmed ‚Üí Preparing ‚Üí Ready ‚Üí Served ‚Üí Paid), kitchen coordination, and real-time updates
- **UI Complexity**: Workflow - Multi-step workflow from table selection ‚Üí menu browsing ‚Üí order confirmation ‚Üí kitchen coordination ‚Üí service completion with status tracking
- **Technical Requirements**: Business - Requires custom application services, real-time status updates via SignalR, kitchen integration, and printing functionality

### Estimated Story Points
**Range**: 35-50 points based on Level 2 template complexity

### Template References
- **Backend Template**: templates/backend-template-level2.md
- **Frontend Template**: templates/frontend-template-level2.md  
- **Task Template**: .bmad-core/templates/level2-tasks.yaml

## Story Dependencies

**Prerequisites**:
- ‚úÖ **Epic 4.3 - Multi-unit Ingredient System**: REQUIRED - Ingredient management with base unit conversion system must be complete
- ‚úÖ **Story 3.x - Table Management**: REQUIRED - Table entity and status management must exist
- ‚ö†Ô∏è **Story 4.1 - Menu Item Management**: REQUIRED - MenuItem entity with PrimaryIngredientId link established

**Future Integration Points**:
- üîÑ **Epic 8 - Payment Processing**: Payment button integration ready for future implementation

## Story Description

**As a** waitstaff,  
**I want** to complete the entire order process from table selection through order confirmation and kitchen coordination,  
**so that** I can efficiently serve customers through a seamless workflow: view table status ‚Üí select customer table ‚Üí browse menu ‚Üí order items ‚Üí confirm order ‚Üí coordinate with kitchen ‚Üí serve customers ‚Üí confirm completion.

## Acceptance Criteria

1. **Table Status & Selection**: Real-time table status display (Available, Occupied, Reserved, Cleaning) with color-coded indicators and touch-friendly selection interface

2. **Menu Browsing & Search**: Mobile-responsive menu display with Vietnamese text search, autocomplete, category filtering, and real-time availability status

3. **Item Selection & Customization**: Item selection with quantity adjustment, individual or general notes, and order summary display with table information

4. **Order Confirmation & Kitchen Integration**: Order confirmation with automatic printing to appropriate kitchen stations and real-time status tracking (Confirmed, Preparing, Ready, Served)

5. **Manual Print Functionality**: Manual print button to select specific dishes and reprint kitchen bills for orders as needed

6. **Service Completion Workflow**: Service completion confirmation interface with integration to table status updates and order history tracking

7. **Payment Button Integration**: Payment processing button placed alongside print and service action buttons for seamless payment workflow integration with Epic 8

## Tasks / Subtasks

### Backend Tasks

- [ ] **BE-1**: Design Order Domain Model with Business Logic (AC: 1, 4, 6)
  - [ ] Define Order entity with OrderStatus enum (Pending, Confirmed, Preparing, Ready, Served, Paid)
  - [ ] Create OrderItem entity and configure relationships with MenuItem
  - [ ] Add business rule validations for order transitions and table availability
  - [ ] Implement domain events for OrderStatusChanged and KitchenNotification
  - [ ] Add audit fields and ensure proper ABP FullAuditedAggregateRoot inheritance

- [ ] **BE-2**: Create Order Domain Service (T·∫°o Order Domain Service) (AC: 4, 5, 6)
  - [ ] Implement OrderDomainService v·ªõi ValidateTableAvailabilityAsync method (Tri·ªÉn khai OrderDomainService v·ªõi ph∆∞∆°ng th·ª©c ValidateTableAvailabilityAsync)
  - [ ] Add status transition validation logic (Pending ‚Üí Confirmed ‚Üí Preparing ‚Üí Ready ‚Üí Served ‚Üí Paid) (Th√™m logic validation chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i)
  - [ ] Create CalculateTotalAmountAsync method cho order pricing (T·∫°o ph∆∞∆°ng th·ª©c CalculateTotalAmountAsync cho t√≠nh gi√° ƒë∆°n h√†ng)
  - [ ] Implement NotifyKitchenAsync v√† PrintKitchenBillAsync methods (Tri·ªÉn khai c√°c ph∆∞∆°ng th·ª©c NotifyKitchenAsync v√† PrintKitchenBillAsync)
  - [ ] **Add ProcessInventoryDeductionAsync method cho automatic stock reduction when order confirmed** (Th√™m ph∆∞∆°ng th·ª©c ProcessInventoryDeductionAsync cho t·ª± ƒë·ªông tr·ª´ kho khi ƒë∆°n h√†ng ƒë∆∞·ª£c x√°c nh·∫≠n)
  - [ ] Add business rule enforcement cho service completion workflow (Th√™m th·ª±c thi quy t·∫Øc kinh doanh cho quy tr√¨nh ho√†n th√†nh ph·ª•c v·ª•)

- [ ] **BE-3**: Implement Order Application Service (Tri·ªÉn khai Order Application Service) (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create OrderAppService using IApplicationService (not ICrudAppService) (T·∫°o OrderAppService s·ª≠ d·ª•ng IApplicationService)
  - [ ] Implement CreateOrderAsync v·ªõi table validation v√† menu item checks (Tri·ªÉn khai CreateOrderAsync v·ªõi validation b√†n v√† ki·ªÉm tra m√≥n ƒÉn)
  - [ ] **Add inventory stock validation during CreateOrderAsync** (Th√™m validation t·ªìn kho trong CreateOrderAsync)
  - [ ] Add UpdateOrderStatusAsync method v·ªõi proper authorization (Th√™m ph∆∞∆°ng th·ª©c UpdateOrderStatusAsync v·ªõi ph√¢n quy·ªÅn ph√π h·ª£p)
  - [ ] **Integrate automatic inventory deduction when order status changes to Confirmed** (T√≠ch h·ª£p t·ª± ƒë·ªông tr·ª´ kho khi tr·∫°ng th√°i ƒë∆°n h√†ng chuy·ªÉn th√†nh Confirmed)
  - [ ] Create GetOrdersForTableAsync v√† GetKitchenOrdersAsync specialized methods (T·∫°o c√°c ph∆∞∆°ng th·ª©c chuy√™n bi·ªát GetOrdersForTableAsync v√† GetKitchenOrdersAsync)
  - [ ] Add PrintKitchenBillAsync v√† ReprintBillAsync functionality (Th√™m ch·ª©c nƒÉng PrintKitchenBillAsync v√† ReprintBillAsync)
  - [ ] Implement CompleteOrderServiceAsync v·ªõi table status reset (Tri·ªÉn khai CompleteOrderServiceAsync v·ªõi ƒë·∫∑t l·∫°i tr·∫°ng th√°i b√†n)
  - [ ] Add transaction management v√† comprehensive error handling (Th√™m qu·∫£n l√Ω transaction v√† x·ª≠ l√Ω l·ªói to√†n di·ªán)

- [ ] **BE-4**: Add Database Configuration and Performance (Th√™m C·∫•u h√¨nh Database v√† Hi·ªáu su·∫•t) (AC: 1, 4)
  - [ ] Configure Order, OrderItem, Table relationships trong SmartRestaurantDbContext (C·∫•u h√¨nh m·ªëi quan h·ªá Order, OrderItem, Table trong SmartRestaurantDbContext)
  - [ ] Add database migration cho Order v√† OrderItem entities (Th√™m migration database cho c√°c entity Order v√† OrderItem)
  - [ ] Configure performance indexes: Orders(TableId), Orders(Status), OrderItems(OrderId) (C·∫•u h√¨nh c√°c index hi·ªáu su·∫•t)
  - [ ] Add database constraints cho business rules (valid status transitions) (Th√™m c√°c r√†ng bu·ªôc database cho quy t·∫Øc kinh doanh)

- [ ] **BE-5**: Create SignalR Hubs for Real-time Updates (T·∫°o SignalR Hubs cho C·∫≠p nh·∫≠t Th·ªùi gian th·ª±c) (AC: 4, 6)
  - [ ] Implement KitchenHub cho real-time kitchen order updates (Tri·ªÉn khai KitchenHub cho c·∫≠p nh·∫≠t ƒë∆°n h√†ng b·∫øp th·ªùi gian th·ª±c)
  - [ ] Create TableManagementHub cho table status broadcasting (T·∫°o TableManagementHub cho ph√°t s√≥ng tr·∫°ng th√°i b√†n)
  - [ ] Add OrderStatusHub cho staff notifications (Th√™m OrderStatusHub cho th√¥ng b√°o nh√¢n vi√™n)
  - [ ] Configure hub authorization v·ªõi proper restaurant roles (C·∫•u h√¨nh ph√¢n quy·ªÅn hub v·ªõi c√°c vai tr√≤ nh√† h√†ng ph√π h·ª£p)
  - [ ] Add connection management v√† error handling (Th√™m qu·∫£n l√Ω k·∫øt n·ªëi v√† x·ª≠ l√Ω l·ªói)

- [ ] **BE-6**: Implement Business Logic Testing (Tri·ªÉn khai Ki·ªÉm th·ª≠ Logic Kinh doanh) (AC: All)
  - [ ] Write OrderDomainService unit tests cho all business rules (Vi·∫øt c√°c unit test OrderDomainService cho t·∫•t c·∫£ quy t·∫Øc kinh doanh)
  - [ ] Test order status transitions v√† validation logic (Ki·ªÉm th·ª≠ chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng v√† logic validation)
  - [ ] **Test automatic inventory deduction scenarios v√† stock validation** (Ki·ªÉm th·ª≠ c√°c k·ªãch b·∫£n t·ª± ƒë·ªông tr·ª´ kho v√† validation t·ªìn kho)
  - [ ] Create integration tests cho complete order workflow (T·∫°o c√°c integration test cho quy tr√¨nh ƒë∆°n h√†ng ho√†n ch·ªânh)
  - [ ] Test kitchen integration v√† printing functionality (Ki·ªÉm th·ª≠ t√≠ch h·ª£p b·∫øp v√† ch·ª©c nƒÉng in ·∫•n)
  - [ ] Add performance tests cho real-time updates (Th√™m c√°c test hi·ªáu su·∫•t cho c·∫≠p nh·∫≠t th·ªùi gian th·ª±c)

- [ ] **BE-7**: Create MenuItemIngredient Entity and Recipe System (T·∫°o Entity MenuItemIngredient v√† H·ªá th·ªëng Recipe) (AC: 2, 4)
  - [ ] Create MenuItemIngredient entity v·ªõi many-to-many relationship (T·∫°o entity MenuItemIngredient v·ªõi m·ªëi quan h·ªá nhi·ªÅu-nhi·ªÅu)
  - [ ] Add MenuItemIngredient properties: MenuItemId, IngredientId, RequiredQuantity, IsOptional (Th√™m c√°c thu·ªôc t√≠nh MenuItemIngredient)
  - [ ] Update MenuItem entity v·ªõi Ingredients navigation property (C·∫≠p nh·∫≠t entity MenuItem v·ªõi thu·ªôc t√≠nh ƒëi·ªÅu h∆∞·ªõng Ingredients)
  - [ ] Configure Entity Framework relationships cho MenuItemIngredient (C·∫•u h√¨nh m·ªëi quan h·ªá Entity Framework)
  - [ ] Create database migration cho MenuItemIngredients table (T·∫°o migration database cho b·∫£ng MenuItemIngredients)

- [ ] **BE-8**: Implement RecipeManager Domain Service (Tri·ªÉn khai RecipeManager Domain Service) (AC: 2, 4)
  - [ ] Create RecipeManager v·ªõi CheckIngredientAvailabilityAsync method (T·∫°o RecipeManager v·ªõi ph∆∞∆°ng th·ª©c CheckIngredientAvailabilityAsync)
  - [ ] Implement CalculateRequiredIngredientsAsync cho order items (Tri·ªÉn khai CalculateRequiredIngredientsAsync cho c√°c items ƒë∆°n h√†ng)
  - [ ] Add ProcessAutomaticDeductionAsync v·ªõi negative stock support (Th√™m ProcessAutomaticDeductionAsync v·ªõi h·ªó tr·ª£ kho √¢m)
  - [ ] Create GetMissingIngredientsAsync cho warning display (T·∫°o GetMissingIngredientsAsync cho hi·ªÉn th·ªã c·∫£nh b√°o)
  - [ ] Add business logic cho optional vs required ingredients (Th√™m logic kinh doanh cho nguy√™n li·ªáu t√πy ch·ªçn v√† b·∫Øt bu·ªôc)

- [ ] **BE-9**: Update Inventory System for Negative Stock (C·∫≠p nh·∫≠t H·ªá th·ªëng Kho cho Kho √¢m) (AC: 2, 4)  
  - [ ] Remove stock >= 0 constraints t·ª´ Ingredient entity (Lo·∫°i b·ªè r√†ng bu·ªôc kho >= 0 t·ª´ entity Ingredient)
  - [ ] Update IngredientAppService ƒë·ªÉ allow negative stock operations (C·∫≠p nh·∫≠t IngredientAppService cho ph√©p thao t√°c kho √¢m)
  - [ ] Add missing ingredients calculation methods (Th√™m c√°c ph∆∞∆°ng th·ª©c t√≠nh to√°n nguy√™n li·ªáu thi·∫øu)
  - [ ] Create data migration ƒë·ªÉ migrate t·ª´ PrimaryIngredientId sang MenuItemIngredients (T·∫°o migration d·ªØ li·ªáu)
  - [ ] Update stock display logic ƒë·ªÉ show negative values (C·∫≠p nh·∫≠t logic hi·ªÉn th·ªã kho ƒë·ªÉ hi·ªán gi√° tr·ªã √¢m)

### Flutter Mobile Tasks (Nhi·ªám v·ª• Flutter Mobile)

- [ ] **FLUTTER-1**: Create Multi-step Order Workflow Screens (T·∫°o M√†n h√¨nh Quy tr√¨nh ƒê∆°n h√†ng Nhi·ªÅu b∆∞·ªõc) (AC: 1, 2, 3)
  - [ ] Create order flow screens: flutter_mobile/lib/features/orders/screens/ (T·∫°o c√°c m√†n h√¨nh quy tr√¨nh order)
  - [ ] Implement stepper UI cho: Table Selection ‚Üí Menu Browsing ‚Üí Order Review ‚Üí Confirmation (Tri·ªÉn khai UI stepper cho c√°c b∆∞·ªõc)
  - [ ] Create navigation logic v·ªõi validation per step using Flutter navigation (T·∫°o logic ƒëi·ªÅu h∆∞·ªõng b∆∞·ªõc v·ªõi validation s·ª≠ d·ª•ng Flutter navigation)
  - [ ] Add progress indicators v√† Vietnamese labels using Flutter widgets (Th√™m ch·ªâ b√°o ti·∫øn tr√¨nh v√† nh√£n ti·∫øng Vi·ªát)
  - [ ] Implement step completion validation v√† business rules enforcement (Tri·ªÉn khai validation ho√†n th√†nh b∆∞·ªõc v√† th·ª±c thi quy t·∫Øc kinh doanh)

- [ ] **FLUTTER-2**: Build Touch-Friendly Table Selection Screen (X√¢y d·ª±ng M√†n h√¨nh Ch·ªçn B√†n Th√¢n thi·ªán C·∫£m ·ª©ng) (AC: 1)
  - [ ] Create table_selection_screen.dart v·ªõi color-coded status indicators (T·∫°o table_selection_screen.dart v·ªõi c√°c ch·ªâ b√°o tr·∫°ng th√°i m√£ m√†u)
  - [ ] Implement responsive grid layout cho tables using Flutter GridView (Tri·ªÉn khai b·ªë c·ª•c l∆∞·ªõi responsive cho b√†n)
  - [ ] Add real-time table status updates via WebSocket/SignalR connection (Th√™m c·∫≠p nh·∫≠t tr·∫°ng th√°i b√†n th·ªùi gian th·ª±c)
  - [ ] Create table status legend: Available (green), Occupied (red), Reserved (yellow), Cleaning (orange) (T·∫°o ch√∫ gi·∫£i tr·∫°ng th√°i b√†n)
  - [ ] Add table filtering v√† search functionality using Flutter search widgets (Th√™m ch·ª©c nƒÉng l·ªçc v√† t√¨m ki·∫øm b√†n)

- [ ] **FLUTTER-3**: Implement Menu Browsing and Search Screen (Tri·ªÉn khai M√†n h√¨nh Duy·ªát Menu v√† T√¨m ki·∫øm) (AC: 2, 3)
  - [ ] Create menu_browser_screen.dart v·ªõi category tabs v√† item list (T·∫°o menu_browser_screen.dart v·ªõi tab danh m·ª•c v√† danh s√°ch m√≥n)
  - [ ] Implement Vietnamese text search v·ªõi autocomplete using Flutter search delegate (Tri·ªÉn khai t√¨m ki·∫øm ti·∫øng Vi·ªát v·ªõi t·ª± ƒë·ªông ho√†n th√†nh)
  - [ ] Add category filtering v·ªõi availability status indicators (Th√™m l·ªçc danh m·ª•c v·ªõi ch·ªâ b√°o tr·∫°ng th√°i c√≥ s·∫µn)
  - [ ] Create item selection v·ªõi quantity adjustment controls using Flutter widgets (T·∫°o ch·ªçn m√≥n v·ªõi ƒëi·ªÅu khi·ªÉn ƒëi·ªÅu ch·ªânh s·ªë l∆∞·ª£ng)
  - [ ] Add individual item notes input v√† general order notes using Flutter text fields (Th√™m nh·∫≠p ghi ch√∫ m√≥n ri√™ng v√† chung)

- [ ] **FLUTTER-4**: Add Order Summary and Confirmation Screen (Th√™m M√†n h√¨nh T√≥m t·∫Øt v√† X√°c nh·∫≠n ƒê∆°n h√†ng) (AC: 3, 4, 7)
  - [ ] Create order_summary_screen.dart v·ªõi itemized list v√† pricing (T·∫°o order_summary_screen.dart v·ªõi danh s√°ch chi ti·∫øt v√† gi√°)
  - [ ] Implement order modification controls (quantity changes, item removal) (Tri·ªÉn khai ƒëi·ªÅu khi·ªÉn s·ª≠a ƒë·ªïi ƒë∆°n h√†ng)
  - [ ] Add table information display v√† order notes (Th√™m hi·ªÉn th·ªã th√¥ng tin b√†n v√† ghi ch√∫)
  - [ ] Create confirmation dialog v·ªõi order review using Flutter dialogs (T·∫°o dialog x√°c nh·∫≠n v·ªõi xem l·∫°i ƒë∆°n h√†ng)
  - [ ] Add payment button integration cho future Epic 8 workflow (Th√™m t√≠ch h·ª£p n√∫t thanh to√°n cho Epic 8)

- [ ] **FLUTTER-5**: Build Status Tracking and Kitchen Integration Screen (X√¢y d·ª±ng M√†n h√¨nh Theo d√µi Tr·∫°ng th√°i v√† T√≠ch h·ª£p B·∫øp) (AC: 4, 5, 6)
  - [ ] Create order_status_screen.dart v·ªõi Vietnamese status badges (T·∫°o order_status_screen.dart v·ªõi badge tr·∫°ng th√°i ti·∫øng Vi·ªát)
  - [ ] Implement real-time status updates via WebSocket subscription (Tri·ªÉn khai c·∫≠p nh·∫≠t tr·∫°ng th√°i th·ªùi gian th·ª±c)
  - [ ] Add manual print functionality v·ªõi dish selection interface (Th√™m ch·ª©c nƒÉng in th·ªß c√¥ng v·ªõi giao di·ªán ch·ªçn m√≥n)
  - [ ] Create service completion interface v·ªõi confirmation controls (T·∫°o giao di·ªán ho√†n th√†nh d·ªãch v·ª•)
  - [ ] Add status history timeline using Flutter timeline widgets (Th√™m d√≤ng th·ªùi gian l·ªãch s·ª≠ tr·∫°ng th√°i)

- [ ] **FLUTTER-6**: Implement Advanced Mobile Features and Error Handling (Tri·ªÉn khai T√≠nh nƒÉng Mobile N√¢ng cao v√† X·ª≠ l√Ω L·ªói) (AC: All)
  - [ ] Add conditional UI elements based on order status v√† business rules (Th√™m ph·∫ßn t·ª≠ UI c√≥ ƒëi·ªÅu ki·ªán)
  - [ ] Implement Vietnamese validation messages v√† error handling (Tri·ªÉn khai th√¥ng b√°o validation ti·∫øng Vi·ªát)
  - [ ] Create confirmation workflows cho critical operations using Flutter alerts (T·∫°o quy tr√¨nh x√°c nh·∫≠n cho thao t√°c quan tr·ªçng)
  - [ ] Add loading states v√† progress indicators using Flutter progress widgets (Th√™m tr·∫°ng th√°i t·∫£i v√† ch·ªâ b√°o ti·∫øn tr√¨nh)
  - [ ] Implement offline capability detection v√† user notifications using Flutter connectivity (Tri·ªÉn khai ph√°t hi·ªán offline v√† th√¥ng b√°o)
  - [ ] **Handle edge cases: Network timeouts, WebSocket disconnection, Invalid table states, Kitchen printer failures** (X·ª≠ l√Ω c√°c t√¨nh hu·ªëng edge case: Timeout m·∫°ng, m·∫•t k·∫øt n·ªëi WebSocket, tr·∫°ng th√°i b√†n kh√¥ng h·ª£p l·ªá, l·ªói m√°y in b·∫øp)
  - [ ] **Add comprehensive error recovery workflows: Auto-retry failed orders, Resume interrupted workflows, Sync data after reconnection** (Th√™m quy tr√¨nh ph·ª•c h·ªìi l·ªói to√†n di·ªán: T·ª± ƒë·ªông th·ª≠ l·∫°i ƒë∆°n h√†ng th·∫•t b·∫°i, ti·∫øp t·ª•c workflow b·ªã gi√°n ƒëo·∫°n, ƒë·ªìng b·ªô d·ªØ li·ªáu sau khi k·∫øt n·ªëi l·∫°i)
  - [ ] **Add accessibility features: Screen reader support, High contrast mode, Large text support, Touch target sizing** (Th√™m t√≠nh nƒÉng accessibility: H·ªó tr·ª£ ƒë·ªçc m√†n h√¨nh, ch·∫ø ƒë·ªô t∆∞∆°ng ph·∫£n cao, h·ªó tr·ª£ text l·ªõn, k√≠ch th∆∞·ªõc m·ª•c ti√™u c·∫£m ·ª©ng)

- [ ] **FLUTTER-7**: Add Missing Ingredients Warning System (Th√™m H·ªá th·ªëng C·∫£nh b√°o Thi·∫øu Nguy√™n li·ªáu) (AC: 2, 4)
  - [ ] Create missing ingredients warning popup v·ªõi Vietnamese messages (T·∫°o popup c·∫£nh b√°o thi·∫øu nguy√™n li·ªáu v·ªõi th√¥ng b√°o ti·∫øng Vi·ªát)
  - [ ] Display specific missing ingredients per menu item: "Ph·ªü B√≤: thi·∫øu Th·ªãt b√≤ (c·∫ßn 200g)" (Hi·ªÉn th·ªã nguy√™n li·ªáu thi·∫øu c·ª• th·ªÉ cho t·ª´ng m√≥n)
  - [ ] Add confirmation dialog: "ƒê·∫∑t m√≥n v√† c·∫ßn mua th√™m nguy√™n li·ªáu" (Th√™m dialog x√°c nh·∫≠n)
  - [ ] Implement real-time missing ingredients list screen (Tri·ªÉn khai m√†n h√¨nh danh s√°ch nguy√™n li·ªáu thi·∫øu th·ªùi gian th·ª±c)
  - [ ] Show negative stock values v·ªõi clear indicators: "Th·ªãt b√≤: -500g" (Hi·ªÉn th·ªã gi√° tr·ªã kho √¢m v·ªõi ch·ªâ b√°o r√µ r√†ng)

### Testing Tasks (Nhi·ªám v·ª• Ki·ªÉm th·ª≠)

- [ ] **TEST-1**: Business Logic Integration Testing (Ki·ªÉm th·ª≠ T√≠ch h·ª£p Logic Kinh doanh) (AC: All)
  - [ ] Test complete order workflow end-to-end t·ª´ table selection ƒë·∫øn payment (Ki·ªÉm th·ª≠ quy tr√¨nh ƒë∆°n h√†ng ho√†n ch·ªânh t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi)
  - [ ] Verify business rule enforcement across UI v√† API layers (X√°c minh th·ª±c thi quy t·∫Øc kinh doanh qua c√°c l·ªõp UI v√† API)
  - [ ] Test error scenarios v√† business validation failures (Ki·ªÉm th·ª≠ c√°c t√¨nh hu·ªëng l·ªói v√† th·∫•t b·∫°i validation kinh doanh)
  - [ ] Create test data scenarios cho different order types (dine-in, takeaway) (T·∫°o c√°c k·ªãch b·∫£n d·ªØ li·ªáu ki·ªÉm th·ª≠ cho c√°c lo·∫°i ƒë∆°n h√†ng kh√°c nhau)

- [ ] **TEST-2**: Flutter Mobile Testing (Ki·ªÉm th·ª≠ Flutter Mobile) (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Test multi-step workflow navigation v√† validation rules using Flutter test framework (Ki·ªÉm th·ª≠ ƒëi·ªÅu h∆∞·ªõng quy tr√¨nh nhi·ªÅu b∆∞·ªõc)
  - [ ] Verify Vietnamese text search functionality v√† autocomplete on mobile devices (X√°c minh ch·ª©c nƒÉng t√¨m ki·∫øm ti·∫øng Vi·ªát tr√™n thi·∫øt b·ªã di ƒë·ªông)
  - [ ] Test real-time status updates v√† WebSocket connection handling (Ki·ªÉm th·ª≠ c·∫≠p nh·∫≠t tr·∫°ng th√°i th·ªùi gian th·ª±c v√† x·ª≠ l√Ω WebSocket)
  - [ ] Create widget tests cho all Flutter screens and components (T·∫°o widget test cho t·∫•t c·∫£ m√†n h√¨nh v√† component Flutter)
  - [ ] Test touch interface usability v√† gesture handling on various screen sizes (Ki·ªÉm th·ª≠ giao di·ªán c·∫£m ·ª©ng v√† x·ª≠ l√Ω c·ª≠ ch·ªâ)

- [ ] **TEST-3**: Real-time Integration Testing (Ki·ªÉm th·ª≠ T√≠ch h·ª£p Th·ªùi gian th·ª±c) (AC: 4, 6)
  - [ ] Test SignalR hub connections v√† message broadcasting (Ki·ªÉm th·ª≠ k·∫øt n·ªëi SignalR hub v√† ph√°t s√≥ng th√¥ng ƒëi·ªáp)
  - [ ] Verify kitchen notification delivery v√† status updates (X√°c minh ph√¢n ph·ªëi th√¥ng b√°o b·∫øp v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i)
  - [ ] Test concurrent user scenarios v·ªõi multiple orders (Ki·ªÉm th·ª≠ c√°c k·ªãch b·∫£n ng∆∞·ªùi d√πng ƒë·ªìng th·ªùi v·ªõi nhi·ªÅu ƒë∆°n h√†ng)
  - [ ] Create stress tests cho real-time performance requirements (T·∫°o c√°c stress test cho y√™u c·∫ßu hi·ªáu su·∫•t th·ªùi gian th·ª±c)

- [ ] **TEST-4**: Recipe Management and Negative Stock Testing (Ki·ªÉm th·ª≠ Qu·∫£n l√Ω Recipe v√† Kho √¢m) (AC: 2, 4)
  - [ ] Test MenuItemIngredient relationships v√† recipe calculations (Ki·ªÉm th·ª≠ m·ªëi quan h·ªá MenuItemIngredient v√† t√≠nh to√°n recipe)
  - [ ] Verify negative stock scenarios v·ªõi automatic deduction (X√°c minh c√°c k·ªãch b·∫£n kho √¢m v·ªõi tr·ª´ kho t·ª± ƒë·ªông)
  - [ ] Test missing ingredients warning system (Ki·ªÉm th·ª≠ h·ªá th·ªëng c·∫£nh b√°o thi·∫øu nguy√™n li·ªáu)
  - [ ] Create integration tests cho complete recipe workflow (T·∫°o c√°c integration test cho quy tr√¨nh recipe ho√†n ch·ªânh)
  - [ ] Test optional vs required ingredients business logic (Ki·ªÉm th·ª≠ logic kinh doanh nguy√™n li·ªáu t√πy ch·ªçn vs b·∫Øt bu·ªôc)

## Dev Notes (Ghi ch√∫ Ph√°t tri·ªÉn)

### Template-Specific Guidance (Level 2 - Business Logic)

**Implementation Patterns:**
- Use ABP's IApplicationService instead of ICrudAppService for order management ƒë·ªÉ support complex business logic
- Implement Domain Services for order validation, status transitions, v√† kitchen coordination 
- Use SignalR hubs for real-time status updates between waitstaff v√† kitchen display
- Apply ABP's domain events pattern cho order status changes v√† notifications

**Required Dependencies:**
- ABP Framework 8.0 v·ªõi built-in authorization, localization, v√† in-memory caching support
- SignalR cho real-time communication gi·ªØa mobile app v√† kitchen systems
- Entity Framework Core cho database operations v·ªõi Vietnamese collation support  
- Flutter 3.35.1+ v·ªõi WebSocket support cho real-time updates
- Dart HTTP client cho API communication v·ªõi ABP backend
- ABP Memory Cache cho menu v√† recipe data caching
- **web_socket_channel**: ^2.4.0 package cho Flutter WebSocket connectivity
- **provider**: ^6.1.1 cho Flutter state management

**Required Environment Variables:**
```bash
# Backend API Configuration
APP_CORS_ORIGINS=http://localhost:3000,https://localhost:3001
ABP_LICENSE_CODE=your-abp-license-code
DEFAULT_CONNECTION_STRING=Host=localhost;Database=SmartRestaurant;Username=postgres;Password=postgres

# SignalR Configuration  
SIGNALR_CORS_ORIGINS=http://localhost:3000,https://localhost:3001
SIGNALR_HUB_TIMEOUT=30000

# Flutter Mobile Configuration
API_BASE_URL=https://localhost:44346
WEBSOCKET_URL=wss://localhost:44346/hubs
APP_ENV=development
API_TIMEOUT_SECONDS=30

# Kitchen Integration
KITCHEN_PRINTER_IP=192.168.1.100
KITCHEN_PRINTER_PORT=9100
PRINT_TIMEOUT_SECONDS=10

# Cache Configuration
MEMORY_CACHE_SIZE_MB=256
MENU_CACHE_EXPIRATION_MINUTES=60
RECIPE_CACHE_EXPIRATION_MINUTES=120
```

**File Structure v√† Naming Conventions:**
```
Backend:
- aspnet-core/src/SmartRestaurant.Domain/Orders/ (entities v√† domain services)
- aspnet-core/src/SmartRestaurant.Application/Orders/ (application services v√† DTOs)
- aspnet-core/src/SmartRestaurant.HttpApi/Hubs/ (SignalR hubs)

Flutter Mobile:  
- flutter_mobile/lib/features/orders/ (order management feature)
- flutter_mobile/lib/features/orders/screens/ (order workflow screens)
- flutter_mobile/lib/features/orders/widgets/ (reusable order widgets)
- flutter_mobile/lib/features/orders/services/ (API client services)
- flutter_mobile/lib/shared/models/ (order data models)
```

### Previous Story Context (Ng·ªØ c·∫£nh Story Tr∆∞·ªõc ƒë√≥)
From Epic 4 completion - Multi-unit ingredient system established foundation for:
- Menu item availability tracking based on ingredient stock levels (Theo d√µi t√¨nh tr·∫°ng c√≥ s·∫µn c·ªßa m√≥n ƒÉn d·ª±a tr√™n m·ª©c t·ªìn kho nguy√™n li·ªáu)
- Cost calculation integration for accurate order pricing (T√≠ch h·ª£p t√≠nh to√°n chi ph√≠ cho ƒë·ªãnh gi√° ƒë∆°n h√†ng ch√≠nh x√°c)
- Kitchen workflow optimization based on ingredient preparation requirements (T·ªëi ∆∞u h√≥a quy tr√¨nh b·∫øp d·ª±a tr√™n y√™u c·∫ßu chu·∫©n b·ªã nguy√™n li·ªáu)
- **Multi-unit purchase units v√† base unit conversion system ready for inventory deduction** (H·ªá th·ªëng ƒë∆°n v·ªã mua h√†ng ƒëa c·∫•p v√† chuy·ªÉn ƒë·ªïi ƒë∆°n v·ªã c∆° s·ªü ƒë√£ s·∫µn s√†ng cho vi·ªác tr·ª´ kho)
- **Basic MenuItem-Ingredient link exists but needs enhancement to MenuItemIngredient many-to-many** (Li√™n k·∫øt MenuItem-Ingredient c∆° b·∫£n ƒë√£ c√≥ nh∆∞ng c·∫ßn n√¢ng c·∫•p th√†nh MenuItemIngredient nhi·ªÅu-nhi·ªÅu)

### Migration Strategy (Chi·∫øn l∆∞·ª£c Di chuy·ªÉn)
**From MenuItem.PrimaryIngredientId to MenuItemIngredient System**:
1. **Phase 1**: Create MenuItemIngredient table v·ªõi migration script
2. **Phase 2**: Migrate existing PrimaryIngredientId data sang MenuItemIngredient records
3. **Phase 3**: Update application logic ƒë·ªÉ use new many-to-many relationship
4. **Phase 4**: Mark PrimaryIngredientId as Obsolete v·ªõi backward compatibility
5. **Phase 5**: Remove PrimaryIngredientId trong future release (post-story completion)

**Migration Script Template**:
```sql
-- Create MenuItemIngredient records from existing PrimaryIngredientId
INSERT INTO MenuItemIngredients (Id, MenuItemId, IngredientId, RequiredQuantity, IsOptional, CreationTime)
SELECT 
    gen_random_uuid(),
    mi.Id,
    mi.PrimaryIngredientId,
    COALESCE(mi.RequiredQuantity, 1),
    false,
    NOW()
FROM MenuItems mi 
WHERE mi.PrimaryIngredientId IS NOT NULL;
```

### Data Models and Relationships (M√¥ h√¨nh D·ªØ li·ªáu v√† M·ªëi quan h·ªá)
**Order Entity** (Level 2 complexity):
```csharp
public class Order : FullAuditedAggregateRoot<Guid>
{
    public string OrderNumber { get; set; }         // Display number (e.g., #001)
    public Guid TableId { get; set; }               // Table reference
    public OrderType OrderType { get; set; }        // DineIn/Takeaway
    public OrderStatus Status { get; set; }         // Status workflow
    public decimal TotalAmount { get; set; }        // VND pricing
    public string Notes { get; set; }               // Customer requests
    // Navigation: Table, OrderItems collection
}

public enum OrderStatus 
{
    Pending, Confirmed, Preparing, Ready, Served, Paid
}
```

**MenuItemIngredient Entity** (New for Recipe Management):
```csharp
public class MenuItemIngredient : Entity<Guid>
{
    public Guid MenuItemId { get; set; }           // Reference to MenuItem
    public Guid IngredientId { get; set; }         // Reference to Ingredient  
    public int RequiredQuantity { get; set; }      // Quantity in base unit (e.g., 200g)
    public bool IsOptional { get; set; } = false;  // Optional ingredient flag
    
    // Navigation properties
    public virtual MenuItem MenuItem { get; set; }
    public virtual Ingredient Ingredient { get; set; }
}
```

**Enhanced MenuItem Entity** (Updated for Recipe Support):
```csharp
public class MenuItem : FullAuditedEntity<Guid>
{
    // ... existing properties ...
    
    // Enhanced relationships
    public virtual ICollection<MenuItemIngredient> Ingredients { get; set; } // Many-to-many via bridge
    public virtual ICollection<OrderItem> OrderItems { get; set; }
    
    // Deprecated but maintained for backward compatibility
    [Obsolete("Use Ingredients collection instead")]
    public Guid? PrimaryIngredientId { get; set; }
    [Obsolete("Use Ingredients collection instead")]
    public int? RequiredQuantity { get; set; }
}
```

**SignalR Integration**:  
[Source: docs/architecture/core-workflows.md#Order-Processing-Workflow]
- KitchenHub broadcasts new orders v√† status changes
- TableManagementHub manages real-time table status updates  
- OrderStatusHub sends notifications to waitstaff v·ªÅ order ready status

### Business Logic Requirements (Y√™u c·∫ßu Logic Kinh doanh)
**Status Transition Rules** [Source: docs/architecture/data-models.md#Order]:
- Pending ‚Üí Confirmed (waitstaff action)
- Confirmed ‚Üí Preparing (kitchen action)  
- Preparing ‚Üí Ready (kitchen action)
- Ready ‚Üí Served (waitstaff confirmation)
- Served ‚Üí Paid (payment completion)

**Kitchen Integration** [Source: docs/architecture/core-workflows.md#Kitchen-Workflow]:
- Auto-print kitchen bills on order confirmation (T·ª± ƒë·ªông in bill b·∫øp khi x√°c nh·∫≠n ƒë∆°n h√†ng)
- Manual reprint functionality for specific dishes (Ch·ª©c nƒÉng in l·∫°i th·ªß c√¥ng cho c√°c m√≥n c·ª• th·ªÉ)
- Real-time status broadcasting to kitchen display (Ph√°t s√≥ng tr·∫°ng th√°i th·ªùi gian th·ª±c l√™n m√†n h√¨nh b·∫øp)
- FIFO order prioritization v·ªõi quick-cook optimization (∆Øu ti√™n ƒë∆°n h√†ng FIFO v·ªõi t·ªëi ∆∞u h√≥a n·∫•u nhanh)
- **Automatic inventory deduction when order confirmed v·ªõi negative stock support** (T·ª± ƒë·ªông tr·ª´ kho khi ƒë∆°n h√†ng ƒë∆∞·ª£c x√°c nh·∫≠n v·ªõi h·ªó tr·ª£ kho √¢m)
- **Missing ingredients warning system before order confirmation** (H·ªá th·ªëng c·∫£nh b√°o thi·∫øu nguy√™n li·ªáu tr∆∞·ªõc khi x√°c nh·∫≠n ƒë∆°n)

### API Specifications (Th√¥ng s·ªë k·ªπ thu·∫≠t API)
**OrderAppService Endpoints** [Source: docs/architecture/backend-architecture.md#API-Endpoints]:
```csharp
// ABP auto-generates REST endpoints:
GET /api/app/order                              // List orders v·ªõi filtering
POST /api/app/order                             // Create new order v·ªõi recipe validation v√† missing ingredients warning
PUT /api/app/order/{id}/status                  // Update order status v·ªõi automatic recipe-based inventory deduction
POST /api/app/order/{id}/print-kitchen-bill     // Manual print functionality
POST /api/app/order/{id}/payment                // Payment integration (Epic 8)
GET /api/app/order/check-missing-ingredients    // Check missing ingredients for order items
GET /api/app/order/{id}/missing-ingredients     // Get missing ingredients for specific order
POST /api/app/recipe/validate-availability      // Validate recipe ingredient availability for menu items
```

**RecipeManager Domain Service Methods**:
```csharp
// Recipe management methods:
Task<List<MissingIngredientDto>> CheckIngredientAvailabilityAsync(Guid menuItemId);
Task<Dictionary<Guid, int>> CalculateRequiredIngredientsAsync(List<OrderItemDto> orderItems);
Task ProcessAutomaticDeductionAsync(Guid orderId); // Supports negative stock
Task<List<MissingIngredientDto>> GetMissingIngredientsAsync(Guid orderId);
```

### Flutter Mobile Architecture Requirements (Y√™u c·∫ßu Ki·∫øn tr√∫c Flutter Mobile)  
**Flutter Widget Architecture** [Source: docs/architecture/unified-project-structure.md#Flutter-Architecture]:
- Stepper widget cho multi-step order process
- GridView cho table v√† menu item display
- ListView cho order items v√† status history  
- SnackBar/Toast widgets cho real-time notifications
- SearchDelegate cho Vietnamese text search

**Flutter State Management (Provider/BLoC)**:
```dart
class OrderState {
  final Order? currentOrder;
  final Table? selectedTable;  
  final List<MenuItem> availableMenuItems;
  final List<Order> orderHistory;
  final List<MissingIngredient> missingIngredients; // Missing ingredients for warnings
  final bool loading;
  final bool isConnected; // WebSocket connection status
}

class MissingIngredient {
  final String ingredientName;
  final String menuItemName; 
  final int requiredQuantity;
  final int currentStock;
  final String unit;
  final bool isOptional;
  
  String get displayText => "$menuItemName: thi·∫øu $ingredientName (c·∫ßn ${requiredQuantity}${unit})";
  String get stockDisplayText => "$ingredientName: ${currentStock}${unit}";
}
```

**WebSocket Integration**:
- Use web_socket_channel package cho real-time communication
- Implement automatic reconnection v·ªõi exponential backoff
- Handle connection state trong UI (connected/disconnected indicators)

### Testing Standards (Ti√™u chu·∫©n Ki·ªÉm th·ª≠)
**Test File Locations** [Source: docs/architecture/testing-strategy.md#Test-Structure]:
```
Backend Tests:
- test/SmartRestaurant.Domain.Tests/Orders/OrderManager_Tests.cs
- test/SmartRestaurant.Application.Tests/Orders/OrderAppService_Tests.cs

Flutter Mobile Tests:  
- flutter_mobile/test/features/orders/screens/table_selection_screen_test.dart
- flutter_mobile/test/features/orders/screens/menu_browser_screen_test.dart
- flutter_mobile/test/features/orders/widgets/order_item_widget_test.dart
- flutter_mobile/test/features/orders/services/order_api_service_test.dart
- flutter_mobile/test/features/orders/widgets/missing_ingredients_warning_test.dart
- flutter_mobile/test/features/orders/services/recipe_service_test.dart

Integration Tests:
- flutter_mobile/integration_test/order_workflow_test.dart
- flutter_mobile/integration_test/missing_ingredients_workflow_test.dart
```

**Testing Framework Requirements**:
- Backend: xUnit v·ªõi ABP test framework, Shouldly assertions
- Flutter Mobile: Flutter test framework v·ªõi mockito cho mocking
- Widget Testing: Flutter widget testing cho UI components v√† missing ingredients warnings
- Integration Testing: Flutter integration testing cho complete workflows including recipe management
- Recipe Testing: Comprehensive testing cho MenuItemIngredient calculations v√† negative stock scenarios
- Test coverage requirement: ‚â• 90% cho business logic components including recipe management

### Performance Considerations (C√¢n nh·∫Øc Hi·ªáu su·∫•t)
**Database Optimization**:
- Index on Orders(TableId, Status) cho efficient querying
- Index on MenuItemIngredients(MenuItemId, IngredientId) cho recipe lookups
- Include OrderItems v·ªõi MenuItem ƒë·ªÉ avoid N+1 queries
- Include MenuItemIngredients v·ªõi Ingredient cho recipe calculations
- Use ABP's IQueryable extensions cho pagination

**Mobile Performance**:
- WebSocket connection pooling cho concurrent mobile users
- Debounced status updates ƒë·ªÉ prevent UI flooding on mobile  
- Local caching for menu data v√† recipe information v·ªõi SQLite integration
- Lazy loading cho large menu lists v√† order history
- Image optimization cho menu item photos
- Efficient missing ingredients calculation ƒë·ªÉ minimize API calls
- Cache recipe data locally ƒë·ªÉ reduce network requests during order creation

**Server-side Caching (ABP Memory Cache)**:
- Cache menu items v√† categories ƒë·ªÉ reduce database queries
- Cache recipe configurations ƒë·ªÉ speed up missing ingredients calculations
- Cache user permissions v√† roles cho faster authorization checks
- Configurable cache expiration policies cho different data types

### Security Requirements (Y√™u c·∫ßu B·∫£o m·∫≠t) [Source: docs/architecture/backend-architecture.md#Authentication-and-Authorization]
```csharp
[Authorize(SmartRestaurantPermissions.Orders.Create)]  // Order creation
[Authorize(SmartRestaurantPermissions.Kitchen.View)]   // Kitchen access
[Authorize(SmartRestaurantPermissions.Payments.Process)] // Payment handling
```

### Localization Support (H·ªó tr·ª£ B·∫£n ƒë·ªãa h√≥a)
- All UI text in Vietnamese v·ªõi ABP localization system
- Currency formatting: Vietnamese Dong (‚Ç´) v·ªõi proper thousands separation
- Date/time: Vietnamese format (dd/MM/yyyy HH:mm)
- Error messages: Vietnamese user-friendly business validation messages

## Dev Agent Record (B·∫£n ghi Dev Agent)

### Agent Model Used (M√¥ h√¨nh Agent ƒë∆∞·ª£c s·ª≠ d·ª•ng)
_To be populated by development agent during implementation_

### Debug Log References (Tham chi·∫øu Debug Log)
_To be populated by development agent during implementation_

### Completion Notes List (Danh s√°ch Ghi ch√∫ Ho√†n th√†nh)
_To be populated by development agent during implementation_

### File List (Danh s√°ch File)
_To be populated by development agent during implementation_

## QA Results (K·∫øt qu·∫£ QA)

_Results from QA Agent QA review of the completed story implementation will be populated here_

## Change Log (Nh·∫≠t k√Ω Thay ƒë·ªïi)

| Date (Ng√†y) | Version (Phi√™n b·∫£n) | Description (M√¥ t·∫£) | Author (T√°c gi·∫£) |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation v·ªõi Level 2 template (T·∫°o story ban ƒë·∫ßu v·ªõi m·∫´u Level 2) | Bob (Scrum Master) |
| 2025-09-04 | 1.1 | Added Vietnamese bilingual support (Th√™m h·ªó tr·ª£ song ng·ªØ ti·∫øng Vi·ªát) | Bob (Scrum Master) |
| 2025-09-04 | 1.2 | Added automatic inventory deduction integration (Th√™m t√≠ch h·ª£p t·ª± ƒë·ªông tr·ª´ kho) | Bob (Scrum Master) |
| 2025-09-04 | 1.3 | Switched from Angular web to Flutter mobile focus (Chuy·ªÉn t·ª´ Angular web sang t·∫≠p trung Flutter mobile) | Bob (Scrum Master) |
| 2025-09-04 | 1.4 | Added complete Recipe Management system v·ªõi MenuItemIngredient entity v√† negative stock support (Th√™m h·ªá th·ªëng Recipe Management ho√†n ch·ªânh v·ªõi entity MenuItemIngredient v√† h·ªó tr·ª£ kho √¢m) | Bob (Scrum Master) |
| 2025-09-04 | 1.5 | Removed Redis dependency, replaced with ABP Memory Cache (Lo·∫°i b·ªè dependency Redis, thay b·∫±ng ABP Memory Cache) | Bob (Scrum Master) |
| 2025-09-04 | 1.6 | Fixed validation issues: Added explicit dependencies, environment variables, standardized references, enhanced edge cases, migration strategy, accessibility features (S·ª≠a c√°c v·∫•n ƒë·ªÅ validation: Th√™m dependencies r√µ r√†ng, bi·∫øn m√¥i tr∆∞·ªùng, chu·∫©n h√≥a tham chi·∫øu, n√¢ng cao edge cases, chi·∫øn l∆∞·ª£c migration, t√≠nh nƒÉng accessibility) | Sarah (Product Owner) |
