# Câu chuyện 2.1: Quản lý Khu vực Bố cục

## Trạng thái
Đã duyệt

## Câu chuyện
**Với tư cách là** quản lý nhà hàng,  
**Tôi muốn** tạo và quản lý các khu vực bố cục như "Dãy 1", "Dãy 2", "Khu VIP",  
**để** tôi có thể tổ chức bàn thành các khu vực hợp lý trong nhà hàng.

## Tiêu chí chấp nhận
1. Thao tác CRUD cho khu vực bố cục với tên tiếng Việt
2. Quản lý thứ tự và hiển thị khu vực
3. Điều khiển trạng thái khu vực (hoạt động/không hoạt động)

## Nhiệm vụ / Nhiệm vụ con

- [ ] Triển khai Mô hình Domain Backend (TC: 1, 2, 3)
  - [ ] Tạo entity LayoutSection trong Domain layer kế thừa FullAuditedEntity<Guid> với tên khu vực tiếng Việt
  - [ ] Thêm thuộc tính DisplayOrder cho thứ tự khu vực và IsActive cho điều khiển trạng thái
  - [ ] Tạo cấu hình Entity Framework Core và migration cho entity LayoutSection
  - [ ] Tạo interface ILayoutSectionAppService trong Application.Contracts/TableManagement/LayoutSections layer
  - [ ] Triển khai LayoutSectionAppService trong Application/TableManagement/LayoutSections layer với thao tác CRUD và ủy quyền ABP
  - [ ] Tạo ABP service proxies cho frontend bằng lệnh abp generate-proxy

- [ ] Thành phần Quản lý Khu vực Bố cục Frontend (TC: 1, 2, 3)
  - [ ] Tạo feature module layout-section-management dưới angular/src/app/features/table-management/
  - [ ] Triển khai component layout-section-list sử dụng PrimeNG DataTable với tiêu đề cột tiếng Việt
  - [ ] Tạo component layout-section-form cho thao tác thêm/sửa với validation tiếng Việt
  - [ ] Thêm chức năng sắp xếp khu vực với tính năng kéo thả sử dụng @angular/cdk/drag-drop
  - [ ] Triển khai toggle IsActive với phản hồi trực quan sử dụng PrimeNG InputSwitch
  - [ ] Áp dụng phong cách nhà hàng Việt Nam sử dụng PrimeNG Poseidon theme và TailwindCSS

- [ ] Tích hợp và Validation tiếng Việt (TC: 1, 3)
  - [ ] Thêm validation văn bản tiếng Việt cho tên khu vực với thông báo lỗi phù hợp
  - [ ] Triển khai các mẫu đặt tên khu vực tiếng Việt (Dãy 1, Khu VIP, Sân vườn, v.v.)
  - [ ] Tạo bản địa hóa tiếng Việt cho tất cả văn bản UI và thông báo validation
  - [ ] Thêm hộp thoại xác nhận tiếng Việt cho thao tác xóa

- [ ] Triển khai Kiểm thử
  - [ ] Tạo unit tests cho LayoutSectionAppService sử dụng xUnit và ABP test infrastructure
  - [ ] Triển khai frontend component tests cho layout-section-list và layout-section-form sử dụng Angular testing utilities
  - [ ] Tạo integration tests cho thao tác CRUD thông qua ABP service proxies
  - [ ] Kiểm thử validation văn bản tiếng Việt và chức năng sắp xếp khu vực
  - [ ] Thêm E2E tests cho quy trình quản lý khu vực hoàn chỉnh

## Ghi chú Dev

### Ngữ cảnh Câu chuyện Trước đó
Các câu chuyện 1.1 đến 1.4 đã thiết lập:
- ABP Framework backend với .NET 8 chạy tại https://localhost:44346
- Angular 19 frontend với tích hợp PrimeNG Poseidon theme và TailwindCSS
- Hệ thống xác thực và quản lý người dùng với quyền dựa trên vai trò
- Các thành phần bố cục nhà hàng Việt Nam và framework thiết kế responsive  
- Pattern ComponentBase cho validation form nhất quán và xử lý lỗi
- Cơ sở dữ liệu PostgreSQL với tìm kiếm văn bản tiếng Việt và hỗ trợ collation

Hệ thống hiện tại cần quản lý bố cục bàn phân cấp với các khu vực logic để tổ chức bàn hiệu quả trong không gian nhà hàng Việt Nam.

### Ngữ cảnh Kiến trúc

[Nguồn: architecture/tech-stack.md]
**Ngăn xếp Công nghệ:**
- Backend: ABP Framework 8.0, .NET 8, C# 12.0, PostgreSQL 14+
- Frontend: Angular 19, TypeScript 5.0+, PrimeNG 19.x với Poseidon theme
- Xác thực: ABP Identity 8.0 với quy trình người dùng tiếng Việt
- Kiểm thử: xUnit + Moq cho backend, Jasmine + Karma cho frontend, Playwright cho E2E

[Nguồn: architecture/coding-standards.md]
**Quy tắc Phát triển ABP Quan trọng:**
- Luôn định nghĩa entities trong Domain layer sử dụng các base classes ABP (FullAuditedEntity, v.v.)
- Sử dụng ABP proxy generation cho các types frontend - không bao giờ tạo TypeScript interfaces thủ công
- Luôn sử dụng auto-generated ABP service proxies cho API calls
- Sử dụng ABP repositories và Entity Framework Core cho database access
- Triển khai IApplicationService cho auto-API generation
- Định nghĩa DTOs trong Application layer cho auto-proxy generation
- Sử dụng ABP authorization attributes và permission system
- Sử dụng ABP localization system cho văn bản tiếng Việt

### Kiến trúc Mô hình Domain

[Nguồn: architecture/data-models.md]
**Cấu trúc Entity LayoutSection:**
```csharp
// aspnet-core/src/SmartRestaurant.Domain/Entities/Tables/LayoutSection.cs
public class LayoutSection : FullAuditedEntity<Guid>
{
    /// <summary>Tên khu vực bố cục (ví dụ: "Dãy 1", "Khu VIP", "Sân vườn")</summary>
    public string SectionName { get; set; }
    
    /// <summary>Mô tả chi tiết khu vực</summary>
    public string Description { get; set; }
    
    /// <summary>Thứ tự hiển thị khu vực</summary>
    public int DisplayOrder { get; set; }
    
    /// <summary>Khu vực có đang hoạt động hay không</summary>
    public bool IsActive { get; set; }
    
    // Navigation properties
    /// <summary>Danh sách bàn thuộc khu vực này</summary>
    public virtual ICollection<Table> Tables { get; set; }
}
```

**Interface Frontend Tự động tạo:**
```typescript
// Được tạo bởi ABP CLI: src/app/proxy/table-management/layout-sections/models.ts
export interface LayoutSectionDto {
  id: string;
  sectionName: string;
  description?: string;
  displayOrder: number;
  isActive: boolean;
}

export interface CreateLayoutSectionDto {
  sectionName: string;
  description?: string;
  displayOrder: number;
  isActive: boolean;
}
```

### Kiến trúc Application Service

[Nguồn: architecture/backend-architecture.md]
**Pattern ABP Application Service:**
```csharp
// aspnet-core/src/SmartRestaurant.Application/TableManagement/LayoutSections/LayoutSectionAppService.cs
[Authorize(SmartRestaurantPermissions.TableManagement.Default)]
public class LayoutSectionAppService : ApplicationService, ILayoutSectionAppService
{
    private readonly ILayoutSectionRepository _layoutSectionRepository;

    public LayoutSectionAppService(ILayoutSectionRepository layoutSectionRepository)
    {
        _layoutSectionRepository = layoutSectionRepository;
    }

    [Authorize(SmartRestaurantPermissions.TableManagement.CreateLayout)]
    public async Task<LayoutSectionDto> CreateAsync(CreateLayoutSectionDto input)
    {
        var layoutSection = new LayoutSection(
            GuidGenerator.Create(),
            input.SectionName,
            input.Description,
            input.DisplayOrder,
            input.IsActive
        );

        await _layoutSectionRepository.InsertAsync(layoutSection);
        return ObjectMapper.Map<LayoutSection, LayoutSectionDto>(layoutSection);
    }
    
    // Các thao tác CRUD bổ sung...
}
```

### Kiến trúc Frontend

[Nguồn: architecture/frontend-architecture.md]
**Cấu trúc Feature Module:**
```typescript
// angular/src/app/features/table-management/layout-sections/
├── layout-section-management.routes.ts     # Định tuyến tính năng
├── layout-section-list/
│   ├── layout-section-list.component.ts    # List component với DataTable
│   ├── layout-section-list.component.html  # List template
│   ├── layout-section-list.component.scss  # List styles
│   └── layout-section-list.component.spec.ts # List tests
├── layout-section-form/
│   ├── layout-section-form.component.ts    # Form component
│   ├── layout-section-form.component.html  # Form template
│   ├── layout-section-form.component.scss  # Form styles
│   └── layout-section-form.component.spec.ts # Form tests
└── services/
    └── layout-section.service.ts           # Business logic service
```

**Triển khai Component với Pattern ComponentBase:**
```typescript
// layout-section-list.component.ts
import { Component, OnInit } from '@angular/core';
import { ComponentBase } from '@shared/base/component-base';
import { LayoutSectionService } from '@proxy/table-management/layout-sections';
import { LayoutSectionDto } from '@proxy/table-management/layout-sections/models';

@Component({
  selector: 'app-layout-section-list',
  standalone: true,
  imports: [CommonModule, DataTableModule, ButtonModule, InputSwitchModule],
  templateUrl: './layout-section-list.component.html'
})
export class LayoutSectionListComponent extends ComponentBase implements OnInit {
  layoutSections: LayoutSectionDto[] = [];
  loading = false;

  constructor(private layoutSectionService: LayoutSectionService) {
    super();
  }

  async ngOnInit(): Promise<void> {
    await this.loadLayoutSections();
  }

  private async loadLayoutSections(): Promise<void> {
    this.loading = true;
    try {
      const result = await this.layoutSectionService.getList({}).toPromise();
      this.layoutSections = result.items;
    } catch (error) {
      this.handleError(error, 'Không thể tải danh sách khu vực');
    } finally {
      this.loading = false;
    }
  }
}
```

### Cấu trúc Dự án và Vị trí File

[Nguồn: architecture/unified-project-structure.md]
**Files Backend:**
```
aspnet-core/src/
├── SmartRestaurant.Domain/
│   └── Entities/Tables/
│       └── LayoutSection.cs              # Domain entity
├── SmartRestaurant.Application.Contracts/
│   └── TableManagement/
│       └── LayoutSections/
│           ├── ILayoutSectionAppService.cs   # Service interface
│           └── Dto/
│               ├── LayoutSectionDto.cs       # Data transfer objects
│               ├── CreateLayoutSectionDto.cs # Create DTO
│               └── UpdateLayoutSectionDto.cs # Update DTO
├── SmartRestaurant.Application/
│   └── TableManagement/
│       └── LayoutSections/
│           ├── LayoutSectionAppService.cs    # Application service implementation
│           └── LayoutSectionAutoMapperProfile.cs # AutoMapper configuration
└── SmartRestaurant.EntityFrameworkCore/
    ├── EntityFrameworkCore/
    │   ├── SmartRestaurantDbContext.cs   # Thêm LayoutSection DbSet
    │   └── LayoutSectionEntityTypeConfiguration.cs # EF Core configuration
    └── Migrations/                       # Database migration files
```

**Files Frontend:**
```
angular/src/app/
├── proxy/table-management/layout-sections/ # ABP generated proxies
│   ├── layout-section.service.ts        # Auto-generated service
│   ├── models.ts                        # TypeScript interfaces
│   └── index.ts                         # Barrel exports
├── features/table-management/            # Table management feature module
│   ├── layout-sections/                 # Layout section components
│   │   ├── layout-section-list/         # List component
│   │   ├── layout-section-form/         # Form component
│   │   └── services/                    # Business logic services
│   └── table-management.routes.ts       # Feature routing
├── shared/components/                    # Reusable components
│   └── validation-error/                # Validation error display
└── layout/components/                    # Updated menu integration
    └── app.menu.ts                      # Menu với layout section routes
```

### Tích hợp ABP Authorization

[Nguồn: architecture/backend-architecture.md#authentication-and-authorization]
**Hệ thống Permission:**
```csharp
// SmartRestaurantPermissions.cs - Thêm layout section permissions
public static class TableManagement
{
    public const string Default = GroupName + ".TableManagement";
    public const string ViewLayout = Default + ".ViewLayout";
    public const string EditLayout = Default + ".EditLayout";
    public const string CreateLayout = Default + ".CreateLayout";
    public const string DeleteLayout = Default + ".DeleteLayout";
}

// LayoutSectionAppService.cs - Áp dụng authorization
[Authorize(SmartRestaurantPermissions.TableManagement.Default)]
public class LayoutSectionAppService : ApplicationService, ILayoutSectionAppService
{
    [Authorize(SmartRestaurantPermissions.TableManagement.CreateLayout)]
    public async Task<LayoutSectionDto> CreateAsync(CreateLayoutSectionDto input) { ... }
    
    [Authorize(SmartRestaurantPermissions.TableManagement.EditLayout)]
    public async Task<LayoutSectionDto> UpdateAsync(Guid id, UpdateLayoutSectionDto input) { ... }
}
```

### Tiêu chuẩn Khu vực Nhà hàng Việt Nam
**Tên Khu vực Nhà hàng Việt Nam phổ biến:**
- "Dãy 1", "Dãy 2", "Dãy 3" (Row 1, Row 2, Row 3)
- "Khu VIP" (VIP Area)
- "Phòng riêng" (Private Room)
- "Sân vườn" (Garden Area)
- "Tầng 1", "Tầng 2" (Floor 1, Floor 2)
- "Khu gia đình" (Family Area)
- "Quầy bar" (Bar Area)

## Kiểm thử

[Nguồn: architecture/testing-strategy.md]
**Vị trí Test Files:**
- Backend Unit Tests: `test/SmartRestaurant.Application.Tests/TableManagement/LayoutSections/LayoutSectionAppService_Tests.cs`
- Frontend Unit Tests: `angular/src/app/features/table-management/layout-sections/layout-section-list/layout-section-list.component.spec.ts`
- Integration Tests: `angular/tests/integration/layout-section-management.integration.spec.ts`

**Yêu cầu Kiểm thử:**
- Kiểm thử validation văn bản tiếng Việt và xử lý lỗi
- Kiểm thử chức năng sắp xếp khu vực và drag-and-drop
- Kiểm thử thao tác CRUD thông qua ABP service proxies
- Kiểm thử kiểm soát truy cập dựa trên quyền
- Xác thực thiết kế responsive trên thiết bị tablet

**Tiêu chuẩn Test Framework:**
- Frontend Testing: Jasmine + Karma cho Angular unit tests với PrimeNG component testing
- Backend Testing: xUnit cho .NET unit tests với ABP test infrastructure
- E2E Testing: Playwright cho quy trình quản lý khu vực bố cục hoàn chỉnh
- Mock Data: Tên khu vực nhà hàng Việt Nam phù hợp với yêu cầu kinh doanh

## Nhật ký Thay đổi

| Ngày | Phiên bản | Mô tả | Tác giả |
|------|-----------|-------|---------|
| 2025-08-21 | 1.0 | Tạo câu chuyện ban đầu cho quản lý khu vực bố cục dựa trên yêu cầu Epic 2.1 | Bob (Scrum Master) |

---

## Tham chiếu
- **File gốc (tiếng Anh):** [docs/stories/2.1.layout-section-management.md](../2.1.layout-section-management.md)
- **Epic liên quan:** [docs/prd/epics/epic-2-table-layout-management.md](../../prd/epics/epic-2-table-layout-management.md)