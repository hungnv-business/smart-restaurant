# Câu chuyện 2.2: Định vị Bàn trong Khu vực Bố cục

## Trạng thái
Được phê duyệt

## Câu chuyện
**Là một** nhân viên nhà hàng,  
**Tôi muốn** định vị bàn trong các khu vực bố cục bằng chức năng kéo-thả,  
**để có thể** sắp xếp bàn hiệu quả và cập nhật vị trí khi cần thiết.

## Tiêu chí Chấp nhận
1. Mỗi khu vực bố cục hiển thị như một cột với danh sách bàn theo chiều dọc
2. Bàn có thể kéo-thả trong cùng khu vực để sắp xếp lại
3. Bàn có thể kéo-thả giữa các khu vực khác nhau
4. Quản lý trạng thái bàn và phản hồi trực quan trong quá trình kéo

## Nhiệm vụ / Nhiệm vụ phụ

- [ ] Nâng cấp Table Entity Backend và Quản lý Khu vực (TC: 1)
  - [ ] Mở rộng Table entity để bao gồm quan hệ khóa ngoại LayoutSectionId và thuộc tính DisplayOrder
  - [ ] Tạo Entity Framework Core migration cho gán khu vực Table và sắp xếp hiển thị
  - [ ] Nâng cấp ITableAppService với các thao tác gán khu vực và sắp xếp thứ tự hiển thị
  - [ ] Triển khai logic gán khu vực và sắp xếp thứ tự TableAppService với validation và persistence
  - [ ] Thêm authorization permissions cho quản lý khu vực bàn và chỉnh sửa thứ tự hiển thị

- [ ] Bố cục Frontend Kiểu Kanban với Kéo-Thả (TC: 1, 2, 3, 4)
  - [ ] Tạo component table-layout-kanban dưới angular/src/app/features/table-management/
  - [ ] Triển khai bố cục theo cột nơi mỗi LayoutSection là một cột dọc
  - [ ] Sử dụng @angular/cdk/drag-drop để kéo bàn trong cùng section (sắp xếp lại)
  - [ ] Sử dụng @angular/cdk/drag-drop để kéo bàn giữa các section khác nhau
  - [ ] Thêm header section hiển thị tên section và số lượng bàn
  - [ ] Thêm card bàn với status indicators (Khả dụng/Đang sử dụng/Đã đặt/Đang dọn) với văn bản tiếng Việt
  - [ ] Triển khai vùng thả trực quan và phản hồi kéo sử dụng styling PrimeNG

- [ ] Quản lý Vị trí Kéo-Thả (TC: 2, 3)
  - [ ] Triển khai cập nhật DisplayOrder khi bàn được sắp xếp lại trong cùng section
  - [ ] Xử lý gán section khi bàn được di chuyển giữa các section
  - [ ] Thêm cập nhật UI optimistic với persistence vị trí server-side
  - [ ] Triển khai validation thao tác kéo (ngăn thả vào target không hợp lệ)
  - [ ] Thêm xác nhận cho việc di chuyển bàn đang sử dụng giữa các section

- [ ] Tích hợp Localization và Cập nhật UI (TC: 3, 4)
  - [ ] Thêm tooltip và label tiếng Việt cho gán section bàn
  - [ ] Triển khai cập nhật trạng thái bàn real-time sử dụng pattern ComponentBase hiện có
  - [ ] Thêm dialog xác nhận bằng tiếng Việt cho thay đổi section bàn
  - [ ] Tạo tooltip trạng thái bàn tiếng Việt và trợ giúp contextual
  - [ ] Triển khai cập nhật UI optimistic với rollback lỗi cho gán section thất bại

- [ ] Triển khai Testing
  - [ ] Tạo unit test cho TableAppService nâng cấp sử dụng xUnit và infrastructure test ABP
  - [ ] Triển khai test component frontend cho table-layout-kanban sử dụng tiện ích test Angular
  - [ ] Tạo test tích hợp cho gán section bàn thông qua service proxy ABP
  - [ ] Test validation gán section và logic trạng thái bàn
  - [ ] Thêm test E2E cho workflow quản lý section bàn hoàn chỉnh sử dụng Playwright

## Ghi chú Dev

### Ngữ cảnh Câu chuyện Trước đó
Các câu chuyện 1.1 đến 2.1 đã thiết lập:
- Backend ABP Framework với .NET 8 chạy tại https://localhost:44346
- Frontend Angular 19 với tích hợp theme PrimeNG Poseidon và TailwindCSS
- Hệ thống authentication và quản lý user với permission dựa trên role
- Các component layout nhà hàng Việt Nam và framework design responsive
- Pattern ComponentBase cho validation form và xử lý lỗi nhất quán
- Database PostgreSQL với search văn bản tiếng Việt và hỗ trợ collation
- LayoutSection entity với quản lý DisplayOrder và hierarchy section

**Quan trọng từ 2.1:** LayoutSection entity đã được triển khai đầy đủ với CRUD operations, sắp xếp lại drag-drop, và validation tiếng Việt. Table entity tồn tại với cấu trúc cơ bản nhưng cần nâng cấp để định vị trong section.

### Ngữ cảnh Architecture

[Nguồn: architecture/tech-stack.md]
**Tech Stack:**
- Backend: ABP Framework 8.0, .NET 8, C# 12.0, PostgreSQL 14+
- Frontend: Angular 19, TypeScript 5.0+, PrimeNG 19.x với theme Poseidon, @angular/cdk/drag-drop
- Authentication: ABP Identity 8.0 với workflow user tiếng Việt
- Testing: xUnit + Moq cho backend, Jasmine + Karma cho frontend, Playwright cho E2E

[Nguồn: architecture/coding-standards.md]
**Quy tắc Dev ABP Quan trọng:**
- Luôn định nghĩa entity trong Domain layer sử dụng class base ABP (FullAuditedEntity, v.v.)
- Sử dụng ABP proxy generation cho type frontend - không bao giờ tạo interface TypeScript thủ công
- Luôn sử dụng service proxy ABP auto-generated cho API call
- Sử dụng ABP repository và Entity Framework Core để truy cập database
- Triển khai IApplicationService để auto-generate API
- Định nghĩa DTO trong Application layer để auto-generate proxy
- Sử dụng attribute authorization ABP và hệ thống permission
- Sử dụng hệ thống localization ABP cho text tiếng Việt

### Architecture Domain Model

[Nguồn: architecture/data-models.md]
**Cấu trúc Table Entity Đơn giản hóa:**
```csharp
// aspnet-core/src/SmartRestaurant.Domain/Entities/Tables/Table.cs
public class Table : FullAuditedEntity<Guid>
{
    /// <summary>Số bàn hiển thị (ví dụ: "B01", "B02", "VIP1")</summary>
    public string TableNumber { get; set; }
    
    /// <summary>ID khu vực bố cục mà bàn này thuộc về</summary>
    public Guid LayoutSectionId { get; set; }
    
    /// <summary>Thứ tự hiển thị bàn trong khu vực</summary>
    public int DisplayOrder { get; set; }
    
    /// <summary>Trạng thái hiện tại của bàn</summary>
    public TableStatus Status { get; set; }
    
    /// <summary>ID đơn hàng hiện tại đang sử dụng bàn (nếu có)</summary>
    public Guid? CurrentOrderId { get; set; }
    
    // Navigation properties
    /// <summary>Khu vực bố cục chứa bàn này</summary>
    public virtual LayoutSection LayoutSection { get; set; }
    
    /// <summary>Đơn hàng hiện tại (nếu có)</summary>
    public virtual Order CurrentOrder { get; set; }
}

/// <summary>Trạng thái bàn ăn</summary>
public enum TableStatus
{
    /// <summary>Bàn trống, sẵn sàng phục vụ</summary>
    Available,
    
    /// <summary>Bàn đang có khách</summary>
    Occupied,
    
    /// <summary>Bàn đã được đặt trước</summary>
    Reserved,
    
    /// <summary>Bàn đang được dọn dẹp</summary>
    Cleaning
}
```

**Interface Frontend Auto-Generated:**
```typescript
// Được tạo bởi ABP CLI: src/app/proxy/tables/models.ts
export interface TableDto {
  id: string;
  tableNumber: string;
  layoutSectionId: string;
  displayOrder: number;
  status: TableStatus;
  currentOrderId?: string;
}

export interface AssignTableToSectionDto {
  layoutSectionId: string;
}

export interface UpdateTableDisplayOrderDto {
  displayOrder: number;
}

export enum TableStatus {
  Available = 0,
  Occupied = 1,
  Reserved = 2,
  Cleaning = 3
}
```

### Architecture Application Service

[Nguồn: architecture/backend-architecture.md]
**Pattern Table Application Service Đơn giản hóa:**
```csharp
// aspnet-core/src/SmartRestaurant.Application/TableManagement/Tables/TableAppService.cs
[Authorize(SmartRestaurantPermissions.TableManagement.Default)]
public class TableAppService : ApplicationService, ITableAppService
{
    private readonly ITableRepository _tableRepository;
    private readonly ILayoutSectionRepository _layoutSectionRepository;

    public TableAppService(
        ITableRepository tableRepository,
        ILayoutSectionRepository layoutSectionRepository)
    {
        _tableRepository = tableRepository;
        _layoutSectionRepository = layoutSectionRepository;
    }
    
    [Authorize(SmartRestaurantPermissions.TableManagement.AssignTableToSection)]
    public async Task AssignToSectionAsync(Guid id, AssignTableToSectionDto input)
    {
        var table = await _tableRepository.GetAsync(id);
        var section = await _layoutSectionRepository.GetAsync(input.LayoutSectionId);
        
        table.AssignToSection(input.LayoutSectionId);
        await _tableRepository.UpdateAsync(table);
    }

    [Authorize(SmartRestaurantPermissions.TableManagement.EditTableOrder)]
    public async Task UpdateDisplayOrderAsync(Guid id, UpdateTableDisplayOrderDto input)
    {
        var table = await _tableRepository.GetAsync(id);
        table.UpdateDisplayOrder(input.DisplayOrder);
        await _tableRepository.UpdateAsync(table);
    }

    public async Task<List<TableDto>> GetTablesBySectionAsync(Guid layoutSectionId)
    {
        var tables = await _tableRepository.GetTablesBySectionAsync(layoutSectionId);
        return ObjectMapper.Map<List<Table>, List<TableDto>>(tables
            .OrderBy(t => t.DisplayOrder)
            .ThenBy(t => t.TableNumber));
    }
}
```

### Architecture Frontend

[Nguồn: architecture/frontend-architecture.md]
**Cấu trúc Feature Module:**
```typescript
// angular/src/app/features/table-management/table-positioning/
├── table-layout-kanban/
│   ├── table-layout-kanban.component.ts    # Kanban layout chính với column
│   ├── table-layout-kanban.component.html  # Template kanban với drag-drop
│   ├── table-layout-kanban.component.scss  # Style kanban
│   └── table-layout-kanban.component.spec.ts # Test kanban
├── section-column/
│   ├── section-column.component.ts         # Column section riêng biệt
│   ├── section-column.component.html       # Template column
│   ├── section-column.component.scss       # Style column
│   └── section-column.component.spec.ts    # Test column
├── table-card/
│   ├── table-card.component.ts             # Card bàn riêng biệt
│   ├── table-card.component.html           # Template card bàn
│   ├── table-card.component.scss           # Style card bàn
│   └── table-card.component.spec.ts        # Test card bàn
└── services/
    └── table-kanban.service.ts             # Service logic nghiệp vụ kanban
```

**Triển khai Component Kanban Drag-Drop:**
```typescript
// table-layout-kanban.component.ts
import { Component, OnInit } from '@angular/core';
import { CdkDragDrop, moveItemInArray, transferArrayItem } from '@angular/cdk/drag-drop';
import { ComponentBase } from '@shared/base/component-base';
import { TableService } from '@proxy/table-management/tables';
import { LayoutSectionService } from '@proxy/table-management/layout-sections';

@Component({
  selector: 'app-table-layout-kanban',
  standalone: true,
  imports: [CommonModule, DragDropModule, CardModule, ButtonModule, TooltipModule],
  template: `
    <div class="kanban-board">
      <div class="board-header">
        <h2>Quản lý Bố cục Bàn</h2>
        <p-button label="Làm mới" icon="pi pi-refresh" (click)="refresh()"></p-button>
      </div>
      
      <div class="kanban-columns" cdkDropListGroup>
        <div *ngFor="let section of layoutSections" 
             class="kanban-column"
             cdkDropList
             [cdkDropListData]="sectionTables[section.id]"
             [id]="section.id"
             (cdkDropListDropped)="onTableDrop($event)">
          
          <!-- Section Header -->
          <div class="column-header">
            <h3>{{ section.sectionName }}</h3>
            <p-badge [value]="sectionTables[section.id]?.length || 0" severity="info"></p-badge>
          </div>
          
          <!-- Table Cards -->
          <div *ngFor="let table of sectionTables[section.id]" 
               class="table-card"
               cdkDrag
               [cdkDragData]="table"
               [class.occupied]="table.status === 'Occupied'"
               [class.reserved]="table.status === 'Reserved'"
               [class.cleaning]="table.status === 'Cleaning'">
            
            <p-card>
              <div class="table-info">
                <h4>{{ table.tableNumber }}</h4>
                <p-badge [value]="getStatusText(table.status)" 
                         [severity]="getStatusSeverity(table.status)"></p-badge>
              </div>
              
              <div *ngIf="table.currentOrderId" class="order-info">
                <i class="pi pi-shopping-cart"></i>
                <span>Có đơn hàng</span>
              </div>
            </p-card>
          </div>
        </div>
      </div>
    </div>
  `,
  styleUrls: ['./table-layout-kanban.component.scss']
})
export class TableLayoutKanbanComponent extends ComponentBase implements OnInit {
  layoutSections: LayoutSectionDto[] = [];
  sectionTables: { [sectionId: string]: TableDto[] } = {};
  loading = false;

  constructor(
    private tableService: TableService,
    private layoutSectionService: LayoutSectionService
  ) {
    super();
  }

  async ngOnInit(): Promise<void> {
    await this.loadLayoutSections();
    await this.loadAllTables();
  }

  onTableDrop(event: CdkDragDrop<TableDto[]>): void {
    const table = event.item.data as TableDto;
    
    if (event.previousContainer === event.container) {
      // Reorder trong cùng section
      moveItemInArray(event.container.data, event.previousIndex, event.currentIndex);
      this.updateTableDisplayOrder(table, event.currentIndex);
    } else {
      // Move giữa các section
      transferArrayItem(
        event.previousContainer.data,
        event.container.data,
        event.previousIndex,
        event.currentIndex
      );
      this.assignTableToSection(table, event.container.id, event.currentIndex);
    }
  }

  private async updateTableDisplayOrder(table: TableDto, newOrder: number): Promise<void> {
    try {
      await this.tableService.updateDisplayOrder(table.id, {
        displayOrder: newOrder
      }).toPromise();
      
      table.displayOrder = newOrder;
    } catch (error) {
      this.handleError(error, 'Không thể cập nhật thứ tự bàn');
      await this.loadAllTables(); // Revert on error
    }
  }

  private async assignTableToSection(table: TableDto, sectionId: string, newOrder: number): Promise<void> {
    try {
      await this.tableService.assignToSection(table.id, {
        layoutSectionId: sectionId
      }).toPromise();
      
      // Update local state
      table.layoutSectionId = sectionId;
      table.displayOrder = newOrder;
    } catch (error) {
      this.handleError(error, 'Không thể chuyển bàn sang khu vực khác');
      await this.loadAllTables(); // Revert on error
    }
  }

  getStatusText(status: TableStatus): string {
    const statusMap = {
      'Available': 'Khả dụng',
      'Occupied': 'Đang sử dụng', 
      'Reserved': 'Đã đặt',
      'Cleaning': 'Đang dọn'
    };
    return statusMap[status] || status;
  }

  getStatusSeverity(status: TableStatus): string {
    const severityMap = {
      'Available': 'success',
      'Occupied': 'danger',
      'Reserved': 'warning', 
      'Cleaning': 'info'
    };
    return severityMap[status] || 'secondary';
  }
}
```

### Cấu trúc Project và Vị trí File

[Nguồn: architecture/unified-project-structure.md]
**File Backend:**
```
aspnet-core/src/
├── SmartRestaurant.Domain/
│   └── Entities/Tables/
│       └── Table.cs                         # Entity domain nâng cấp
├── SmartRestaurant.Application.Contracts/
│   └── TableManagement/
│       └── Tables/
│           ├── ITableAppService.cs          # Interface service nâng cấp
│           └── Dto/
│               ├── TableDto.cs              # DTO nâng cấp
│               ├── UpdateTableDisplayOrderDto.cs # DTO cập nhật display order
│               └── AssignTableToSectionDto.cs # DTO gán section
├── SmartRestaurant.Application/
│   └── TableManagement/
│       └── Tables/
│           ├── TableAppService.cs           # Service application nâng cấp
│           └── TableAutoMapperProfile.cs    # Cấu hình AutoMapper
└── SmartRestaurant.EntityFrameworkCore/
    ├── EntityFrameworkCore/
    │   └── SmartRestaurantDbContext.cs      # Cập nhật cấu hình Table DbSet
    └── Migrations/                          # Migration mới cho định vị
```

**File Frontend:**
```
angular/src/app/
├── proxy/table-management/tables/          # Proxy ABP được tạo (cập nhật)
│   ├── table.service.ts                    # Service auto-generated (nâng cấp)
│   ├── models.ts                           # Interface TypeScript (nâng cấp)
│   └── index.ts                            # Export barrel
├── features/table-management/               # Module feature quản lý bàn
│   ├── table-positioning/                  # Component định vị kiểu kanban
│   │   ├── table-layout-kanban/            # Component kanban board chính
│   │   ├── section-column/                 # Column section riêng biệt
│   │   ├── table-card/                     # Card bàn riêng biệt
│   │   └── services/                       # Service logic nghiệp vụ kanban
│   └── table-management.routes.ts          # Routing feature nâng cấp
└── shared/components/                       # Component tái sử dụng
    └── kanban-layout/                      # Component layout kanban tái sử dụng (optional)
```

### Tích hợp ABP Authorization

### Tiêu chuẩn Kanban Nhà hàng Việt Nam
**Bố cục Section Nhà hàng Việt Nam Phổ biến:**
- Column section theo thứ tự: "Dãy 1", "Dãy 2", "Khu VIP", "Sân vườn"
- Sắp xếp bàn trong column theo DisplayOrder: bàn ưu tiên cao ở trên
- Màu sắc trạng thái bàn: Xanh (Khả dụng), Đỏ (Đang sử dụng), Vàng (Đã đặt), Xám (Đang dọn)
- Tên bàn tiêu chuẩn: "B01", "B02" (bàn thường), "VIP1", "VIP2" (bàn VIP)
- Hiển thị số lượng bàn real-time trong header column: "Dãy 1 [5 bàn]"

## Testing

[Nguồn: architecture/testing-strategy.md]
**Vị trí File Test:**
- Unit Test Backend: `test/SmartRestaurant.Application.Tests/TableManagement/Tables/TableAppService_Tests.cs`
- Unit Test Frontend: `angular/src/app/features/table-management/table-positioning/table-layout-kanban/table-layout-kanban.component.spec.ts`
- Test Tích hợp: `angular/tests/integration/table-kanban.integration.spec.ts`

**Yêu cầu Testing:**
- Test bố cục column kiểu kanban với tên section tiếng Việt
- Test kéo-thả sắp xếp lại trong cùng section sử dụng DisplayOrder
- Test kéo-thả chuyển bàn giữa các section khác nhau
- Test hiển thị trạng thái bàn và feedback trực quan trong quá trình kéo
- Test kiểm soát truy cập dựa trên permission cho quản lý section bàn
- Validate bố cục kanban responsive trên thiết bị tablet

**Tiêu chuẩn Framework Test:**
- Test Frontend: Jasmine + Karma cho unit test Angular với tiện ích test @angular/cdk/drag-drop
- Test Backend: xUnit cho unit test .NET với infrastructure test ABP
- Test E2E: Playwright cho workflow quản lý section bàn hoàn chỉnh
- Dữ liệu Mock: Cấu hình section và bàn nhà hàng Việt Nam

## Nhật ký Thay đổi

| Ngày | Phiên bản | Mô tả | Tác giả |
|------|---------|-------|---------|
| 22/08/2025 | 1.0 | Tạo câu chuyện ban đầu cho định vị bàn trong khu vực bố cục dựa trên yêu cầu Epic 2.2 | Bob (Scrum Master) |
| 22/08/2025 | 1.1 | Cập nhật file tiếng Việt với thuật ngữ kỹ thuật tiếng Anh và localization hoàn chỉnh | Sarah (Product Owner) |