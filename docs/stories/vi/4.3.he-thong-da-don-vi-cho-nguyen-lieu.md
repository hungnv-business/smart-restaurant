# User Story 4.3: Multi-Unit System for Ingredients
# Hệ thống Đa đơn vị cho Nguyên liệu

**Epic**: Epic 4 - Inventory Management (Quản lý Kho)  
**Story Points**: 8  
**Priority**: High  
**Status**: Draft  
**Assignee**: Development Team  
**Sprint**: TBD

## Story Description

**As a** inventory manager (quản lý kho),  
**I want** quản lý nguyên liệu với nhiều đơn vị mua khác nhau trong khi vẫn duy trì theo dõi bằng đơn vị cơ sở nhất quán,  
**so that** tôi có thể mua nguyên liệu theo nhiều đơn vị (boxes, cases, bulk) nhưng tồn kho vẫn được quản lý bằng đơn vị cơ sở chuẩn hóa để đảm bảo chính xác.

## Business Context

Trong thực tế nhà hàng, có **2 levels đơn vị**:

### Level 1: Base Unit (Đơn vị Cơ sở) - để track inventory
- **Bia**: ml
- **Coca**: lon  
- **Gà**: suất
- **Đậu**: cái

### Level 2: Purchase Units (Đơn vị Mua) - để mua từ supplier
- **Bia**: Bom (50000ml)
- **Coca**: Lon (1), Lốc (6 lon), Thùng (24 lon)
- **Gà**: Suất (1), Con (2 suất)  
- **Đậu**: Cái (1)

### Menu Items (Món ăn) - dùng base unit trực tiếp
- **Bia tháp**: cần 3000 ml → trừ 3000 ml từ stock
- **Coca lon**: cần 1 lon → trừ 1 lon từ stock
- **Gà suất**: cần 1 suất → trừ 1 suất từ stock
- **Đậu suất**: cần 3 cái → trừ 3 cái từ stock

## Acceptance Criteria

### AC1: Base Unit Configuration (Cấu hình Đơn vị Cơ sở)
**Given** tôi đang cấu hình nguyên liệu  
**When** thiết lập master data của nguyên liệu  
**Then** tôi phải định nghĩa chính xác 1 base unit để theo dõi tồn kho  
**And** base unit không được thay đổi sau khi đã có purchase invoice  
**And** tất cả phép tính tồn kho phải dùng base unit này  

**Examples:**
- Bia → Base unit: "ml" (không thể đổi sang "lon")  
- Thịt bò → Base unit: "kg" (không thể đổi sang "gram")  
- Coca → Base unit: "lon"  

---

### AC2: Multiple Purchase Units with Conversion Rates (Nhiều Đơn vị Mua với Tỷ lệ Chuyển đổi)
**Given** một nguyên liệu đã có base unit  
**When** tôi cấu hình purchase unit  
**Then** có thể thêm nhiều purchase unit với conversion rate sang base unit  
**And** conversion rate phải là số dương  
**And** hệ thống ngăn tham chiếu vòng lặp  

**Examples:**
```
Bia (Base: ml):
- Bom: 1 = 50000 ml

Coca (Base: lon):
- Lon: 1 = 1 lon
- Lốc: 1 = 6 lon  
- Thùng: 1 = 24 lon

Gà (Base: suất):
- Suất: 1 = 1 suất
- Con: 1 = 2 suất

Đậu (Base: cái):
- Cái: 1 = 1 cái
```

---

### AC3: Purchase Invoice Multi-Unit Support (Hỗ trợ Đa đơn vị trong Hóa đơn Mua)
**Given** tôi đang tạo purchase invoice  
**When** chọn nguyên liệu  
**Then** tôi có thể chọn bất kỳ purchase unit nào đã cấu hình cho nguyên liệu đó  
**And** hệ thống tự động chuyển đổi số lượng mua sang base unit để cập nhật tồn kho  
**And** purchase invoice lưu cả đơn vị mua ban đầu và số lượng quy đổi  

**Example Flow:**
1. Chọn nguyên liệu "Bia"  
2. Chọn purchase unit "Bom"  
3. Nhập số lượng: 2 bom  
4. Hệ thống tính: 2 × 50000 = 100000 ml (base unit)  
5. Stock tăng thêm 100000 ml, invoice hiển thị "2 bom"  

---

### AC4: Stock Display Flexibility (Hiển thị Kho Linh hoạt)
**Given** nguyên liệu có stock và nhiều purchase unit  
**When** xem tồn kho  
**Then** stock hiển thị mặc định bằng base unit  
**And** có thể toggle sang các purchase unit khác  
**And** việc quy đổi phải chính xác theo conversion ratio  

**Example Display:**
```
Bia: 100000 ml hiện có
Toggle view:
- 100000 ml (base unit)
- 2 bom (100000 ÷ 50000)

Coca: 48 lon hiện có  
Toggle view:
- 48 lon (base unit)
- 8 lốc (48 ÷ 6)
- 2 thùng (48 ÷ 24)
```

---

### AC5: Unit Conversion Validation (Xác thực Chuyển đổi Đơn vị)
**Given** tôi đang cấu hình purchase unit  
**When** nhập conversion rate  
**Then** hệ thống xác thực conversion hợp lệ  
**And** ngăn tham chiếu vòng lặp  
**And** hiển thị lỗi rõ ràng khi sai  
**And** yêu cầu xác nhận khi thay đổi conversion đã tồn tại  

**Validation Rules:**
- Conversion ratio > 0  
- Không đơn vị nào tham chiếu chính nó  
- Không vòng lặp (A→B→C→A)  
- Tối đa 10 purchase unit / nguyên liệu  
- Conversion ratio trong khoảng 0.001 – 10,000  

---

## Technical Requirements

### Backend Implementation

#### Tables Required

**1. IngredientPurchaseUnits (Table mới)**
```sql
CREATE TABLE "IngredientPurchaseUnits" (
    "Id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    "IngredientId" uuid NOT NULL REFERENCES "Ingredients"("Id"),
    "UnitId" uuid NOT NULL REFERENCES "Units"("Id"),
    "ConversionRatio" int NOT NULL CHECK (ConversionRatio > 0),
    "IsBaseUnit" boolean NOT NULL DEFAULT false,
    "IsActive" boolean NOT NULL DEFAULT true,
    -- ABP Audit fields
    "CreationTime" timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "CreatorId" uuid,
    UNIQUE("IngredientId", "UnitId")
);

-- Constraint: exactly one base unit per ingredient
CREATE UNIQUE INDEX "IX_IngredientPurchaseUnits_OneBasePerIngredient" 
ON "IngredientPurchaseUnits" ("IngredientId") 
WHERE "IsBaseUnit" = true;
```

**2. PurchaseInvoiceItems (Update existing)**
```sql
-- Thêm columns để lưu purchase unit info
ALTER TABLE "PurchaseInvoiceItems" 
ADD COLUMN "PurchaseUnitId" uuid REFERENCES "Units"("Id"),
ADD COLUMN "PurchaseQuantity" int, -- Quantity theo purchase unit
ADD COLUMN "BaseUnitQuantity" int; -- Quantity converted về base unit

-- Update existing price columns to int
ALTER TABLE "PurchaseInvoiceItems"
ALTER COLUMN "UnitPrice" TYPE int,
ALTER COLUMN "TotalPrice" TYPE int;
```

**3. MenuItem (Update existing)**
```sql
-- Thêm ingredient linking cho recipe
ALTER TABLE "MenuItems"
ADD COLUMN "PrimaryIngredientId" uuid REFERENCES "Ingredients"("Id"),
ADD COLUMN "RequiredQuantity" int; -- Quantity theo base unit

-- Update existing price column to int  
ALTER TABLE "MenuItems"
ALTER COLUMN "Price" TYPE int; -- VND không lẻ
```

#### Domain Entities

**IngredientPurchaseUnit** (Entity):
```csharp
public class IngredientPurchaseUnit : Entity<Guid>
{
    public Guid IngredientId { get; set; }
    public Guid UnitId { get; set; }
    public int ConversionRatio { get; set; }
    public bool IsBaseUnit { get; set; }
    public bool IsActive { get; set; }
    
    // Navigation properties
    public virtual Ingredient Ingredient { get; set; }
    public virtual Unit Unit { get; set; }
    
    // Business methods
    public int ConvertToBaseUnit(int quantity) => quantity * ConversionRatio;
    public int ConvertFromBaseUnit(int baseQuantity) => baseQuantity / ConversionRatio;
}
```

**Ingredient** (Enhanced):
```csharp
public class Ingredient : AggregateRoot<Guid>
{
    // Existing properties...
    
    // New navigation property
    public virtual ICollection<IngredientPurchaseUnit> PurchaseUnits { get; set; }
    
    // Business methods
    public IngredientPurchaseUnit GetBaseUnit() 
        => PurchaseUnits.First(pu => pu.IsBaseUnit);
    
    public int ConvertToBaseUnit(int quantity, Guid purchaseUnitId)
        => PurchaseUnits.First(pu => pu.UnitId == purchaseUnitId)
                        .ConvertToBaseUnit(quantity);
}
```

#### Application Services & DTOs

**Enhanced IngredientAppService** (existing service):
```csharp
public class IngredientAppService : ApplicationService
{
    // Existing methods...
    Task<IngredientDto> CreateAsync(CreateUpdateIngredientDto input);
    Task<IngredientDto> UpdateAsync(Guid id, CreateUpdateIngredientDto input);
    
    // New methods for purchase units
    Task<List<IngredientPurchaseUnitDto>> GetPurchaseUnitsAsync(Guid ingredientId);
    Task<int> ConvertQuantityAsync(Guid fromUnitId, Guid toUnitId, int quantity);
}
```

**Enhanced DTOs**:
```csharp
public class CreateUpdateIngredientDto
{
    // Existing properties
    public string Name { get; set; }
    public Guid CategoryId { get; set; }
    public string Description { get; set; }
    public int CostPerUnit { get; set; }
    public string SupplierInfo { get; set; }
    
    // New multi-unit properties
    public List<CreateUpdatePurchaseUnitDto> PurchaseUnits { get; set; } = new();
}

public class CreateUpdatePurchaseUnitDto  
{
    public Guid UnitId { get; set; }
    public int ConversionRatio { get; set; }
    public bool IsBaseUnit { get; set; }
}
```

### Frontend Implementation

#### Enhanced Ingredient Form (existing form)
**Integration vào Ingredient Form hiện có:**

**Section 1: Basic Info** (existing)
- Name, Category, Description, CostPerUnit, SupplierInfo

**Section 2: Multi-Unit Configuration** (new)
- **Units Table/Grid**:
  - Column: Unit Name (dropdown)
  - Column: Conversion Ratio (input)  
  - Column: Is Base Unit (radio/checkbox)
  - Column: Actions (delete)
- **Add Unit Button**: Thêm row mới
- **Validation**: Phải có đúng 1 base unit

**One Form Submission**: Save ingredient + purchase units cùng transaction

#### Enhanced Purchase Invoice Form  
- **Unit Dropdown**: Hiện sau khi chọn ingredient
- **Real-time Preview**: Conversion calculation
- **Validation**: Purchase unit phải belong to ingredient

---

## Examples & Use Cases

### Use Case 1: Bia Management
```
Ingredient Setup:
- Name: "Bia"
- Base Unit: ml
- Purchase Units: Bom (50000ml)

Purchase Flow:
- Mua 3 bom Bia = 3 × 50000 = 150000 ml trong stock

Menu Items:
- "Bia tháp": RequiredQuantity = 3000 ml → khi bán trừ 3000 ml
- "Bia ca": RequiredQuantity = 1300 ml → khi bán trừ 1300 ml  
- "Bia cốc": RequiredQuantity = 300 ml → khi bán trừ 300 ml

Stock Display:
- 150000 ml (base) = 3 bom (150000 ÷ 50000)
```

### Use Case 2: Coca Management  
```
Ingredient Setup:
- Name: "Coca"
- Base Unit: lon
- Purchase Units: Lon (1), Lốc (6 lon), Thùng (24 lon)

Purchase Flow:
- Mua 2 thùng Coca = 2 × 24 = 48 lon trong stock
- Mua 5 lốc Coca = 5 × 6 = 30 lon trong stock
- Tổng stock: 78 lon

Menu Items:
- "Coca lon": RequiredQuantity = 1 lon → khi bán trừ 1 lon

Stock Display:
- 78 lon (base) = 13 lốc (78 ÷ 6) = 3.25 thùng (78 ÷ 24)
```

### Use Case 3: Gà Management
```
Ingredient Setup:
- Name: "Gà"  
- Base Unit: suất
- Purchase Units: Suất (1), Con (2 suất)

Purchase Flow:
- Mua 5 con Gà = 5 × 2 = 10 suất trong stock

Menu Items:
- "Gà nướng": RequiredQuantity = 1 suất → khi bán trừ 1 suất

Stock Display:
- 10 suất (base) = 5 con (10 ÷ 2)
```

### Use Case 4: Đậu Management
```
Ingredient Setup:
- Name: "Đậu"
- Base Unit: cái  
- Purchase Units: Cái (1)

Purchase Flow:
- Mua 100 cái Đậu = 100 cái trong stock

Menu Items:
- "Đậu suất": RequiredQuantity = 3 cái → khi bán trừ 3 cái

Stock Display:
- 100 cái (base)
```

---

## Dependencies

### Prerequisites
- ✅ Story 4.1: Ingredient Category Management (completed)
- ✅ Story 4.2: Purchase Invoice & Stock-In Management (completed)
- Unit Management system (existing)

### Integration Points
- **Purchase Invoice**: Hỗ trợ chọn đơn vị và quy đổi
- **Stock Tracking**: Tính toán tồn kho theo base unit
- **Inventory Reports**: Hiển thị nhiều đơn vị
- **Future Stories**: Nền tảng cho recipe management (Story 4.4)

---

## Risks & Considerations

### Technical Risks
1. **Data Migration**: Nguyên liệu cũ cần gán base unit
2. **Conversion Accuracy**: Độ chính xác số thập phân
3. **Performance**: Tăng join khi lookup unit
4. **Validation Complexity**: Tránh cấu hình sai

### Business Risks
1. **User Training**: Người dùng phải hiểu multi-unit
2. **Configuration Errors**: Sai conversion ratio gây sai lệch stock
3. **Supplier Compatibility**: Đơn vị mua phải khớp nhà cung cấp

### Mitigation Strategies
1. **Migration Script**: Gán tự động UnitId làm base unit
2. **Validation Rules**: Kiểm tra chặt chẽ conversion ratio
3. **User Training**: Có tài liệu hướng dẫn
4. **Rollback Plan**: Cho phép tắt multi-unit với nguyên liệu cụ thể

---

## Testing Strategy

### Unit Tests
- Kiểm tra độ chính xác conversion  
- Kiểm tra validation business rules  
- Quản lý state của entity  

### Integration Tests  
- Purchase invoice với multi-unit  
- Stock tracking với conversion  
- Kiểm tra API endpoint  

### User Acceptance Tests
- Thực hiện toàn bộ luồng mua hàng với nhiều đơn vị  
- Hiển thị tồn kho chính xác khi toggle  
- Quản lý cấu hình bởi inventory manager  

---

## Implementation Tasks

### Nhiệm vụ Backend
- [ ] **BE-1**: Tạo entity IngredientPurchaseUnit với kiểu dữ liệu int
- [ ] **BE-2**: Cải tiến entity Ingredient với navigation property PurchaseUnits
- [ ] **BE-3**: Tạo migration database cho bảng IngredientPurchaseUnits
- [ ] **BE-4**: Cập nhật PurchaseInvoiceItems với các cột PurchaseUnitId, PurchaseQuantity, BaseUnitQuantity
- [ ] **BE-5**: Cập nhật MenuItem với các cột PrimaryIngredientId, RequiredQuantity  
- [ ] **BE-6**: Cải tiến IngredientAppService với các phương thức quản lý đơn vị mua
- [ ] **BE-7**: Cập nhật CreateUpdateIngredientDto với thuộc tính danh sách PurchaseUnits

### Nhiệm vụ Frontend
- [ ] **FE-1**: Cải tiến Form Nguyên liệu với phần Cấu hình Đa đơn vị
- [ ] **FE-2**: Thêm bảng Units với các cột: Đơn vị, Tỷ lệ quy đổi, Đơn vị cơ sở, Thao tác
- [ ] **FE-3**: Cải tiến Form Hóa đơn mua với dropdown chọn đơn vị
- [ ] **FE-4**: Triển khai xem trước quy đổi thời gian thực trong form mua hàng
- [ ] **FE-5**: Cập nhật component hiển thị tồn kho với chức năng chuyển đổi đơn vị

### Nhiệm vụ Testing
- [ ] **TEST-1**: Kiểm thử đơn vị cho các phép tính quy đổi với kiểu int
- [ ] **TEST-2**: Kiểm thử tích hợp cho việc tạo nguyên liệu với đơn vị mua
- [ ] **TEST-3**: Kiểm thử chấp nhận người dùng cho quy trình mua hàng hoàn chỉnh với đa đơn vị

### Nhiệm vụ Tài liệu
- [ ] **DOC-1**: Cập nhật tài liệu API với các endpoint mới
- [ ] **DOC-2**: Hướng dẫn người dùng cho cấu hình đa đơn vị trong form nguyên liệu
- [ ] **DOC-3**: Tài liệu schema database cho các bảng/cột mới

## Tiêu chí Hoàn thành
- [ ] Tất cả nhiệm vụ Backend hoàn thành và đã kiểm thử
- [ ] Tất cả nhiệm vụ Frontend hoàn thành với thiết kế responsive
- [ ] Độ bao phủ kiểm thử đơn vị ≥ 90% cho chức năng mới
- [ ] Kiểm thử tích hợp thành công cho các quy trình hoàn chỉnh
- [ ] Kiểm thử chấp nhận người dùng hoàn thành với các bên liên quan kinh doanh
- [ ] Tài liệu được cập nhật và đã xem xét

---

**Created**: 2025-09-01  
**Last Updated**: 2025-09-01  
**Version**: 1.0
