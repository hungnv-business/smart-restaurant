# Story 4.2: Quản lý Hóa đơn Mua & Nhập kho

## Thông tin Template

### Cấp độ Template
Cấp 1

### Phân tích Độ phức tạp
Kết quả phân tích từ template-level-analyzer (cập nhật sau khi đơn giản hóa):
- **Độ phức tạp Entity:** Đơn giản - PurchaseInvoice có basic properties với logic tính toán đơn giản (TotalPrice), chỉ cần standard CRUD operations
- **Độ phức tạp UI:** Cơ bản - Chỉ cần List + Dialog form với các text inputs và number inputs
- **Yêu cầu Kỹ thuật:** Standard CRUD - ICrudAppService với override đơn giản cho calculation và stock update

**Tham chiếu Template:**
- Template Backend: [backend-template-level1.md](../../.bmad-core/templates/backend-template-level1.md)
- Template Frontend: [frontend-template-level1.md](../../.bmad-core/templates/frontend-template-level1.md)

**Ước tính Story Points:** 20-30 điểm

## Trạng thái
Hoàn thành

## Câu chuyện Yêu cầu

**Với vai trò** quản lý mua hàng,  
**Tôi muốn** tạo và quản lý hóa đơn mua với theo dõi nhập kho chi tiết,  
**Để** tất cả giao dịch mua được ghi nhận phục vụ tính toán chi phí, trừ kho tự động và cảnh báo tồn kho.

## Tiêu chí Chấp nhận

1. Tạo hóa đơn mua với chọn nguyên liệu, số lượng và giá cả
2. Ghi nhận nhập kho với ngày mua, nhà cung cấp và theo dõi tổng chi phí
3. Tích hợp với tính toán chi phí cho báo cáo tài chính
4. Cập nhật mức tồn kho tự động khi xác nhận nhập kho
5. Nền tảng cho trừ kho tự động khi xử lý đơn hàng

## Ghi chú Phát triển

### Kinh nghiệm từ Story trước
Từ Story 4.1: Quản lý Danh mục Nguyên liệu đã hoàn thành thành công với:
- Đã thiết lập entities DanhMucNguyenLieu và NguyenLieu với các thao tác CRUD chuẩn
- Đã triển khai quy ước đặt tên tiếng Việt và dữ liệu mẫu
- Đã thiết lập theo dõi chi phí cơ bản (CostPerUnit nullable) và liên kết thông tin nhà cung cấp
- Nền tảng hệ thống quản lý kho đã sẵn sàng cho tích hợp logic nghiệp vụ

### Mô hình Dữ liệu
**Entity PurchaseInvoice** (Header - Thông tin chung hóa đơn):
- InvoiceNumber (string)
- SupplierName (string, nhập tự do)  
- InvoiceDate (DateTime)
- TotalAmount (int, tổng tiền của tất cả items)
- Notes (string, nullable, ghi chú chung)
- CreatedBy, ModifiedBy, CreationTime, LastModificationTime (trường audit ABP)
- IsDeleted (hỗ trợ soft delete)

**Entity PurchaseInvoiceItem** (Detail - Chi tiết từng nguyên liệu):
- PurchaseInvoiceId (Guid, foreign key)
- IngredientId (Guid, nullable, chọn từ Ingredient có sẵn cho nguyên liệu chính)
- IngredientName (string, có thể lấy từ Ingredient.Name hoặc nhập tự do cho thứ nhỏ lẻ)
- Quantity (int, số lượng)
- UnitId (Guid, nullable, chọn từ Unit có sẵn)
- UnitName (string, lấy từ Unit.Name để display)
- UnitPrice (int, nullable, giá đơn vị)
- TotalPrice (int, có thể tính toán hoặc nhập trực tiếp)
- CreatedBy, ModifiedBy, CreationTime, LastModificationTime (trường audit ABP)
- IsDeleted (hỗ trợ soft delete)

**Cần cập nhật Ingredient entity từ Story 4.1**: Thêm field `CurrentStock` (int, mặc định = 0)

**Logic cập nhật kho**: 
- **Nếu PurchaseInvoiceItem có IngredientId** (nguyên liệu chính): Tìm Ingredient → tăng CurrentStock lên Quantity
- **Nếu không có IngredientId** (thứ nhỏ lẻ): Chỉ lưu để tính chi phí, không ảnh hưởng kho

### Code Entity

**PurchaseInvoice.cs** (Header):
```csharp
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using Volo.Abp.Domain.Entities.Auditing;

namespace SmartRestaurant.Inventory
{
    public class PurchaseInvoice : FullAuditedAggregateRoot<Guid>
    {
        [Required]
        [MaxLength(50)]
        public string InvoiceNumber { get; set; } = string.Empty;
        
        [Required]
        [MaxLength(200)]
        public string SupplierName { get; set; } = string.Empty;
        
        [Required]
        public DateTime InvoiceDate { get; set; }
        
        [Required]
        public int TotalAmount { get; private set; } // Tổng tiền tự động tính từ Items
        
        [MaxLength(500)]
        public string? Notes { get; set; };

        // Navigation property
        public virtual ICollection<PurchaseInvoiceItem> Items { get; set; } = new List<PurchaseInvoiceItem>();

        protected PurchaseInvoice()
        {
        }

        public PurchaseInvoice(
            Guid id,
            string invoiceNumber,
            string supplierName,
            DateTime invoiceDate,
            string? notes = null) : base(id)
        {
            InvoiceNumber = invoiceNumber;
            SupplierName = supplierName;
            InvoiceDate = invoiceDate;
            Notes = notes;
            TotalAmount = 0; // Sẽ tính từ Items
        }

        public void CalculateTotalAmount()
        {
            TotalAmount = Items.Sum(item => item.TotalPrice);
        }
    }
}
```

**PurchaseInvoiceItem.cs** (Detail):
```csharp
using System;
using System.ComponentModel.DataAnnotations;
using Volo.Abp.Domain.Entities.Auditing;

namespace SmartRestaurant.Inventory
{
    public class PurchaseInvoiceItem : FullAuditedEntity<Guid>
    {
        [Required]
        public Guid PurchaseInvoiceId { get; set; }
        
        public Guid? IngredientId { get; set; } // Nullable - chỉ cho nguyên liệu chính
        
        [Required]
        [MaxLength(200)]
        public string IngredientName { get; set; } = string.Empty; // Auto-populated từ Ingredient hoặc nhập tự do
        
        [Required]
        public int Quantity { get; set; }
        
        public Guid? UnitId { get; set; } // Nullable - chọn từ Unit
        
        [Required]
        [MaxLength(50)]
        public string UnitName { get; set; } = string.Empty; // Auto-populated từ Unit
        
        public int? UnitPrice { get; set; } // Nullable - có thể bỏ trống
        
        [Required]
        public int TotalPrice { get; set; } // Tính toán hoặc nhập trực tiếp

        // Navigation property
        public virtual PurchaseInvoice PurchaseInvoice { get; set; } = null!;

        protected PurchaseInvoiceItem()
        {
        }

        public PurchaseInvoiceItem(
            Guid id,
            Guid purchaseInvoiceId,
            string ingredientName,
            int quantity,
            string unitName,
            Guid? ingredientId = null,
            Guid? unitId = null,
            int? unitPrice = null,
            int? totalPrice = null) : base(id)
        {
            PurchaseInvoiceId = purchaseInvoiceId;
            IngredientId = ingredientId;
            IngredientName = ingredientName;
            Quantity = quantity;
            UnitId = unitId;
            UnitName = unitName;
            UnitPrice = unitPrice;
            TotalPrice = totalPrice ?? (unitPrice.HasValue ? quantity * unitPrice.Value : 0);
        }
    }
}
```

**Cập nhật Ingredient.cs** (thêm CurrentStock):
```csharp
// Thêm property này vào Ingredient entity hiện có từ Story 4.1
[Required]
public decimal CurrentStock { get; set; } = 0; // Số lượng hiện tại trong kho
```

### Application Service Logic

**PurchaseInvoiceAppService**: Tham khảo MenuItemAppService pattern
```csharp
public class PurchaseInvoiceAppService : 
    CrudAppService<
        PurchaseInvoice,                      // Domain Entity
        PurchaseInvoiceDto,                   // Output DTO  
        Guid,                                // Primary Key Type
        PagedAndSortedResultRequestDto,       // GetList Input
        CreateUpdatePurchaseInvoiceDto>,      // Create/Update Input DTO
    IPurchaseInvoiceAppService
{
    // Dependency injection cho Ingredient, Unit repositories
    // Override CreateAsync(): Cascading insert master-detail qua Entity Framework navigation properties
    // Override GetAsync(): Sử dụng .Include(x => x.Items) để load Items collection
    // Override GetListAsync(): Include Items nếu cần hiển thị summary
    // Business validation: ValidateIngredientExists, ValidateUnitExists
}
```

### Code DTOs

**CreatePurchaseInvoiceDto.cs** (Master-Detail):
```csharp
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;

namespace SmartRestaurant.Inventory
{
    public class CreatePurchaseInvoiceDto
    {
        [Required]
        [MaxLength(50)]
        public string InvoiceNumber { get; set; } = string.Empty;
        
        [Required]
        [MaxLength(200)]
        public string SupplierName { get; set; } = string.Empty;
        
        [Required]
        public DateTime InvoiceDate { get; set; }
        
        [MaxLength(500)]
        public string? Notes { get; set; }
        
        [Required]
        public List<CreatePurchaseInvoiceItemDto> Items { get; set; } = new();
    }

    public class CreatePurchaseInvoiceItemDto
    {
        public Guid? IngredientId { get; set; } // Nullable - chỉ cho nguyên liệu chính
        
        [Required]
        [MaxLength(200)]
        public string IngredientName { get; set; } = string.Empty; // Auto-fill hoặc nhập tự do
        
        [Required]
        public int Quantity { get; set; }
        
        public Guid? UnitId { get; set; } // Nullable - chọn từ Unit
        
        [Required]
        [MaxLength(50)]
        public string UnitName { get; set; } = string.Empty; // Auto-fill từ Unit
        
        public int? UnitPrice { get; set; } // Optional
        
        public int? TotalPrice { get; set; } // Optional - sẽ tính hoặc nhập
    }
}
```

**PurchaseInvoiceDto.cs** (Master-Detail):
```csharp
using System;
using System.Collections.Generic;
using Volo.Abp.Application.Dtos;

namespace SmartRestaurant.Inventory  
{
    public class PurchaseInvoiceDto : FullAuditedEntityDto<Guid>
    {
        public string InvoiceNumber { get; set; } = string.Empty;
        public string SupplierName { get; set; } = string.Empty;
        public DateTime InvoiceDate { get; set; }
        public int TotalAmount { get; set; }
        public string? Notes { get; set; }
        public List<PurchaseInvoiceItemDto> Items { get; set; } = new();
    }

    public class PurchaseInvoiceItemDto : FullAuditedEntityDto<Guid>
    {
        public Guid PurchaseInvoiceId { get; set; }
        public Guid? IngredientId { get; set; }
        public string IngredientName { get; set; } = string.Empty;
        public decimal Quantity { get; set; }
        public string Unit { get; set; } = string.Empty;
        public decimal? UnitPrice { get; set; }
        public decimal TotalPrice { get; set; }
    }
}
```

**Các Endpoint REST Tự động tạo**: [Nguồn: architecture/backend-architecture.md#ABPAutoAPI]
- POST /api/app/purchase-invoice (Tạo)
- PUT /api/app/purchase-invoice/{id} (Cập nhật)
- GET /api/app/purchase-invoice/{id} (Lấy theo ID)
- GET /api/app/purchase-invoice (Danh sách có lọc)
- DELETE /api/app/purchase-invoice/{id} (Xóa mềm)

### Thông số Component
**Vị trí Frontend**: [Nguồn: architecture/unified-project-structure.md]
- Module chính: `angular/src/app/features/inventory/purchase-invoice-management/`
- Components theo mẫu PrimeNG Poseidon theme
- CRUD đơn giản với table và dialog

**Các UI Component chính**: [Nguồn: Master-Detail pattern với Level 1 base]
- `purchase-invoice-list.component.ts` - Danh sách với p-table và tìm kiếm
- `purchase-invoice-dialog.component.ts` - Dialog form Master-Detail với:
  * **Header section**: Text inputs cho InvoiceNumber, SupplierName, InvoiceDate, Notes
  * **Detail section**: p-table cho Items list với:
    - Add/Remove item buttons
    - Inline editing cho mỗi item
    - Dropdown chọn Ingredient (nullable) hoặc text input IngredientName
    - Auto-fill IngredientName/Unit khi chọn Ingredient  
    - Number inputs: Quantity, UnitPrice (nullable), TotalPrice
    - 2 cách nhập giá cho mỗi item
  * **Footer**: Display TotalAmount tự động tính từ tất cả Items

### Vị trí File
**File Backend**: [Nguồn: architecture/unified-project-structure.md]
```
aspnet-core/src/SmartRestaurant.Domain/
├── Inventory/
│   ├── PurchaseInvoice.cs
│   └── PurchaseInvoiceItem.cs

aspnet-core/src/SmartRestaurant.Application.Contracts/
├── Inventory/
│   ├── CreatePurchaseInvoiceDto.cs
│   ├── UpdatePurchaseInvoiceDto.cs
│   ├── PurchaseInvoiceDto.cs
│   └── IPurchaseInvoiceAppService.cs

aspnet-core/src/SmartRestaurant.Application/
├── Inventory/
│   └── PurchaseInvoiceAppService.cs
```

**File Frontend**: [Nguồn: architecture/unified-project-structure.md]
```
angular/src/app/features/inventory/
├── purchase-invoice-management/
│   ├── purchase-invoice-list/
│   └── purchase-invoice-dialog/
├── models/
│   └── purchase-invoice.models.ts
└── services/
    └── purchase-invoice.service.ts
```

### Yêu cầu Kiểm thử
**Chiến lược Kiểm thử Backend**: [Nguồn: nguyên tắc architecture/testing-strategy.md]
- Unit test domain service cho logic nghiệp vụ (tính toán chi phí, chuyển trạng thái)
- Integration test application service cho quy trình hoàn chỉnh
- Repository test cho quan hệ entity và ràng buộc
- Kiểm thử validation quy tắc nghiệp vụ

**Chiến lược Kiểm thử Frontend**: [Nguồn: nguyên tắc architecture/testing-strategy.md]  
- Unit test component cho validation form và logic UI
- Integration test cho quy trình nhiều bước
- E2E test cho quy trình hoàn chỉnh từ mua hàng đến nhập kho
- Kiểm thử dữ liệu tiếng Việt với nguyên liệu mẫu từ Story 4.1

### Ràng buộc Kỹ thuật
**Yêu cầu ABP Framework**: [Nguồn: architecture/tech-stack.md + architecture/backend-architecture.md]
- Sử dụng mẫu ICrudAppService cho CRUD đơn giản với custom override
- Override CreateAsync/UpdateAsync cho logic cập nhật stock
- Tuân theo mẫu audit logging của ABP
- Sử dụng khả năng soft delete của ABP
- Cấu hình Entity Framework relationships với Ingredient

**Cân nhắc Hiệu suất**: [Nguồn: architecture/tech-stack.md]
- Index database trên InvoiceNumber, InvoiceDate, IngredientId
- Performance consideration cho việc update CurrentStock

**Yêu cầu Bảo mật**: [Nguồn: architecture/backend-architecture.md#Authorization]
- Phân quyền theo vai trò: PurchaseManager, InventoryStaff
- Định nghĩa permission: PurchaseInvoice.Create, PurchaseInvoice.Update, PurchaseInvoice.Delete
- Audit trail cho các giao dịch mua hàng

## Công việc / Công việc con

### Backend Development

- [ ] **Tham khảo Code Pattern từ Menu Management** (TC: 1, 2, 3, 4, 5)
  - [ ] Đọc và phân tích MenuItemAppService implementation từ Story 3.2 hoàn thành
  - [ ] Tham khảo Entity relationships pattern giữa MenuItem và MenuCategory
  - [ ] Học AutoMapper configuration và DTOs mapping pattern
  - [ ] Tham khảo permission configuration và API controller setup
  - [ ] Apply cùng pattern cho PurchaseInvoice Master-Detail implementation

- [ ] **Tạo PurchaseInvoice & PurchaseInvoiceItem Domain Entities** (TC: 1, 2)
  - [ ] Định nghĩa PurchaseInvoice entity với TotalAmount private set và method CalculateTotalAmount()
  - [ ] Định nghĩa PurchaseInvoiceItem entity với navigation property đến PurchaseInvoice
  - [ ] Thêm cả 2 entities vào SmartRestaurantDbContext với relationships
  - [ ] Tạo database migration cho cả 2 entities với foreign keys
  - [ ] Cấu hình Entity Framework relationships (PurchaseInvoice.Items collection)

- [ ] **Cập nhật Ingredient Entity** (TC: 4, 5)  
  - [ ] Thêm field CurrentStock (int, mặc định = 0) vào Ingredient entity
  - [ ] Tạo database migration để thêm cột CurrentStock
  - [ ] Cập nhật existing ingredients với CurrentStock = 0

- [ ] **Triển khai PurchaseInvoice Application Layer** (TC: 1, 2, 3, 4, 5)
  - [ ] Tạo PurchaseInvoiceAppService kế thừa từ ICrudAppService theo pattern MenuItemAppService
  - [ ] Định nghĩa CreateUpdatePurchaseInvoiceDto với nested Items collection
  - [ ] Override CreateAsync(): Cascading insert master-detail + cập nhật CurrentStock + gọi CalculateTotalAmount()
  - [ ] Override UpdateAsync(): Điều chỉnh CurrentStock và tính lại TotalAmount
  - [ ] Override GetAsync() và GetListAsync(): Sử dụng .Include(x => x.Items)
  - [ ] Thêm AutoMapper profiles cho nested DTOs

- [ ] **Cấu hình PurchaseInvoice API Endpoints** (TC: 1, 2, 3)
  - [ ] Auto-generated REST endpoints qua ICrudAppService
  - [ ] Cấu hình API permissions và authorization policies  
  - [ ] Thêm API documentation và Swagger annotations
  - [ ] Test API endpoints bằng Swagger UI với Master-Detail data

- [ ] **Tạo PurchaseInvoice Integration Tests** (TC: 1, 2, 4, 5)
  - [ ] Test cascading insert master-detail operation
  - [ ] Test Include navigation properties trong Get operations
  - [ ] Test logic tính toán TotalAmount tự động
  - [ ] Test logic cập nhật CurrentStock của Ingredient  
  - [ ] Test authorization và permission requirements
  - [ ] Verify database relationships và constraints

### Frontend Development

- [ ] **Tham khảo Code Pattern từ Menu Item Management Frontend** (TC: 1, 2, 3, 4)
  - [ ] Đọc và phân tích menu-item-list component implementation từ Story 3.2
  - [ ] Tham khảo menu-item-form component với dropdown selection pattern
  - [ ] Học dialog service pattern và responsive breakpoints configuration  
  - [ ] Tham khảo routing setup và breadcrumb navigation Vietnamese text
  - [ ] Apply cùng pattern cho PurchaseInvoice Master-Detail UI implementation

- [ ] **Tạo Angular Service Proxies** (TC: 1, 2, 3)
  - [ ] Chạy lệnh 'abp generate-proxy -t ng -u https://localhost:44346'
  - [ ] Verify generated PurchaseInvoiceService và DTOs
  - [ ] Test proxy service methods trong browser console

- [ ] **Tạo PurchaseInvoice List Component** (TC: 1, 2, 3)
  - [ ] Generate component: `angular/src/app/features/inventory/purchase-invoice-management/purchase-invoice-list/`
  - [ ] Triển khai PrimeNG p-table với columns cho entity properties
  - [ ] Thêm search functionality với global filtering
  - [ ] Thêm CRUD action buttons (Tạo, Sửa, Xóa) với icons
  - [ ] Triển khai confirmation dialog cho delete operations

- [ ] **Tạo PurchaseInvoice Form Component** (TC: 1, 2, 4)
  - [ ] Generate component: `angular/src/app/features/inventory/purchase-invoice-management/purchase-invoice-dialog/`
  - [ ] Xây dựng reactive form với FormBuilder và validation
  - [ ] Thêm form fields:
    * Text inputs: InvoiceNumber, SupplierName, Notes
    * p-dropdown cho Ingredient selection (load từ IngredientAppService)
    * Read-only displays: IngredientName, Unit (auto-fill)
    * Number inputs: Quantity, UnitPrice (nullable), TotalPrice
    * Logic tính toán TotalPrice động
  - [ ] Triển khai form submission logic cho create và update
  - [ ] Thêm loading states và error handling

- [ ] **Triển khai PurchaseInvoice Dialog Service** (TC: 1, 2)
  - [ ] Tạo PurchaseInvoiceFormDialogService cho dialog management
  - [ ] Triển khai openCreateDialog() method
  - [ ] Triển khai openEditDialog(id) method với data loading
  - [ ] Cấu hình dialog responsive breakpoints
  - [ ] Handle dialog result callbacks và data refresh

- [ ] **Thêm Route Configuration** (TC: 1, 3)
  - [ ] Định nghĩa routes trong purchase-invoices.routes.ts
  - [ ] Thêm lazy-loaded route vào main routing module
  - [ ] Cấu hình breadcrumb navigation với Vietnamese text
  - [ ] Thêm route guards nếu cần authorization

- [ ] **Tạo Frontend Integration Tests** (TC: 1, 2, 4)
  - [ ] Viết component rendering tests với TestBed
  - [ ] Test user interactions (click, form input, search, ingredient selection)
  - [ ] Mock service dependencies và test API calls
  - [ ] Test error handling và loading states
  - [ ] Test logic tính toán TotalPrice trong form

### Testing & Documentation

- [ ] **Cập nhật Documentation** (TC: 3)
  - [ ] Document entity properties và validation rules
  - [ ] Thêm API endpoint documentation
  - [ ] Document UI component usage và features
  - [ ] Cập nhật project README với functionality mới

- [ ] **Deploy vào Development Environment** (TC: 4, 5)
  - [ ] Chạy database migrations trên dev environment
  - [ ] Deploy backend API changes
  - [ ] Deploy frontend changes
  - [ ] Verify end-to-end functionality trong dev environment với Ingredient data từ Story 4.1

## Định nghĩa Hoàn thành
- [ ] Tất cả tiêu chí chấp nhận đã được triển khai và kiểm thử
- [ ] PurchaseInvoice CRUD operations hoạt động với ICrudAppService pattern
- [ ] Logic tự động cập nhật CurrentStock hoạt động chính xác
- [ ] UI đơn giản với table + dialog được triển khai với bản địa hóa tiếng Việt
- [ ] Ingredient dropdown selection hoạt động và auto-fill IngredientName/Unit
- [ ] Logic tính toán TotalPrice hoạt động cho cả 2 cách (UnitPrice*Quantity và nhập trực tiếp)
- [ ] Database migrations được áp dụng và kiểm thử
- [ ] Integration tests pass cho CRUD operations và stock update logic
- [ ] Code review hoàn thành và được phê duyệt
- [ ] Tính năng được kiểm thử trong môi trường phát triển với dữ liệu Ingredient từ Story 4.1

## Ghi chú
Story này thiết lập hệ thống Purchase Invoice đơn giản với tự động cập nhật CurrentStock cho Ingredient. Sử dụng ICrudAppService pattern với custom override cho business logic. UI đơn giản với PrimeNG table + dialog, có dropdown selection cho Ingredient và flexible pricing (UnitPrice calculation hoặc direct TotalPrice input). Foundation này sẽ hỗ trợ inventory tracking và cost management cho nhà hàng.