# Câu chuyện 1.1: Thiết lập Cấu trúc Dự án & Môi trường Phát triển

## Trạng thái
Hoàn thành

## Câu chuyện
**Với tư cách** một lập trình viên,  
**Tôi muốn** thiết lập cấu trúc dự án ABP Framework với cấu hình phù hợp,  
**Để** quá trình phát triển có thể tiến hành hiệu quả với đầy đủ các công cụ cần thiết.

## Tiêu chí Chấp nhận
1. Tạo xong giải pháp ABP Framework với template .NET 8 và Angular 19
2. Cấu hình kết nối cơ sở dữ liệu PostgreSQL với collation tiếng Việt
3. Hoàn thành thiết lập containerization Docker với docker-compose
4. Tài liệu hóa môi trường phát triển trong CLAUDE.md
5. Cấu hình pipeline CI/CD ban đầu với các giai đoạn build và test cơ bản

## Nhiệm vụ / Nhiệm vụ con

- [x] Thiết lập Giải pháp ABP Framework (TC: 1)
  - [x] Tạo giải pháp ABP Framework mới với lệnh CLI: `abp new SmartRestaurant -t app --ui angular --mobile none --database-provider ef --database-management-system postgresql --connection-string "User ID=postgres;Password=postgres;Host=localhost;Port=5432;Database=SmartRestaurant;"`
  - [x] Đọc lại cấu trúc source code rồi cập nhật các file cần thiết
  - [x] Chạy `abp install-libs` trong project HttpApi.Host để cài đặt các thư viện frontend cần thiết

- [x] Cấu hình Cơ sở Dữ liệu PostgreSQL (TC: 2)
  - [x] Cấu hình appsettings.json trong project SmartRestaurant.DbMigrator với chuỗi kết nối PostgreSQL
  - [x] Chạy project SmartRestaurant.DbMigrator để tạo database
  - [x] Thiết lập collation tiếng Việt trong cấu hình cơ sở dữ liệu để hỗ trợ tìm kiếm văn bản
  - [x] Cập nhật cấu hình Entity Framework Core để sử dụng PostgreSQL provider
  - [x] Kiểm tra kết nối cơ sở dữ liệu và đảm bảo collation văn bản tiếng Việt hoạt động đúng

- [x] Thiết lập Môi trường Docker (TC: 3)
  - [x] Tạo docker-compose.dev.yml với PostgreSQL, in-memory cache và các dịch vụ ứng dụng
  - [x] Tạo docker-compose.prod.yml để triển khai production trên VPS
  - [x] Cấu hình Dockerfile.api để đóng gói backend .NET 8
  - [x] Cấu hình Dockerfile.web để đóng gói Angular 19 frontend với Nginx
  - [x] Thêm nginx.conf để cấu hình reverse proxy

- [x] Tài liệu Môi trường Phát triển (TC: 4)
  - [x] Cập nhật CLAUDE.md, architecture.md, unified-project-structure.md với các lệnh và vị trí file cụ thể của ABP Framework
  - [x] Cập nhật các đường dẫn từ src/SmartRestaurant.* thành aspnet-core/src/SmartRestaurant.* cho các file có đường dẫn cũ
  - [x] Tài liệu hóa quy trình phát triển bao gồm tạo proxy và cài đặt thư viện
  - [x] Thêm phần khắc phục sự cố cho các vấn đề thường gặp của ABP và PostgreSQL
  - [x] Tài liệu hóa cấu hình và thiết lập cụ thể cho nhà hàng Việt Nam

- [x] Cấu hình Pipeline CI/CD (TC: 5)
  - [x] Tạo .github/workflows/ci.yaml để tự động hóa build và test
  - [x] Tạo .github/workflows/deploy.yaml cho pipeline triển khai VPS
  - [x] Cấu hình các giai đoạn build cho cả backend .NET và frontend Angular
  - [x] Thiết lập thực thi kiểm thử tự động với cơ sở dữ liệu test PostgreSQL phù hợp

## Ghi chú Phát triển

### Tham chiếu Nền tảng Kiến trúc

**Cấu hình Ngăn xếp Công nghệ [Nguồn: architecture/tech-stack.md]:**
- .NET 8 với C# 12.0 cho phát triển backend với ABP Framework 8.0
- Angular 19.x với TypeScript 5.0+ cho frontend với các component PrimeNG 17.x
- PostgreSQL 14+ làm cơ sở dữ liệu chính với hỗ trợ tìm kiếm văn bản tiếng Việt
- in-memory cache 7.0+ cho session và performance caching
- Docker Compose cho infrastructure as code và triển khai VPS

**Yêu cầu Cấu trúc Dự án [Nguồn: architecture/unified-project-structure.md]:**
- Root level: aspnet-core/ (ABP backend), angular/ (Angular 19), flutter_mobile/ (Flutter app), infrastructure/ (Docker)
- Cấu trúc Layer ABP: Domain, Application, EntityFrameworkCore, HttpApi, HttpApi.Host
- Cấu trúc Angular: app/ (components), layout/ (Poseidon theme components), assets/ (demo + layout)
- Script Package.json cho ABP workflow: dev, dev:mobile, generate-proxy, install-libs, migrate, test

**Các Lệnh ABP CLI để Thiết lập Dự án:**
- Cài đặt ABP CLI: `dotnet tool install -g Volo.Abp.Cli`
- Tạo project: `abp new SmartRestaurant -t app --ui angular --mobile none --database-provider ef --database-management-system postgresql --connection-string "User ID=postgres;Password=postgres;Host=localhost;Port=5432;Database=SmartRestaurant;"`
- Tạo Angular proxies: `cd angular && abp generate-proxy -t ng -u https://localhost:44346`
- Cài đặt thư viện frontend: `cd angular && abp install-libs`
- Chạy database migrator: `cd aspnet-core && dotnet run --project src/SmartRestaurant.DbMigrator`

**Quy tắc Phát triển ABP Quan trọng [Nguồn: architecture/coding-standards.md]:**
- Luôn sử dụng các base class của ABP cho entities (FullAuditedEntity, v.v.) - không bao giờ tạo POCO
- Sử dụng proxy generation của ABP cho frontend types - không bao giờ tạo TypeScript interfaces thủ công
- Luôn sử dụng các service proxy tự động tạo của ABP - không bao giờ thực hiện HTTP call trực tiếp
- Implement IApplicationService để tự động tạo API - không bao giờ tạo controller thủ công
- Sử dụng hệ thống localization của ABP cho văn bản tiếng Việt - không bao giờ hardcode chuỗi tiếng Việt

**Yêu cầu Cấu hình Cơ sở Dữ liệu:**
- PostgreSQL với collation tiếng Việt để sắp xếp và tìm kiếm văn bản đúng cách
- Entity Framework Core Code-First với conventions ABP
- Cấu hình connection string trong appsettings.json cho development và production
- Index tìm kiếm văn bản tiếng Việt cho món ăn và dữ liệu khách hàng

**Kiến trúc Triển khai Docker:**
- Development: docker-compose.dev.yml với PostgreSQL và in-memory cache local
- Production: docker-compose.prod.yml tối ưu cho triển khai VPS
- Nginx reverse proxy để serve Angular frontend và routing API
- Quản lý chứng chỉ SSL tự động với Let's Encrypt cho production

### Kiểm thử

**Vị trí File Kiểm thử [Nguồn: architecture/testing-strategy.md]:**
- Backend Tests: `test/SmartRestaurant.Domain.Tests/`, `test/SmartRestaurant.Application.Tests/`, `test/SmartRestaurant.HttpApi.Tests/`
- Frontend Tests: `angular/tests/unit/`, `angular/tests/integration/`, `angular/tests/e2e/`
- Test Framework: xUnit + Moq cho .NET backend, Jasmine + Karma cho Angular frontend

**Yêu cầu Kiểm thử cho Câu chuyện này:**
- Backend: Xác minh các ABP application service tạo đúng và kết nối database hoạt động
- Frontend: Test ABP proxy generation và tích hợp Angular service
- Integration: Xác minh giao tiếp full stack giữa Angular và ABP API
- E2E: Basic smoke test cho application startup và initial page load

**Chuẩn Dữ liệu Test:**
- Sử dụng dữ liệu test nhà hàng Việt Nam (món ăn như "Phở Bò", "Cơm Tấm")
- Test định dạng tiền tệ Việt Nam (₫) và date/time formats
- Xác minh PostgreSQL collation tiếng Việt với sắp xếp dấu phụ đúng

## Lịch sử Thay đổi

| Ngày | Phiên bản | Mô tả | Tác giả |
|------|-----------|-------|---------|
| 2025-08-18 | 1.0 | Tạo câu chuyện ban đầu từ Epic 1.1 | Bob (Scrum Master) |

## Ghi chép Tác nhân Phát triển

*Phần này sẽ được điền bởi development agent trong quá trình implementation*

### Model Tác nhân Sử dụng
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Tham chiếu Log Debug
*Chưa có tham chiếu debug log*

### Danh sách Ghi chú Hoàn thành
- ✅ Giải pháp ABP Framework được tạo thành công với tên project SmartRestaurant
- ✅ Cơ sở dữ liệu PostgreSQL được cấu hình với hỗ trợ collation tiếng Việt
- ✅ Thiết lập Entity Framework Core migrations hoàn thành
- ✅ Kết nối cơ sở dữ liệu được xác minh và hoạt động
- ✅ Môi trường Docker development và production được cấu hình
- ✅ Container Docker với hỗ trợ collation PostgreSQL tiếng Việt
- ✅ Nginx reverse proxy được cấu hình cho triển khai production
- ✅ Tài liệu môi trường phát triển hoàn thành trong CLAUDE.md
- ✅ Tài liệu cấu trúc project được cập nhật với đường dẫn ABP thực tế
- ✅ Root package.json với script ABP workflow được tạo
- ✅ README.md toàn diện với tính năng nhà hàng Việt Nam
- ✅ Pipeline CI/CD được cấu hình với multi-stage testing
- ✅ Workflow triển khai production với tích hợp VPS
- ✅ Quét bảo mật và kiểm tra chất lượng code được triển khai
- ✅ Tài liệu kiến trúc được cập nhật với cấu trúc project ABP thực tế

### Danh sách File
**File Hạ tầng:**
- infrastructure/docker/docker-compose.dev.yml (Môi trường development)
- infrastructure/docker/docker-compose.prod.yml (Môi trường production)
- infrastructure/docker/Dockerfile.api (Backend container)
- infrastructure/docker/Dockerfile.web (Frontend container với Nginx)
- infrastructure/docker/nginx.conf (Cấu hình reverse proxy)
- infrastructure/docker/init-scripts/01-vietnamese-collation.sql (Thiết lập DB)

**File Tài liệu:**
- CLAUDE.md (Hướng dẫn phát triển hoàn chỉnh với lệnh ABP và troubleshooting)
- README.md (Tổng quan project với tính năng nhà hàng Việt Nam)
- docs/architecture/unified-project-structure.md (Cập nhật với cấu trúc ABP thực tế)
- docs/architecture.md (Cập nhật với cấu trúc đường dẫn aspnet-core/)
- docs/architecture/high-level-architecture.md (Cập nhật với cấu trúc project hoàn chỉnh)
- package.json (Root scripts cho ABP workflow)
- .env.example (Template cấu hình môi trường)

**File CI/CD:**
- .github/workflows/ci.yaml (Pipeline CI toàn diện với multi-stage testing)
- .github/workflows/deploy.yaml (Triển khai VPS với staging và production)
- angular/package.json (Cập nhật với CI test scripts)

## Kết quả QA

### Ngày Review: 2025-08-18

### Người Review: Quinn (Test Architect - Kiến trúc sư Kiểm thử)

### Đánh giá Chất lượng Code

**Triển khai nền tảng hạ tầng xuất sắc.** Câu chuyện này thiết lập một môi trường phát triển sẵn sàng cho production với việc đóng gói Docker toàn diện, pipeline CI/CD, và các cấu hình đặc thù cho Việt Nam. Việc triển khai thể hiện sự chú ý mạnh mẽ đến yêu cầu vận hành và tuân theo các phương pháp tốt nhất của ABP Framework.

**Điểm mạnh chính:**
- Môi trường Docker hoàn chỉnh với bản build nhiều giai đoạn cho development và production
- Pipeline CI/CD toàn diện với quét bảo mật và build đa nền tảng
- Hỗ trợ ngôn ngữ tiếng Việt xuyên suốt hệ thống: PostgreSQL, tìm kiếm văn bản, định dạng
- Tài liệu hướng dẫn chi tiết với troubleshooting cho ABP
- Cấu hình bảo mật được tăng cường: người dùng không có quyền root, kiểm tra sức khỏe, sẵn sàng SSL

### Tái cấu trúc Đã Thực hiện

Không cần tái cấu trúc code - đây là câu chuyện tập trung vào hạ tầng và cấu hình. Tất cả cấu hình đều tuân theo các phương pháp hay nhất.

### Kiểm tra Tuân thủ

- **Tiêu chuẩn Code**: ✓ Không áp dụng cho câu chuyện hạ tầng
- **Cấu trúc Dự án**: ✓ Triển khai đúng cấu trúc ABP Framework với thư mục aspnet-core/
- **Chiến lược Kiểm thử**: ✓ Pipeline CI bao gồm chiến lược kiểm thử toàn diện với dữ liệu test tiếng Việt
- **Tất cả Tiêu chí Chấp nhận Đạt**: ✓ Cả 5 tiêu chí chấp nhận được triển khai và xác thực đầy đủ

### Truy xuất Yêu cầu

**TC1 - Giải pháp ABP Framework**: ✓ ĐÃ COVER
- **Test**: Xác thực build backend trong pipeline CI
- **Validation**: Biên dịch thành công giải pháp .NET với tất cả các project ABP

**TC2 - Collation Tiếng Việt PostgreSQL**: ✓ ĐÃ COVER
- **Test**: Khởi tạo database với locale vi_VN.UTF-8
- **Validation**: Xác minh các function tìm kiếm văn bản tiếng Việt và collation

**TC3 - Containerization Docker**: ✓ ĐÃ COVER
- **Test**: Xác thực build Docker trong pipeline CI
- **Validation**: Build đa giai đoạn cho môi trường dev/prod

**TC4 - Tài liệu Development**: ✓ ĐÃ COVER
- **Test**: Xác thực thủ công tính đầy đủ của CLAUDE.md
- **Validation**: Hướng dẫn lệnh ABP toàn diện và troubleshooting

**TC5 - Pipeline CI/CD**: ✓ ĐÃ COVER
- **Test**: Thực thi pipeline với thiết lập database test
- **Validation**: Test đa giai đoạn bao gồm quét bảo mật

### Review Bảo mật

**PASS** - Thiết lập tư thế bảo mật vững chắc:
- Container Docker không phải root với quyền người dùng phù hợp
- Quét bảo mật tích hợp trong pipeline CI: Trivy
- Externalization biến môi trường cho secrets
- Header bảo mật Nginx được cấu hình
- Cấu hình sẵn sàng SSL/TLS cho production

**Cải tiến Bảo mật Đã triển khai:**
- Rate limiting trong cấu hình nginx
- Header bảo mật: HSTS, CSP, X-Frame-Options
- Kiểm tra sức khỏe container để đảm bảo độ tin cậy
- Quản lý secrets thông qua biến môi trường

### Cân nhắc về Hiệu suất

**PASS** - Các tối ưu hóa hiệu suất đã bao gồm:
- Build Docker đa giai đoạn để tối ưu kích thước image
- Nginx caching và compression được cấu hình
- Tích hợp in-memory cache cho session và performance caching
- Connection pooling cơ sở dữ liệu thông qua Entity Framework
- Tối ưu hóa đặc thù tiếng Việt: index tìm kiếm văn bản

### Đánh giá Yêu cầu Phi chức năng

**Bảo mật**: ✓ PASS - Các biện pháp bảo mật toàn diện đã được triển khai
**Hiệu suất**: ✓ PASS - Caching, compression, và tối ưu hóa đã được cấu hình
**Độ tin cậy**: ✓ PASS - Kiểm tra sức khỏe, restart policies, và monitoring sẵn sàng
**Khả năng bảo trì**: ✓ PASS - Tài liệu xuất sắc và hướng dẫn troubleshooting
**Khả năng mở rộng**: ✓ PASS - Kiến trúc container cho phép horizontal scaling

### File Được Sửa Đổi Trong Review

Không có - hạ tầng và tài liệu được triển khai đúng cách.

### Danh sách Cải tiến

Tất cả các mục đã được xử lý thành công:

- [x] Cấu hình Docker đa môi trường: phân tách dev/prod
- [x] Thiết lập collation và tìm kiếm văn bản tiếng Việt
- [x] Tăng cường bảo mật: container không phải root, header, sẵn sàng SSL
- [x] CI/CD toàn diện với quét bảo mật
- [x] Tài liệu hoàn chỉnh với hướng dẫn đặc thù ABP
- [x] Cấu hình nginx sẵn sàng production với caching
- [x] Quản lý biến môi trường cho secrets
- [x] Build container đa nền tảng
- [x] Sẵn sàng kiểm tra sức khỏe và monitoring

### Đánh giá Nợ Kỹ thuật

**Nợ kỹ thuật tối thiểu đã được xác định:**
- Chứng chỉ SSL cần cấu hình thủ công cho production - đã ghi chép trong hướng dẫn triển khai
- Monitoring/observability có thể được cải thiện - dự kiến cho các câu chuyện tương lai
- Giới hạn tài nguyên container có thể được tinh chỉnh dựa trên việc sử dụng thực tế

### Trạng thái Gate

Gate: PASS → docs/qa/gates/1.1-project-structure-dev-environment-setup.yml

### Trạng thái Đề xuất

✓ **Sẵn sàng Hoàn thành** - Tất cả tiêu chí chấp nhận đã đạt, nền tảng hạ tầng toàn diện được thiết lập với cấu hình cấp độ production.

---

**Tham khảo phiên bản tiếng Anh**: [English version](../1.1.project-structure-dev-environment-setup.md)