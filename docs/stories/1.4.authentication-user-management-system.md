# Story 1.4: Authentication & User Management System (Hệ thống Xác thực & Quản lý Người dùng)

## Status (Trạng thái)
Draft

## Story (Câu chuyện)
**As a** restaurant owner (chủ nhà hàng),  
**I want** to manage user accounts with role-based permissions (tôi muốn quản lý tài khoản người dùng theo phân quyền vai trò),  
**so that** staff can access appropriate system functions (để nhân viên có thể truy cập đúng các chức năng hệ thống phù hợp).

## Acceptance Criteria (Tiêu chí Chấp nhận)
1. Role-based authentication implemented for Owner, Manager, Cashier, Kitchen Staff, Waitstaff (Hệ thống phân quyền theo vai trò cho Chủ nhà hàng, Quản lý, Thu ngân, Nhân viên bếp và Nhân viên phục vụ)
2. User registration and management interface completed (Hoàn thành giao diện tạo tài khoản và quản lý nhân viên)
3. JWT token authentication with secure session management (Đăng nhập bằng JWT token với bảo mật phiên làm việc)
4. Password reset functionality implemented (Tính năng đặt lại mật khẩu khi quên)
5. Audit logging for user activities (Ghi lại lịch sử hoạt động của người dùng)

## Tasks / Subtasks (Nhiệm vụ / Nhiệm vụ con)

- [ ] Thiết lập ABP Permission System cho Nhà hàng (AC: 1)
  - [ ] Tạo SmartRestaurantPermissions class trong Application.Contracts layer với các permission group
  - [ ] Định nghĩa permission structure: Orders, Menu, Tables, Payments, Kitchen, Reports
  - [ ] Triển khai SmartRestaurantPermissionDefinitionProvider cho permission localization
  - [ ] Seed default permissions cho từng role trong Domain layer

- [ ] Tạo Vietnamese Restaurant Roles (AC: 1)  
  - [ ] Định nghĩa Vietnamese role constants: Owner, Manager, Cashier, KitchenStaff, Waitstaff
  - [ ] Triển khai role seeding trong Domain/OpenIddict/OpenIddictDataSeedContributor
  - [ ] Gán permissions phù hợp cho từng role theo restaurant workflow
  - [ ] Cấu hình role hierarchy (Owner > Manager > Cashier/Kitchen/Waitstaff)

- [ ] Triển khai User Management AppService (AC: 2)
  - [ ] Tạo UserAppService kế thừa từ ABP IdentityAppService với restaurant-specific features
  - [ ] Triển khai Vietnamese user registration với validation (email, phone format)
  - [ ] Implement user role assignment và management methods
  - [ ] Thêm user profile management với Vietnamese employee information

- [ ] Tạo Angular User Management UI Components (AC: 2)
  - [ ] Tạo user-management module trong angular/src/app/restaurant-features/
  - [ ] Triển khai user-list component với PrimeNG DataTable và Vietnamese columns
  - [ ] Tạo user-form component cho registration/editing với role selection
  - [ ] Implement user-role-assignment component với permission display

- [ ] Triển khai JWT Authentication Enhancements (AC: 3)
  - [ ] Cấu hình JWT token expiration và refresh token cho restaurant operations
  - [ ] Implement secure session management với ABP Identity
  - [ ] Thêm automatic token refresh trong Angular HTTP interceptor
  - [ ] Triển khai logout functionality với token invalidation

- [ ] Password Reset Implementation (AC: 4)
  - [ ] Tạo password reset endpoints trong ABP Account service
  - [ ] Triển khai email-based password reset với Vietnamese templates
  - [ ] Tạo password reset components trong Angular với form validation
  - [ ] Implement secure password reset token validation

- [ ] User Activity Audit Logging (AC: 5)
  - [ ] Cấu hình ABP Audit Logging cho restaurant-specific actions
  - [ ] Triển khai custom audit log storage cho Order, Menu, Payment activities
  - [ ] Tạo audit log viewing interface trong Angular admin panel
  - [ ] Implement log filtering và Vietnamese date formatting

- [ ] Permission-based UI Guards (AC: 1, 2)
  - [ ] Triển khai PermissionGuard sử dụng ABP PermissionService
  - [ ] Áp dụng guards cho restaurant feature routes
  - [ ] Implement conditional UI rendering dựa trên user permissions
  - [ ] Test access control cho từng role scenarios

- [ ] Vietnamese Restaurant Authentication Testing (Testing Requirements)
  - [ ] Viết xUnit tests cho UserAppService với Vietnamese user data
  - [ ] Tạo Angular unit tests cho authentication components
  - [ ] Implement E2E tests cho complete user management workflow
  - [ ] Test permission-based access control scenarios

## Dev Notes (Ghi chú Phát triển)

### Previous Story Context (Bối cảnh Câu chuyện Trước)
Stories 1.1, 1.2, and 1.3 have established:
- ABP Framework backend running at https://localhost:44346 with JWT authentication
- Angular Poseidon theme integration with layout structure
- Flutter mobile foundation with authentication integration
- PostgreSQL database with Vietnamese collation support
- Development environment fully configured with Docker containers

The system now needs role-based user management to enable proper restaurant staff access control.

### ABP Identity Integration Requirements (Yêu cầu Tích hợp ABP Identity)
[Source: architecture/backend-architecture.md#authentication-and-authorization]

**Core ABP Identity Features:**
- Use ABP Framework 8.0 built-in Identity system - never create custom authentication
- JWT token authentication with ABP OAuth endpoints at `/connect/token`
- Role-based permissions using ABP Authorization attributes
- ABP localization system for Vietnamese text - never hardcode Vietnamese strings
- Access settings through ABP configuration system

**Authentication Flow:**
```csharp
// ABP handles authentication automatically through:
// 1. Login: POST /api/account/login
// 2. Token generation: ABP OAuth2 /connect/token
// 3. Permission validation: ABP Authorization middleware
// 4. User claims: ABP CurrentUser service
```

### Permission System Architecture (Kiến trúc Hệ thống Permission)
[Source: architecture/backend-architecture.md#middleware-guards]

**Permission Structure:**
```csharp
public static class SmartRestaurantPermissions
{
    public const string GroupName = "SmartRestaurant";

    public static class Orders
    {
        public const string Default = GroupName + ".Orders";
        public const string Create = Default + ".Create";
        public const string Update = Default + ".Update";
    }

    public static class Menu
    {
        public const string Default = GroupName + ".Menu";
        public const string Manage = Default + ".Manage";
    }

    public static class Kitchen
    {
        public const string Default = GroupName + ".Kitchen";
        public const string View = Default + ".View";
    }

    public static class Payments
    {
        public const string Default = GroupName + ".Payments";
        public const string Process = Default + ".Process";
    }
}
```

**Vietnamese Restaurant Roles:**
- **Owner (Chủ nhà hàng)**: Full system access including reports and staff management
- **Manager (Quản lý)**: Order management, menu management, table management, basic reports
- **Cashier (Thu ngân)**: Order processing, payment processing, table status updates
- **Kitchen Staff (Nhân viên bếp)**: Kitchen display access, order status updates
- **Waitstaff (Nhân viên phục vụ)**: Order taking, table management, basic customer service

### File Locations and Project Structure (Vị trí File và Cấu trúc Dự án)
[Source: architecture/unified-project-structure.md]

**Backend Implementation Locations:**
```
aspnet-core/src/
├── SmartRestaurant.Domain/
│   └── Settings/
│       └── SmartRestaurantSettings.cs           # Restaurant-specific settings
├── SmartRestaurant.Application.Contracts/
│   └── Permissions/
│       ├── SmartRestaurantPermissions.cs        # Permission constants
│       └── SmartRestaurantPermissionDefinitionProvider.cs
├── SmartRestaurant.Application/
│   └── Users/
│       ├── UserAppService.cs                    # Extended user management
│       └── Dto/
│           ├── RestaurantUserDto.cs             # Vietnamese user info
│           └── UserRoleAssignmentDto.cs
└── SmartRestaurant.HttpApi.Host/
    └── appsettings.json                         # JWT configuration
```

**Frontend Implementation Locations:**
```
angular/src/app/
├── proxy/                                       # ABP generated proxies
│   ├── users/                                  # User service proxies
│   └── volo/                                   # ABP framework services
└── restaurant-features/                        # Custom restaurant modules
    ├── user-management/
    │   ├── user-management.module.ts
    │   ├── components/
    │   │   ├── user-list/                      # User listing with Vietnamese UI
    │   │   ├── user-form/                      # User registration/editing
    │   │   └── role-assignment/                # Role and permission management
    │   └── services/
        └── restaurant-user.service.ts           # Extended user services
```

### ABP Auto-Generated API Integration (Tích hợp API Tự động tạo ABP)
[Source: architecture/api-specification.md]

**ABP Proxy Generation Commands:**
```bash
# Generate Angular service proxies after backend changes
cd angular
abp generate-proxy -t ng -u https://localhost:44346
npm run generate-proxy
```

**Auto-Generated Services Pattern:**
- UserAppService automatically creates `/api/app/users` endpoints
- PermissionAppService creates `/api/abp/permissions` endpoints  
- RoleAppService creates `/api/abp/roles` endpoints
- All DTOs and interfaces auto-generated in `src/app/proxy/`

### Vietnamese Restaurant User Data Requirements (Yêu cầu Dữ liệu Người dùng Nhà hàng Việt Nam)
[Source: architecture/frontend-architecture.md]

**Vietnamese User Profile Extensions:**
- Employee ID format: NV001, NV002 (Nhân viên)
- Phone number validation: Vietnamese format (+84)
- Address fields: Vietnamese address components
- Work schedule: Vietnamese time format (HH:mm)
- Emergency contact: Vietnamese relationship terms

**User Interface Requirements:**
- Hard-coded Vietnamese text for user management
- Vietnamese validation messages
- Role names in Vietnamese: "Chủ nhà hàng", "Quản lý", "Thu ngân", "Nhân viên bếp", "Nhân viên phục vụ"
- Date formatting: dd/MM/yyyy for Vietnamese users

### Security and Session Management (Bảo mật và Quản lý Phiên)
[Source: architecture/coding-standards.md#critical-fullstack-rules]

**Critical Security Rules:**
- Always use ABP authorization attributes - never implement custom authorization
- Use ABP/DataAnnotations validation - never implement custom validation without ABP integration
- Handle token refresh automatically in HTTP interceptor
- Never use process.env directly in backend - use ABP configuration system
- Always use ABP's built-in error handling and localization

**JWT Token Configuration:**
```json
{
  "AuthServer": {
    "Authority": "https://localhost:44346",
    "RequireHttpsMetadata": "false",
    "SwaggerClientId": "SmartRestaurant_Swagger"
  }
}
```

### Testing (Kiểm thử)

#### Test File Locations (Vị trí File Kiểm thử)
[Source: architecture/testing-strategy.md]

**Backend Tests:**
- Unit Tests: `test/SmartRestaurant.Application.Tests/Users/`
- API Tests: `test/SmartRestaurant.HttpApi.Tests/Controllers/`
- Identity Tests: `test/SmartRestaurant.Application.Tests/Identity/`

**Frontend Tests:**
- Component Tests: `angular/tests/unit/components/user-management/`
- Service Tests: `angular/tests/unit/services/restaurant-user.service.spec.ts`
- Integration Tests: `angular/tests/integration/user-management-workflow.integration.spec.ts`

#### Testing Requirements for This Story (Yêu cầu Kiểm thử cho Câu chuyện này)
[Source: architecture/testing-strategy.md#test-examples]

**Authentication Tests:**
- Test JWT token storage and refresh mechanisms
- Verify role-based permission enforcement
- Test Vietnamese user registration validation
- Validate password reset workflow with email templates

**Permission Tests:**
- Test access control for each restaurant role
- Verify UI component conditional rendering based on permissions
- Test API endpoint authorization with different user roles
- Validate permission inheritance and hierarchy

**Vietnamese Data Tests:**
- Test Vietnamese phone number validation (+84 format)
- Verify Vietnamese text handling in user names and addresses
- Test date formatting (dd/MM/yyyy) in user interfaces
- Validate Vietnamese error message localization

#### Test Framework Standards (Chuẩn Framework Kiểm thử)
[Source: architecture/testing-strategy.md]
- **Backend Testing**: xUnit for .NET unit tests with ABP test infrastructure
- **Frontend Testing**: Jasmine + Karma for Angular unit tests
- **E2E Testing**: Playwright for complete user management workflows
- **Mock Data**: Vietnamese restaurant staff test data matching ABP DTOs

## Change Log (Lịch sử Thay đổi)

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-19 | 1.0 | Initial story creation for authentication and user management system based on Epic 1.4 requirements | Bob (Scrum Master) |

## Dev Agent Record (Ghi chép Tác nhân Phát triển)

### Agent Model Used (Mô hình Tác nhân Sử dụng)
[To be populated by development agent]

### Debug Log References (Tham chiếu Log Debug)
[To be populated by development agent]

### Completion Notes List (Danh sách Ghi chú Hoàn thành)
[To be populated by development agent]

### File List (Danh sách File)
[To be populated by development agent]

## QA Results (Kết quả QA)
[To be populated by QA agent]