# Story 4.2: Purchase Invoice & Stock-In Management

## Template Information

### Template Level
Level 1

### Complexity Analysis
Analysis result from template-level-analyzer (updated after simplification):
- **Entity Complexity:** Simple - PurchaseInvoice has basic properties with simple calculation logic (TotalPrice), requires only standard CRUD operations
- **UI Complexity:** Basic - Only needs List + Dialog form with text inputs and number inputs
- **Technical Requirements:** Standard CRUD - ICrudAppService with simple override for calculation and stock update

**Template References:**
- Backend Template: [backend-template-level1.md](../.bmad-core/templates/backend-template-level1.md)
- Frontend Template: [frontend-template-level1.md](../.bmad-core/templates/frontend-template-level1.md)

**Estimated Story Points:** 20-30 points

## Status
Approved

## User Story

**As a** purchase manager,  
**I want** to create and manage purchase invoices with detailed stock-in tracking,  
**So that** all purchases are recorded for cost calculation, automatic stock deduction, and inventory alerts.

## Acceptance Criteria

1. Create purchase invoices with ingredient selection, quantities, and pricing
2. Record stock-in with purchase date, supplier, and total cost tracking
3. Integration with expense calculation for financial reporting
4. Automatic inventory level updates upon stock-in confirmation
5. Foundation for automatic stock deduction when orders are processed

## Development Notes

### Experience from Previous Story
From Story 4.1: Ingredient Category Management successfully completed with:
- Established IngredientCategory and Ingredient entities with standard CRUD operations
- Implemented Vietnamese naming conventions and sample data
- Set up basic cost tracking (CostPerUnit nullable) and supplier information linking
- Inventory management system foundation ready for business logic integration

### Data Model
**PurchaseInvoice Entity** (Header - Invoice general information):
- InvoiceNumber (string)
- SupplierName (string, free input)  
- InvoiceDate (DateTime)
- TotalAmount (int, total amount of all items)
- Notes (string, nullable, general notes)
- CreatedBy, ModifiedBy, CreationTime, LastModificationTime (ABP audit fields)
- IsDeleted (soft delete support)

**PurchaseInvoiceItem Entity** (Detail - Individual ingredient details):
- PurchaseInvoiceId (Guid, foreign key)
- IngredientId (Guid, nullable, select from existing Ingredient for main ingredients)
- IngredientName (string, can be populated from Ingredient.Name or free input for small items)
- Quantity (int, quantity)
- UnitId (Guid, nullable, select from existing Unit)
- UnitName (string, populated from Unit.Name for display)
- UnitPrice (int, nullable, unit price)
- TotalPrice (int, calculated or direct input)
- CreatedBy, ModifiedBy, CreationTime, LastModificationTime (ABP audit fields)
- IsDeleted (soft delete support)

**Update Ingredient entity from Story 4.1**: Add `CurrentStock` field (int, default = 0)

**Stock update logic**: 
- **If PurchaseInvoiceItem has IngredientId** (main ingredient): Find Ingredient â†’ increase CurrentStock by Quantity
- **If no IngredientId** (small items): Only save for cost calculation, no stock impact

### Entity Code

**PurchaseInvoice.cs** (Header):
```csharp
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using Volo.Abp.Domain.Entities.Auditing;

namespace SmartRestaurant.Inventory
{
    public class PurchaseInvoice : FullAuditedAggregateRoot<Guid>
    {
        [Required]
        [MaxLength(50)]
        public string InvoiceNumber { get; set; } = string.Empty;
        
        [Required]
        [MaxLength(200)]
        public string SupplierName { get; set; } = string.Empty;
        
        [Required]
        public DateTime InvoiceDate { get; set; }
        
        [Required]
        public int TotalAmount { get; private set; } // Total amount automatically calculated from Items
        
        [MaxLength(500)]
        public string? Notes { get; set; };

        // Navigation property
        public virtual ICollection<PurchaseInvoiceItem> Items { get; set; } = new List<PurchaseInvoiceItem>();

        protected PurchaseInvoice()
        {
        }

        public PurchaseInvoice(
            Guid id,
            string invoiceNumber,
            string supplierName,
            DateTime invoiceDate,
            string? notes = null) : base(id)
        {
            InvoiceNumber = invoiceNumber;
            SupplierName = supplierName;
            InvoiceDate = invoiceDate;
            Notes = notes;
            TotalAmount = 0; // Will be calculated from Items
        }

        public void CalculateTotalAmount()
        {
            TotalAmount = Items.Sum(item => item.TotalPrice);
        }
    }
}
```

**PurchaseInvoiceItem.cs** (Detail):
```csharp
using System;
using System.ComponentModel.DataAnnotations;
using Volo.Abp.Domain.Entities.Auditing;

namespace SmartRestaurant.Inventory
{
    public class PurchaseInvoiceItem : FullAuditedEntity<Guid>
    {
        [Required]
        public Guid PurchaseInvoiceId { get; set; }
        
        public Guid? IngredientId { get; set; } // Nullable - only for main ingredients
        
        [Required]
        [MaxLength(200)]
        public string IngredientName { get; set; } = string.Empty; // Auto-populated from Ingredient or free input
        
        [Required]
        public int Quantity { get; set; }
        
        public Guid? UnitId { get; set; } // Nullable - select from Unit
        
        [Required]
        [MaxLength(50)]
        public string UnitName { get; set; } = string.Empty; // Auto-populated from Unit
        
        public int? UnitPrice { get; set; } // Nullable - can be empty
        
        [Required]
        public int TotalPrice { get; set; } // Calculate or direct input

        // Navigation property
        public virtual PurchaseInvoice PurchaseInvoice { get; set; } = null!;

        protected PurchaseInvoiceItem()
        {
        }

        public PurchaseInvoiceItem(
            Guid id,
            Guid purchaseInvoiceId,
            string ingredientName,
            int quantity,
            string unitName,
            Guid? ingredientId = null,
            Guid? unitId = null,
            int? unitPrice = null,
            int? totalPrice = null) : base(id)
        {
            PurchaseInvoiceId = purchaseInvoiceId;
            IngredientId = ingredientId;
            IngredientName = ingredientName;
            Quantity = quantity;
            UnitId = unitId;
            UnitName = unitName;
            UnitPrice = unitPrice;
            TotalPrice = totalPrice ?? (unitPrice.HasValue ? quantity * unitPrice.Value : 0);
        }
    }
}
```

**Update Ingredient.cs** (add CurrentStock):
```csharp
// Add this property to existing Ingredient entity from Story 4.1
[Required]
public int CurrentStock { get; set; } = 0; // Current quantity in stock
```

### Application Service Logic

**PurchaseInvoiceAppService**: Reference MenuItemAppService pattern
```csharp
public class PurchaseInvoiceAppService : 
    CrudAppService<
        PurchaseInvoice,                      // Domain Entity
        PurchaseInvoiceDto,                   // Output DTO  
        Guid,                                // Primary Key Type
        PagedAndSortedResultRequestDto,       // GetList Input
        CreateUpdatePurchaseInvoiceDto>,      // Create/Update Input DTO
    IPurchaseInvoiceAppService
{
    // Dependency injection for Ingredient, Unit repositories
    // Override CreateAsync(): Cascading insert master-detail via Entity Framework navigation properties
    // Override GetAsync(): Use .Include(x => x.Items) to load Items collection
    // Override GetListAsync(): Include Items if summary display needed
    // Business validation: ValidateIngredientExists, ValidateUnitExists
}
```

### DTOs Code

**CreatePurchaseInvoiceDto.cs** (Master-Detail):
```csharp
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;

namespace SmartRestaurant.Inventory
{
    public class CreatePurchaseInvoiceDto
    {
        [Required]
        [MaxLength(50)]
        public string InvoiceNumber { get; set; } = string.Empty;
        
        [Required]
        [MaxLength(200)]
        public string SupplierName { get; set; } = string.Empty;
        
        [Required]
        public DateTime InvoiceDate { get; set; }
        
        [MaxLength(500)]
        public string? Notes { get; set; }
        
        [Required]
        public List<CreatePurchaseInvoiceItemDto> Items { get; set; } = new();
    }

    public class CreatePurchaseInvoiceItemDto
    {
        public Guid? IngredientId { get; set; } // Nullable - only for main ingredients
        
        [Required]
        [MaxLength(200)]
        public string IngredientName { get; set; } = string.Empty; // Auto-fill or free input
        
        [Required]
        public int Quantity { get; set; }
        
        public Guid? UnitId { get; set; } // Nullable - select from Unit
        
        [Required]
        [MaxLength(50)]
        public string UnitName { get; set; } = string.Empty; // Auto-fill from Unit
        
        public int? UnitPrice { get; set; } // Optional
        
        public int? TotalPrice { get; set; } // Optional - will calculate or input
    }
}
```

**PurchaseInvoiceDto.cs** (Master-Detail):
```csharp
using System;
using System.Collections.Generic;
using Volo.Abp.Application.Dtos;

namespace SmartRestaurant.Inventory  
{
    public class PurchaseInvoiceDto : FullAuditedEntityDto<Guid>
    {
        public string InvoiceNumber { get; set; } = string.Empty;
        public string SupplierName { get; set; } = string.Empty;
        public DateTime InvoiceDate { get; set; }
        public int TotalAmount { get; set; }
        public string? Notes { get; set; }
        public List<PurchaseInvoiceItemDto> Items { get; set; } = new();
    }

    public class PurchaseInvoiceItemDto : FullAuditedEntityDto<Guid>
    {
        public Guid PurchaseInvoiceId { get; set; }
        public Guid? IngredientId { get; set; }
        public string IngredientName { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public string UnitName { get; set; } = string.Empty;
        public int? UnitPrice { get; set; }
        public int TotalPrice { get; set; }
    }
}
```

**Auto-generated REST Endpoints**: [Source: architecture/backend-architecture.md#ABPAutoAPI]
- POST /api/app/purchase-invoice (Create)
- PUT /api/app/purchase-invoice/{id} (Update)
- GET /api/app/purchase-invoice/{id} (Get by ID)
- GET /api/app/purchase-invoice (List with filtering)
- DELETE /api/app/purchase-invoice/{id} (Soft delete)

### Component Specifications
**Frontend Location**: [Source: architecture/unified-project-structure.md]
- Main module: `angular/src/app/features/inventory/purchase-invoice-management/`
- Components following PrimeNG Poseidon theme
- Simple CRUD with table and dialog

**Main UI Components**: [Source: Master-Detail pattern with Level 1 base]
- `purchase-invoice-list.component.ts` - List with p-table and search
- `purchase-invoice-dialog.component.ts` - Master-Detail dialog form with:
  * **Header section**: Text inputs for InvoiceNumber, SupplierName, InvoiceDate, Notes
  * **Detail section**: p-table for Items list with:
    - Add/Remove item buttons
    - Inline editing for each item
    - Dropdown select Ingredient (nullable) or text input IngredientName
    - Auto-fill IngredientName/Unit when selecting Ingredient  
    - Number inputs: Quantity, UnitPrice (nullable), TotalPrice
    - 2 pricing input methods for each item
  * **Footer**: Display TotalAmount automatically calculated from all Items

### File Locations
**Backend Files**: [Source: architecture/unified-project-structure.md]
```
aspnet-core/src/SmartRestaurant.Domain/
â”œâ”€â”€ Inventory/
â”‚   â”œâ”€â”€ PurchaseInvoice.cs
â”‚   â””â”€â”€ PurchaseInvoiceItem.cs

aspnet-core/src/SmartRestaurant.Application.Contracts/
â”œâ”€â”€ Inventory/
â”‚   â”œâ”€â”€ CreatePurchaseInvoiceDto.cs
â”‚   â”œâ”€â”€ UpdatePurchaseInvoiceDto.cs
â”‚   â”œâ”€â”€ PurchaseInvoiceDto.cs
â”‚   â””â”€â”€ IPurchaseInvoiceAppService.cs

aspnet-core/src/SmartRestaurant.Application/
â”œâ”€â”€ Inventory/
â”‚   â””â”€â”€ PurchaseInvoiceAppService.cs
```

**Frontend Files**: [Source: architecture/unified-project-structure.md]
```
angular/src/app/features/inventory/
â”œâ”€â”€ purchase-invoice-management/
â”‚   â”œâ”€â”€ purchase-invoice-list/
â”‚   â””â”€â”€ purchase-invoice-dialog/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ purchase-invoice.models.ts
â””â”€â”€ services/
    â””â”€â”€ purchase-invoice.service.ts
```

### Testing Requirements
**Backend Testing Strategy**: [Source: architecture/testing-strategy.md principles]
- Unit tests for domain service business logic (cost calculation, status transitions)
- Integration tests for application service complete workflow
- Repository tests for entity relationships and constraints
- Business rule validation testing

**Frontend Testing Strategy**: [Source: architecture/testing-strategy.md principles]  
- Unit tests for component form validation and UI logic
- Integration tests for multi-step workflows
- E2E tests for complete purchase to stock-in workflow
- Vietnamese data testing with ingredient samples from Story 4.1

### Technical Constraints
**ABP Framework Requirements**: [Source: architecture/tech-stack.md + architecture/backend-architecture.md]
- Use ICrudAppService pattern for simple CRUD with custom override
- Override CreateAsync/UpdateAsync for stock update logic
- Follow ABP audit logging patterns
- Use ABP soft delete capabilities
- Configure Entity Framework relationships with Ingredient

**Performance Considerations**: [Source: architecture/tech-stack.md]
- Database indexing on InvoiceNumber, InvoiceDate, IngredientId
- Performance consideration for CurrentStock update operations

**Security Requirements**: [Source: architecture/backend-architecture.md#Authorization]
- Role-based authorization: PurchaseManager, InventoryStaff
- Define permissions: PurchaseInvoice.Create, PurchaseInvoice.Update, PurchaseInvoice.Delete
- Audit trail for purchase transactions

## Tasks / Subtasks

### Backend Development

- [ ] **Reference Code Pattern from Menu Management** (AC: 1, 2, 3, 4, 5)
  - [ ] Read and analyze MenuItemAppService implementation from completed Story 3.2
  - [ ] Reference Entity relationships pattern between MenuItem and MenuCategory
  - [ ] Learn AutoMapper configuration and DTOs mapping pattern
  - [ ] Reference permission configuration and API controller setup
  - [ ] Apply same pattern for PurchaseInvoice Master-Detail implementation

- [ ] **Create PurchaseInvoice & PurchaseInvoiceItem Domain Entities** (AC: 1, 2)
  - [ ] Define PurchaseInvoice entity with TotalAmount private set and CalculateTotalAmount() method
  - [ ] Define PurchaseInvoiceItem entity with navigation property to PurchaseInvoice
  - [ ] Add both entities to SmartRestaurantDbContext with relationships
  - [ ] Create database migration for both entities with foreign keys
  - [ ] Configure Entity Framework relationships (PurchaseInvoice.Items collection)

- [ ] **Update Ingredient Entity** (AC: 4, 5)  
  - [ ] Add CurrentStock field (int, default = 0) to Ingredient entity
  - [ ] Create database migration to add CurrentStock column
  - [ ] Update existing ingredients with CurrentStock = 0

- [ ] **Implement PurchaseInvoice Application Layer** (AC: 1, 2, 3, 4, 5)
  - [ ] Create PurchaseInvoiceAppService inheriting from ICrudAppService following MenuItemAppService pattern
  - [ ] Define CreateUpdatePurchaseInvoiceDto with nested Items collection
  - [ ] Override CreateAsync(): Cascading insert master-detail + update CurrentStock + call CalculateTotalAmount()
  - [ ] Override UpdateAsync(): Adjust CurrentStock and recalculate TotalAmount
  - [ ] Override GetAsync() and GetListAsync(): Use .Include(x => x.Items)
  - [ ] Add AutoMapper profiles for nested DTOs

- [ ] **Configure PurchaseInvoice API Endpoints** (AC: 1, 2, 3)
  - [ ] Auto-generated REST endpoints via ICrudAppService
  - [ ] Configure API permissions and authorization policies  
  - [ ] Add API documentation and Swagger annotations
  - [ ] Test API endpoints using Swagger UI with Master-Detail data

- [ ] **Create PurchaseInvoice Integration Tests** (AC: 1, 2, 4, 5)
  - [ ] Test cascading insert master-detail operation
  - [ ] Test Include navigation properties in Get operations
  - [ ] Test TotalAmount automatic calculation logic
  - [ ] Test CurrentStock update logic for Ingredient  
  - [ ] Test authorization and permission requirements
  - [ ] Verify database relationships and constraints

### Frontend Development

- [ ] **Reference Code Pattern from Menu Item Management Frontend** (AC: 1, 2, 3, 4)
  - [ ] Read and analyze menu-item-list component implementation from Story 3.2
  - [ ] Reference menu-item-form component with dropdown selection pattern
  - [ ] Learn dialog service pattern and responsive breakpoints configuration  
  - [ ] Reference routing setup and breadcrumb navigation Vietnamese text
  - [ ] Apply same pattern for PurchaseInvoice Master-Detail UI implementation

- [ ] **Generate Angular Service Proxies** (AC: 1, 2, 3)
  - [ ] Run 'abp generate-proxy -t ng -u https://localhost:44346' command
  - [ ] Verify generated PurchaseInvoiceService and DTOs
  - [ ] Test proxy service methods in browser console

- [ ] **Create PurchaseInvoice List Component** (AC: 1, 2, 3)
  - [ ] Generate component: `angular/src/app/features/inventory/purchase-invoice-management/purchase-invoice-list/`
  - [ ] Implement PrimeNG p-table with columns for entity properties
  - [ ] Add search functionality with global filtering
  - [ ] Add CRUD action buttons (Create, Edit, Delete) with icons
  - [ ] Implement confirmation dialog for delete operations

- [ ] **Create PurchaseInvoice Form Component** (AC: 1, 2, 4)
  - [ ] Generate component: `angular/src/app/features/inventory/purchase-invoice-management/purchase-invoice-dialog/`
  - [ ] Build reactive form with FormBuilder and validation
  - [ ] Add form fields:
    * Text inputs: InvoiceNumber, SupplierName, Notes
    * p-dropdown for Ingredient selection (load from IngredientAppService)
    * Read-only displays: IngredientName, Unit (auto-fill)
    * Number inputs: Quantity, UnitPrice (nullable), TotalPrice
    * Dynamic TotalPrice calculation logic
  - [ ] Implement form submission logic for create and update
  - [ ] Add loading states and error handling

- [ ] **Implement PurchaseInvoice Dialog Service** (AC: 1, 2)
  - [ ] Create PurchaseInvoiceFormDialogService for dialog management
  - [ ] Implement openCreateDialog() method
  - [ ] Implement openEditDialog(id) method with data loading
  - [ ] Configure dialog responsive breakpoints
  - [ ] Handle dialog result callbacks and data refresh

- [ ] **Add Route Configuration** (AC: 1, 3)
  - [ ] Define routes in purchase-invoices.routes.ts
  - [ ] Add lazy-loaded route to main routing module
  - [ ] Configure breadcrumb navigation with Vietnamese text
  - [ ] Add route guards if authorization required

- [ ] **Create Frontend Integration Tests** (AC: 1, 2, 4)
  - [ ] Write component rendering tests with TestBed
  - [ ] Test user interactions (click, form input, search, ingredient selection)
  - [ ] Mock service dependencies and test API calls
  - [ ] Test error handling and loading states
  - [ ] Test TotalPrice calculation logic in form

### Testing & Documentation

- [ ] **Update Documentation** (AC: 3)
  - [ ] Document entity properties and validation rules
  - [ ] Add API endpoint documentation
  - [ ] Document UI component usage and features
  - [ ] Update project README with new functionality

- [ ] **Deploy to Development Environment** (AC: 4, 5)
  - [ ] Run database migrations on dev environment
  - [ ] Deploy backend API changes
  - [ ] Deploy frontend changes
  - [ ] Verify end-to-end functionality in dev environment with Ingredient data from Story 4.1

## Definition of Done
- [ ] All acceptance criteria implemented and tested
- [ ] PurchaseInvoice CRUD operations working with ICrudAppService pattern
- [ ] Automatic CurrentStock update logic working correctly
- [ ] Simple UI with table + dialog implemented with Vietnamese localization
- [ ] Ingredient dropdown selection working with auto-fill IngredientName/Unit
- [ ] TotalPrice calculation logic working for both methods (UnitPrice*Quantity and direct input)
- [ ] Database migrations applied and tested
- [ ] Integration tests pass for CRUD operations and stock update logic
- [ ] Code review completed and approved
- [ ] Feature tested in development environment with Ingredient data from Story 4.1

## Notes
This story establishes simple Purchase Invoice system with automatic CurrentStock updates for Ingredients. Uses ICrudAppService pattern with custom override for business logic. Simple UI with PrimeNG table + dialog, featuring dropdown selection for Ingredients and flexible pricing (UnitPrice calculation or direct TotalPrice input). This foundation will support inventory tracking and cost management for the restaurant.