# Story 2.1: Layout Section Management

## Status
Approved

## Story
**As a** restaurant manager (quản lý nhà hàng),  
**I want** to create and manage layout sections like "Dãy 1", "Dãy 2", "Khu VIP" (tôi muốn tạo và quản lý các khu vực bố cục như "Dãy 1", "Dãy 2", "Khu VIP"),  
**so that** I can organize tables into logical sections within the restaurant (để tôi có thể tổ chức bàn thành các khu vực hợp lý trong nhà hàng).

## Acceptance Criteria
1. CRUD operations for layout sections with Vietnamese names (Thao tác CRUD cho khu vực bố cục với tên tiếng Việt)
2. Section ordering and display management (Quản lý thứ tự và hiển thị khu vực)
3. Section status control (active/inactive) (Điều khiển trạng thái khu vực - hoạt động/không hoạt động)

## Tasks / Subtasks

- [ ] Backend Domain Model Implementation (AC: 1, 2, 3)
  - [ ] Create LayoutSection entity in Domain layer extending FullAuditedEntity<Guid> with Vietnamese section naming
  - [ ] Add DisplayOrder property for section sequencing and IsActive property for status control
  - [ ] Create Entity Framework Core configuration and migration for LayoutSection entity
  - [ ] Create ILayoutSectionAppService interface in Application.Contracts/TableManagement/LayoutSections layer
  - [ ] Implement LayoutSectionAppService in Application/TableManagement/LayoutSections layer with CRUD operations and ABP authorization
  - [ ] Generate ABP service proxies for frontend using abp generate-proxy command

- [ ] Frontend Layout Section Management Components (AC: 1, 2, 3)
  - [ ] Create layout-section-management feature module under angular/src/app/features/table-management/
  - [ ] Implement layout-section-list component using PrimeNG DataTable with Vietnamese column headers
  - [ ] Create layout-section-form component for add/edit operations with Vietnamese validation
  - [ ] Add section ordering functionality with drag-and-drop reordering using @angular/cdk/drag-drop
  - [ ] Implement IsActive toggle with visual feedback using PrimeNG InputSwitch
  - [ ] Apply Vietnamese restaurant styling using PrimeNG Poseidon theme and TailwindCSS

- [ ] Vietnamese Integration and Validation (AC: 1, 3)
  - [ ] Add Vietnamese text validation for section names with proper error messages
  - [ ] Implement Vietnamese section naming patterns (Dãy 1, Khu VIP, Sân vườn, etc.)
  - [ ] Create Vietnamese localization for all UI text and validation messages
  - [ ] Add confirmation dialogs in Vietnamese for delete operations

- [ ] Testing Implementation
  - [ ] Create unit tests for LayoutSectionAppService using xUnit and ABP test infrastructure
  - [ ] Implement frontend component tests for layout-section-list and layout-section-form using Angular testing utilities
  - [ ] Create integration tests for CRUD operations through ABP service proxies
  - [ ] Test Vietnamese text validation and section ordering functionality
  - [ ] Add E2E tests for complete section management workflow

## Dev Notes

### Previous Story Context
Stories 1.1 through 1.4 established:
- ABP Framework backend with .NET 8 running at https://localhost:44346
- Angular 19 frontend with PrimeNG Poseidon theme integration and TailwindCSS
- Authentication and user management system with role-based permissions
- Vietnamese restaurant layout components and responsive design framework  
- ComponentBase pattern for consistent form validation and error handling
- PostgreSQL database with Vietnamese text search and collation support

The system now needs hierarchical table layout management with logical sections to organize tables efficiently within Vietnamese restaurant spaces.

### Architecture Context

[Source: architecture/tech-stack.md]
**Technology Stack:**
- Backend: ABP Framework 8.0, .NET 8, C# 12.0, PostgreSQL 14+
- Frontend: Angular 19, TypeScript 5.0+, PrimeNG 19.x with Poseidon theme
- Authentication: ABP Identity 8.0 with Vietnamese user workflows
- Testing: xUnit + Moq for backend, Jasmine + Karma for frontend, Playwright for E2E

[Source: architecture/coding-standards.md]
**Critical ABP Development Rules:**
- Always define entities in Domain layer using ABP base classes (FullAuditedEntity, etc.)
- Use ABP proxy generation for frontend types - never manually create TypeScript interfaces
- Always use auto-generated ABP service proxies for API calls
- Use ABP repositories and Entity Framework Core for database access
- Implement IApplicationService for auto-API generation
- Define DTOs in Application layer for auto-proxy generation
- Use ABP authorization attributes and permission system
- Use ABP localization system for Vietnamese text

### Domain Model Architecture

[Source: architecture/data-models.md]
**LayoutSection Entity Structure:**
```csharp
// aspnet-core/src/SmartRestaurant.Domain/Entities/Tables/LayoutSection.cs
public class LayoutSection : FullAuditedEntity<Guid>
{
    /// <summary>Tên khu vực bố cục (ví dụ: "Dãy 1", "Khu VIP", "Sân vườn")</summary>
    public string SectionName { get; set; }
    
    /// <summary>Mô tả chi tiết khu vực</summary>
    public string Description { get; set; }
    
    /// <summary>Thứ tự hiển thị khu vực</summary>
    public int DisplayOrder { get; set; }
    
    /// <summary>Khu vực có đang hoạt động hay không</summary>
    public bool IsActive { get; set; }
    
    // Navigation properties
    /// <summary>Danh sách bàn thuộc khu vực này</summary>
    public virtual ICollection<Table> Tables { get; set; }
}
```

**Auto-Generated Frontend Interface:**
```typescript
// Generated by ABP CLI: src/app/proxy/layout-sections/models.ts
export interface LayoutSectionDto {
  id: string;
  sectionName: string;
  description?: string;
  displayOrder: number;
  isActive: boolean;
}

export interface CreateLayoutSectionDto {
  sectionName: string;
  description?: string;
  displayOrder: number;
  isActive: boolean;
}
```

### Application Service Architecture

[Source: architecture/backend-architecture.md]
**ABP Application Service Pattern:**
```csharp
// aspnet-core/src/SmartRestaurant.Application/TableManagement/LayoutSections/LayoutSectionAppService.cs
[Authorize(SmartRestaurantPermissions.TableManagement.Default)]
public class LayoutSectionAppService : ApplicationService, ILayoutSectionAppService
{
    private readonly ILayoutSectionRepository _layoutSectionRepository;

    public LayoutSectionAppService(ILayoutSectionRepository layoutSectionRepository)
    {
        _layoutSectionRepository = layoutSectionRepository;
    }

    [Authorize(SmartRestaurantPermissions.TableManagement.CreateLayout)]
    public async Task<LayoutSectionDto> CreateAsync(CreateLayoutSectionDto input)
    {
        var layoutSection = new LayoutSection(
            GuidGenerator.Create(),
            input.SectionName,
            input.Description,
            input.DisplayOrder,
            input.IsActive
        );

        await _layoutSectionRepository.InsertAsync(layoutSection);
        return ObjectMapper.Map<LayoutSection, LayoutSectionDto>(layoutSection);
    }
    
    // Additional CRUD operations...
}
```

### Frontend Architecture

[Source: architecture/frontend-architecture.md]
**Feature Module Structure:**
```typescript
// angular/src/app/features/table-management/layout-sections/
├── layout-section-management.routes.ts     # Feature routing
├── layout-section-list/
│   ├── layout-section-list.component.ts    # List component with DataTable
│   ├── layout-section-list.component.html  # List template
│   ├── layout-section-list.component.scss  # List styles
│   └── layout-section-list.component.spec.ts # List tests
├── layout-section-form/
│   ├── layout-section-form.component.ts    # Form component
│   ├── layout-section-form.component.html  # Form template
│   ├── layout-section-form.component.scss  # Form styles
│   └── layout-section-form.component.spec.ts # Form tests
└── services/
    └── layout-section.service.ts           # Business logic service
```

**Component Implementation with ComponentBase Pattern:**
```typescript
// layout-section-list.component.ts
import { Component, OnInit } from '@angular/core';
import { ComponentBase } from '@shared/base/component-base';
import { LayoutSectionService } from '@proxy/table-management/layout-sections';
import { LayoutSectionDto } from '@proxy/table-management/layout-sections/models';

@Component({
  selector: 'app-layout-section-list',
  standalone: true,
  imports: [CommonModule, DataTableModule, ButtonModule, InputSwitchModule],
  templateUrl: './layout-section-list.component.html'
})
export class LayoutSectionListComponent extends ComponentBase implements OnInit {
  layoutSections: LayoutSectionDto[] = [];
  loading = false;

  constructor(private layoutSectionService: LayoutSectionService) {
    super();
  }

  async ngOnInit(): Promise<void> {
    await this.loadLayoutSections();
  }

  private async loadLayoutSections(): Promise<void> {
    this.loading = true;
    try {
      const result = await this.layoutSectionService.getList({}).toPromise();
      this.layoutSections = result.items;
    } catch (error) {
      this.handleError(error, 'Không thể tải danh sách khu vực');
    } finally {
      this.loading = false;
    }
  }
}
```

### Project Structure and File Locations

[Source: architecture/unified-project-structure.md]
**Backend Files:**
```
aspnet-core/src/
├── SmartRestaurant.Domain/
│   └── Entities/Tables/
│       └── LayoutSection.cs              # Domain entity
├── SmartRestaurant.Application.Contracts/
│   └── TableManagement/
│       └── LayoutSections/
│           ├── ILayoutSectionAppService.cs   # Service interface
│           └── Dto/
│               ├── LayoutSectionDto.cs       # Data transfer objects
│               ├── CreateLayoutSectionDto.cs # Create DTO
│               └── UpdateLayoutSectionDto.cs # Update DTO
├── SmartRestaurant.Application/
│   └── TableManagement/
│       └── LayoutSections/
│           ├── LayoutSectionAppService.cs    # Application service implementation
│           └── LayoutSectionAutoMapperProfile.cs # AutoMapper configuration
└── SmartRestaurant.EntityFrameworkCore/
    ├── EntityFrameworkCore/
    │   ├── SmartRestaurantDbContext.cs   # Add LayoutSection DbSet
    │   └── LayoutSectionEntityTypeConfiguration.cs # EF Core configuration
    └── Migrations/                       # Database migration files
```

**Frontend Files:**
```
angular/src/app/
├── proxy/table-management/layout-sections/ # ABP generated proxies
│   ├── layout-section.service.ts        # Auto-generated service
│   ├── models.ts                        # TypeScript interfaces
│   └── index.ts                         # Barrel exports
├── features/table-management/            # Table management feature module
│   ├── layout-sections/                 # Layout section components
│   │   ├── layout-section-list/         # List component
│   │   ├── layout-section-form/         # Form component
│   │   └── services/                    # Business logic services
│   └── table-management.routes.ts       # Feature routing
├── shared/components/                    # Reusable components
│   └── validation-error/                # Validation error display
└── layout/components/                    # Updated menu integration
    └── app.menu.ts                      # Menu with layout section routes
```

### ABP Authorization Integration

[Source: architecture/backend-architecture.md#authentication-and-authorization]
**Permission System:**
```csharp
// SmartRestaurantPermissions.cs - Add layout section permissions
public static class TableManagement
{
    public const string Default = GroupName + ".TableManagement";
    public const string ViewLayout = Default + ".ViewLayout";
    public const string EditLayout = Default + ".EditLayout";
    public const string CreateLayout = Default + ".CreateLayout";
    public const string DeleteLayout = Default + ".DeleteLayout";
}

// LayoutSectionAppService.cs - Apply authorization
[Authorize(SmartRestaurantPermissions.TableManagement.Default)]
public class LayoutSectionAppService : ApplicationService, ILayoutSectionAppService
{
    [Authorize(SmartRestaurantPermissions.TableManagement.CreateLayout)]
    public async Task<LayoutSectionDto> CreateAsync(CreateLayoutSectionDto input) { ... }
    
    [Authorize(SmartRestaurantPermissions.TableManagement.EditLayout)]
    public async Task<LayoutSectionDto> UpdateAsync(Guid id, UpdateLayoutSectionDto input) { ... }
}
```

### Vietnamese Restaurant Section Standards
**Common Vietnamese Restaurant Section Names:**
- "Dãy 1", "Dãy 2", "Dãy 3" (Row 1, Row 2, Row 3)
- "Khu VIP" (VIP Area)
- "Phòng riêng" (Private Room)
- "Sân vườn" (Garden Area)
- "Tầng 1", "Tầng 2" (Floor 1, Floor 2)
- "Khu gia đình" (Family Area)
- "Quầy bar" (Bar Area)

## Testing

[Source: architecture/testing-strategy.md]
**Test File Locations:**
- Backend Unit Tests: `test/SmartRestaurant.Application.Tests/TableManagement/LayoutSections/LayoutSectionAppService_Tests.cs`
- Frontend Unit Tests: `angular/src/app/features/table-management/layout-sections/layout-section-list/layout-section-list.component.spec.ts`
- Integration Tests: `angular/tests/integration/layout-section-management.integration.spec.ts`

**Testing Requirements:**
- Test Vietnamese text validation and error handling
- Test section ordering functionality and drag-and-drop
- Test CRUD operations through ABP service proxies
- Test permission-based access control
- Validate responsive design on tablet devices

**Test Framework Standards:**
- Frontend Testing: Jasmine + Karma for Angular unit tests with PrimeNG component testing
- Backend Testing: xUnit for .NET unit tests with ABP test infrastructure
- E2E Testing: Playwright for complete layout section management workflows
- Mock Data: Vietnamese restaurant section names matching business requirements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-21 | 1.0 | Initial story creation for layout section management based on Epic 2.1 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_This section will be populated by the development agent during implementation_

### Debug Log References
_This section will be populated by the development agent with references to debug logs or traces generated during development_

### Completion Notes List
_This section will be populated by the development agent with notes about task completion and any issues encountered_

### File List
_This section will be populated by the development agent with a list of all files created, modified, or affected during story implementation_

## QA Results
_This section will be populated by the QA Agent with results from QA review of the completed story implementation_

---

## References
- **Vietnamese version:** [docs/stories/vi/2.1.quan-ly-khu-vuc-bo-cuc.md](vi/2.1.quan-ly-khu-vuc-bo-cuc.md)
- **Related Epic:** [docs/prd/epics/epic-2-table-layout-management.md](../prd/epics/epic-2-table-layout-management.md)